<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LRA Venue Map v4</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0f;--surface:#14141f;--surface2:#1c1c2e;--border:#2a2a3d;--text:#e8e8f0;--dim:#8888a0;--accent:#ff6b35;--accent2:#00d4aa;--c1:#4ecdc4;--c2:#45b7d1;--c3:#f7dc6f;--c4:#ff9f43;--c5:#ff6b6b;--never:#ff3366;--ha:#999;--h1:#5cb85c;--h23:#f0c040;--h4:#e08030;--hc:#28a745;--hna:#d9534f;--hav:#5bc0de;--fest:#ffd700;--ser:#00e5ff;--outreach:#00d4aa;--st-conf:#00c853;--st-mgmt:#aa00ff;--st-offer:#00bcd4;--st-at:#ff9100}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
#app{display:flex;height:100vh}
#sidebar{width:370px;min-width:370px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:1000;transition:transform .3s,min-width .3s,width .3s}
#sidebar.collapsed{transform:translateX(-370px);min-width:0;width:0;overflow:hidden}
.sh{padding:12px 16px;border-bottom:1px solid var(--border);background:linear-gradient(135deg,var(--surface),var(--surface2));display:flex;justify-content:space-between;align-items:center}
.sh h1{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--accent);letter-spacing:2px;text-transform:uppercase}
.sh .sub{font-size:9px;color:var(--dim);margin-top:2px;font-family:'JetBrains Mono',monospace}
.sh-btns{display:flex;gap:4px}
.hbtn{background:var(--surface2);border:1px solid var(--border);color:var(--dim);padding:5px 8px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:9px;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:.5px}
.hbtn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.hbtn.refreshing{background:var(--accent2);color:#000;border-color:var(--accent2);pointer-events:none}
.fs{padding:6px 16px;border-bottom:1px solid var(--border)}
.fs label{font-family:'JetBrains Mono',monospace;font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--dim);display:block;margin-bottom:2px}
.fs input,.fs select{width:100%;padding:5px 9px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:12px;outline:none}
.fs input:focus,.fs select:focus{border-color:var(--accent)}.fs select option{background:var(--bg)}
.fr{display:flex;gap:5px}.fr>div{flex:1}
.cr{display:flex;align-items:center;gap:5px}.cr input{width:70px;text-align:center}.cr span{color:var(--dim);font-size:11px}
.chip{font-size:9px;padding:2px 6px;border-radius:4px;background:var(--surface2);border:1px solid var(--border);cursor:pointer;transition:all .15s;font-family:'JetBrains Mono',monospace;color:var(--dim);user-select:none;display:inline-block}
.chip.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.pt{font-size:9px;padding:4px 9px;border-radius:5px;background:var(--surface2);border:1px solid var(--border);cursor:pointer;transition:all .15s;font-family:'JetBrains Mono',monospace;color:var(--dim);user-select:none;text-transform:uppercase;letter-spacing:.5px}
.pt:hover{border-color:var(--dim)}
.mb{font-size:9px;padding:4px 9px;border-radius:5px;background:var(--surface2);border:1px solid var(--border);cursor:pointer;transition:all .15s;font-family:'JetBrains Mono',monospace;color:var(--dim);user-select:none;text-transform:uppercase;letter-spacing:.5px}
.mb:hover{border-color:var(--dim)}
.mb.ar{background:var(--accent);color:#fff;border-color:var(--accent)}
.mb.an{background:var(--never);color:#fff;border-color:var(--never)}
.mb.ax{background:#6c5ce7;color:#fff;border-color:#6c5ce7}
.mb.ah{background:var(--hc);color:#fff;border-color:var(--hc)}
.mb.ao{background:var(--outreach);color:#000;border-color:var(--outreach)}
.mb.as{background:var(--st-conf);color:#fff;border-color:var(--st-conf)}
#rp{display:none;padding:6px 16px;border-bottom:1px solid var(--border);max-height:180px;overflow-y:auto}
#rp.vis{display:block}
.rh{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.rh span{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:1px}
.rh button{font-size:9px;color:var(--never);cursor:pointer;font-family:'JetBrains Mono',monospace;background:none;border:none}
.rs{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:11px;border-bottom:1px solid var(--border)}
.rs .num{width:18px;height:18px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;flex-shrink:0}
.rs .vi{flex:1;min-width:0}.rs .vn{font-weight:600;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.rs .vd{font-size:9px;color:var(--dim)}
.rs .li{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent);text-align:right;flex-shrink:0}
.rs .rx{color:var(--dim);cursor:pointer;font-size:13px;flex-shrink:0;background:none;border:none;padding:1px}
.rs .rx:hover{color:var(--never)}
.rt{margin-top:4px;padding:5px 7px;background:var(--bg);border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:10px;display:flex;justify-content:space-between}
.rt .tl{color:var(--dim)}.rt .tv{color:var(--accent);font-weight:700}
#hp{display:none;padding:6px 16px;border-bottom:1px solid var(--border);max-height:150px;overflow-y:auto}
#hp.vis{display:block}
.hl{display:flex;flex-wrap:wrap;gap:3px;margin-top:4px;padding:4px 6px;background:var(--bg);border-radius:5px}
.hl span{display:flex;align-items:center;gap:2px;font-size:8px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.hl .hd{width:7px;height:7px;border-radius:50%;flex-shrink:0}
#rc{display:none;padding:5px 16px;border-bottom:1px solid var(--border)}
#rc.vis{display:flex;align-items:center;gap:6px}
#rc label{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);white-space:nowrap}
#rc input[type=range]{flex:1;accent-color:#6c5ce7}
#rc .rv{font-family:'JetBrains Mono',monospace;font-size:10px;color:#6c5ce7;min-width:45px}
/* Outreach Panel */
#op{display:none;padding:8px 16px;border-bottom:1px solid var(--border);max-height:300px;overflow-y:auto;background:rgba(0,212,170,.03)}
#op.vis{display:block}
#op label{font-family:'JetBrains Mono',monospace;font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--dim);display:block;margin:4px 0 2px}
#op input,#op select{width:100%;padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px;outline:none}
#op input:focus,#op select:focus{border-color:var(--outreach)}
.op-sel{max-height:100px;overflow-y:auto;margin:4px 0}
.op-item{display:flex;justify-content:space-between;align-items:center;padding:2px 5px;background:var(--bg);border-radius:3px;margin-bottom:2px;font-size:10px}
.op-item .ox{cursor:pointer;color:var(--dim);font-size:12px;border:none;background:none}
.op-item .ox:hover{color:var(--never)}
.op-save{width:100%;padding:6px;background:var(--outreach);color:#000;border:none;border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;cursor:pointer;margin-top:6px;letter-spacing:1px;text-transform:uppercase}
.op-save:hover{opacity:.85}
.op-save:disabled{opacity:.4;cursor:not-allowed}
/* Status Overlay Panel */
#sp{display:none;padding:8px 16px;border-bottom:1px solid var(--border);background:rgba(0,200,83,.03)}
#sp.vis{display:block}
#sp label{font-family:'JetBrains Mono',monospace;font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--dim);display:block;margin:3px 0 2px}
#sp select{width:100%;padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px;outline:none}
.st-checks{display:flex;flex-wrap:wrap;gap:4px;margin:4px 0}
.st-chk{display:flex;align-items:center;gap:3px;font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--dim);cursor:pointer;user-select:none}
.st-chk input{accent-color:var(--st-conf)}
.st-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
/* View Outreach Slide Panel */
#vop{position:fixed;top:0;right:0;width:380px;height:100vh;background:var(--surface);border-left:1px solid var(--border);z-index:2000;transform:translateX(100%);transition:transform .3s;overflow-y:auto;padding:16px}
#vop.vis{transform:translateX(0)}
#vop .vop-close{position:absolute;top:10px;right:12px;background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer}
#vop .vop-close:hover{color:var(--never)}
.vop-row{padding:6px 8px;background:var(--bg);border-radius:5px;margin-bottom:4px;font-size:10px}
.vop-row .vrn{font-weight:600;font-size:11px}.vop-row .vrs{font-family:'JetBrains Mono',monospace;font-size:9px;padding:1px 5px;border-radius:3px;display:inline-block;margin-top:2px}
.vop-row .vrm{font-size:9px;color:var(--dim);margin-top:2px}
.leg{padding:5px 16px;border-bottom:1px solid var(--border)}
.leg-t{font-family:'JetBrains Mono',monospace;font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--dim);margin-bottom:3px}
.leg-i{display:flex;flex-wrap:wrap;gap:2px}
.li-i{display:flex;align-items:center;gap:2px;font-size:9px;color:var(--dim);cursor:pointer;padding:1px 4px;border-radius:3px;transition:background .2s;user-select:none}
.li-i:hover{background:var(--surface2)}.li-i.off{opacity:.2}
.li-d{width:7px;height:7px;border-radius:50%}
#vl{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.vi-item{padding:6px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.vi-item:hover{background:var(--surface2)}.vi-item.in-r{background:rgba(255,107,53,.08);border-left:3px solid var(--accent)}
.vi-item.in-o{background:rgba(0,212,170,.08);border-left:3px solid var(--outreach)}
.vi-item .nm{font-weight:600;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.vi-item .mt{font-size:9px;color:var(--dim);margin-top:1px;display:flex;gap:5px;flex-wrap:wrap}
.vi-item .bd{padding:1px 5px;border-radius:3px;font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600}
.sb{padding:5px 16px;border-top:1px solid var(--border);font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);background:var(--surface);display:flex;justify-content:space-between;flex-shrink:0}
#mc{flex:1;position:relative}#map{width:100%;height:100%;background:var(--bg)}
.ts{position:absolute;top:10px;left:10px;z-index:1001;background:var(--surface);border:1px solid var(--border);color:var(--text);width:32px;height:32px;border-radius:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .2s}
.ts:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.gp{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);z-index:1001;background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:6px 14px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);display:none;align-items:center;gap:6px;box-shadow:0 4px 16px rgba(0,0,0,.5)}
.gp.on{display:flex}
.gb{width:100px;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.gb-f{height:100%;background:var(--accent);border-radius:2px;transition:width .3s;width:0%}
.rb{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1001;padding:5px 14px;border-radius:7px;font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:1px;display:none;box-shadow:0 4px 16px rgba(0,0,0,.3)}
.rb.on{display:block}
#r-banner{background:var(--accent);color:#fff}
#o-banner{background:var(--outreach);color:#000}
.cb{position:absolute;top:10px;right:10px;z-index:1001;background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:4px 10px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent2);display:none;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.cb.on{display:block}
.agent-badge{position:absolute;top:48px;left:10px;z-index:1001;background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:3px 10px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent2)}
/* Login overlay */
#login{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999}
#login.hid{display:none}
.lc{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:36px;max-width:420px;width:90%}
.lc h2{font-family:'JetBrains Mono',monospace;color:var(--accent);font-size:17px;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px}
.lc p{color:var(--dim);font-size:12px;margin-bottom:10px;line-height:1.5}
.lc select,.lc input{width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;outline:none;margin-bottom:10px}
.lc select:focus,.lc input:focus{border-color:var(--accent)}.lc select option{background:var(--bg)}
.lc button{width:100%;padding:10px;background:var(--accent);border:none;border-radius:7px;color:#fff;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;cursor:pointer;letter-spacing:1px;text-transform:uppercase}
.lc .err{color:#ff4444;font-size:11px;margin-top:6px;display:none}
#loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9998}
#loading.hid{display:none}
.loader{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loading .st{margin-top:14px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);text-align:center}
.leaflet-popup-content-wrapper{background:var(--surface)!important;border:1px solid var(--border)!important;border-radius:9px!important;color:var(--text)!important;box-shadow:0 8px 32px rgba(0,0,0,.5)!important}
.leaflet-popup-tip{background:var(--surface)!important}
.leaflet-popup-close-button{color:var(--dim)!important;font-size:18px!important}
.leaflet-popup-content{margin:10px!important;min-width:260px;max-width:400px}
.pn{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:var(--accent);margin-bottom:2px}
.pl{font-size:10px;color:var(--dim);margin-bottom:6px}
.pg{display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-bottom:6px}
.pf{background:var(--bg);padding:4px 6px;border-radius:4px}
.pf .lb{font-family:'JetBrains Mono',monospace;font-size:7px;text-transform:uppercase;letter-spacing:1px;color:var(--dim)}
.pf .vl{font-size:11px;font-weight:600;margin-top:1px}
.pf-f{grid-column:1/-1}
.pst{font-family:'JetBrains Mono',monospace;font-size:8px;text-transform:uppercase;letter-spacing:1px;color:var(--dim);margin:6px 0 3px;border-top:1px solid var(--border);padding-top:5px}
.pp{background:var(--bg);padding:3px 6px;border-radius:4px;margin-bottom:2px}
.pp .ppn{font-weight:600;font-size:11px}.pp .ppc{font-size:9px;color:var(--dim)}.pp .ppe{font-size:9px;color:var(--accent2)}
.pnotes{background:var(--bg);padding:4px 6px;border-radius:4px;font-size:9px;color:var(--dim);max-height:50px;overflow-y:auto;line-height:1.4;white-space:pre-wrap}
.plinks{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap}
.plink{color:var(--accent);font-size:9px;font-family:'JetBrains Mono',monospace;text-decoration:none}
.plink:hover{text-decoration:underline}
.popup-route-btn{background:var(--accent);color:#fff;border:none;padding:3px 9px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:9px;cursor:pointer;margin-top:5px}
.popup-outreach-btn{background:var(--outreach);color:#000;border:none;padding:3px 9px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:9px;cursor:pointer;margin-top:5px;font-weight:600}
.oa{width:100%;min-height:50px;max-height:100px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:10px;padding:5px 7px;resize:vertical;outline:none;margin-top:3px}
.oa:focus{border-color:var(--accent)}
.os{background:var(--accent2);color:#000;border:none;padding:3px 10px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;cursor:pointer;margin-top:3px}
.os:hover{opacity:.85}
.ostat{font-size:9px;margin-left:6px;font-family:'JetBrains Mono',monospace}
.vt{background:var(--surface)!important;border:1px solid var(--border)!important;color:var(--text)!important;border-radius:5px!important;padding:5px 8px!important;font-family:'DM Sans',sans-serif!important;font-size:10px!important;box-shadow:0 4px 12px rgba(0,0,0,.5)!important;white-space:nowrap}
.vt .ttn{font-weight:700;font-size:11px;color:var(--accent)}.vt .ttl{color:var(--dim);font-size:9px}
.vt .ttm{display:flex;gap:6px;margin-top:1px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--dim)}
.ft .ttn{color:var(--fest)!important}.st-t .ttn{color:var(--ser)!important}
.leaflet-control-zoom a{background:var(--surface)!important;color:var(--text)!important;border-color:var(--border)!important}
.leaflet-control-zoom a:hover{background:var(--surface2)!important}
.phr{display:flex;justify-content:space-between;align-items:center;padding:2px 6px;background:var(--bg);border-radius:3px;margin-bottom:2px;font-size:9px}
@keyframes hp{0%,100%{opacity:.6;transform:scale(1)}50%{opacity:1;transform:scale(1.1)}}
@keyframes pulse-outreach{0%,100%{box-shadow:0 0 0 0 rgba(0,212,170,.4)}70%{box-shadow:0 0 0 8px rgba(0,212,170,0)}}
</style>
</head>
<body>
<!-- LOGIN OVERLAY -->
<div id="login"><div class="lc">
<h2>üó∫Ô∏è LRA Map v4</h2>
<p>Venues ¬∑ Festivals ¬∑ Series ¬∑ Holds ¬∑ Outreach ¬∑ Status Overlay</p>
<label style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:1px">Agent</label>
<select id="login-agent"><option value="">Select your name...</option></select>
<label style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:1px">Login Code</label>
<input type="password" id="login-code" placeholder="Enter code..."/>
<button onclick="doLogin()">Enter Map</button>
<div class="err" id="login-error"></div>
</div></div>

<!-- LOADING -->
<div id="loading" class="hid"><div class="loader"></div><div class="st" id="load-status">Loading...</div></div>

<!-- MAIN APP -->
<div id="app" style="display:none">
<div id="sidebar">
<div class="sh"><div><h1>LRA Map</h1><div class="sub" id="counts">‚Äî</div></div><div class="sh-btns"><button class="hbtn" id="refresh-btn" onclick="forceRefresh()">üîÑ Refresh</button><button class="hbtn" onclick="exportCSV()">‚¨á CSV</button></div></div>
<div class="fs"><label>Search</label><input type="text" id="search" placeholder="Name, city, promoter..." oninput="applyFilters()"/></div>
<div class="fs"><div class="fr"><div><label>Fest Month</label><select id="f-month" onchange="applyFilters()"><option value="">All</option><option>01 January</option><option>02 February</option><option>03 March</option><option>04 April</option><option>05 May</option><option>06 June</option><option>07 July</option><option>08 August</option><option>09 September</option><option>10 October</option><option>11 November</option><option>12 December</option></select></div><div><label>Series Mo</label><select id="f-smonth" onchange="applyFilters()"><option value="">All</option><option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option></select></div></div></div>
<div class="fs"><label>Capacity</label><div class="cr"><input type="number" id="cap-min" placeholder="0" oninput="applyFilters()"/><span>to</span><input type="number" id="cap-max" placeholder="Any" oninput="applyFilters()"/></div></div>
<div class="fs"><label>Pin Types</label><div style="display:flex;gap:3px;flex-wrap:wrap;margin-top:2px">
<div class="pt on" id="pt-v" onclick="togPT('venues')" style="border-color:var(--accent);background:var(--accent);color:#fff">üé§ Venues</div>
<div class="pt on" id="pt-f" onclick="togPT('festivals')" style="border-color:var(--fest);background:var(--fest);color:#000">‚≠ê Festivals</div>
<div class="pt on" id="pt-s" onclick="togPT('series')" style="border-color:var(--ser);background:var(--ser);color:#000">üí† Series</div>
</div></div>
<div class="fs"><label>Artist History</label><div id="af" style="display:flex;flex-wrap:wrap;gap:2px;margin-top:2px"></div></div>
<div class="fs"><label>Tools</label><div style="display:flex;gap:3px;flex-wrap:wrap">
<div class="mb" id="btn-rt" onclick="togRoute()">üõ£Ô∏è Route</div>
<div class="mb" id="btn-nv" onclick="togNever()">üÜï Never</div>
<div class="mb" id="btn-rd" onclick="togRadius()">üì° Radius</div>
<div class="mb" id="btn-hd" onclick="togHolds()">üìã Holds</div>
<div class="mb" id="btn-or" onclick="togOutreach()">üì¨ Outreach</div>
<div class="mb" id="btn-st" onclick="togStatus()">üìä Status</div>
</div></div>

<!-- RADIUS CONTROL -->
<div id="rc"><label>Radius:</label><input type="range" id="r-slider" min="10" max="200" value="90" oninput="updRL()"/><div class="rv" id="r-val">90mi</div></div>

<!-- ROUTE PANEL -->
<div id="rp"><div class="rh"><span>Route Stops</span><button onclick="clearRoute()">‚úï Clear</button></div><div id="r-stops"></div><div class="rt" id="r-totals" style="display:none"><div><span class="tl">Total: </span><span class="tv" id="r-dist">‚Äî</span></div><div><span class="tl">Drive: </span><span class="tv" id="r-time">‚Äî</span></div></div></div>

<!-- HOLDS PANEL -->
<div id="hp"><div class="rh"><span>Hold Status</span></div><div id="h-sum" style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);line-height:1.7">Select artist chips to see stats</div>
<div class="hl"><span><div class="hd" style="background:var(--ha)"></div>Asked</span><span><div class="hd" style="background:var(--h1)"></div>1st</span><span><div class="hd" style="background:var(--h23)"></div>2-3</span><span><div class="hd" style="background:var(--h4)"></div>4+</span><span><div class="hd" style="background:var(--hc)"></div>Conf</span><span><div class="hd" style="background:var(--hna)"></div>NA</span></div></div>

<!-- OUTREACH PANEL -->
<div id="op">
<div class="rh"><span>üì¨ Outreach Campaign</span><span id="o-count" style="color:var(--outreach)">0 selected</span></div>
<label>Campaigns <span style="color:var(--dim);font-size:8px">(multi-select)</span></label>
<div id="o-campaigns" style="max-height:100px;overflow-y:auto;border:1px solid var(--border);border-radius:4px;padding:4px;margin-bottom:4px">
<label style="display:flex;align-items:center;gap:4px;font-size:9px;padding:2px 0;cursor:pointer"><input type="checkbox" value="WF Fall 2026 Tour"> WF Fall 2026 Tour</label>
<label style="display:flex;align-items:center;gap:4px;font-size:9px;padding:2px 0;cursor:pointer"><input type="checkbox" value="WF Spring 2026 Tour"> WF Spring 2026 Tour</label>
<label style="display:flex;align-items:center;gap:4px;font-size:9px;padding:2px 0;cursor:pointer"><input type="checkbox" value="TBT Fall 2026 Tour"> TBT Fall 2026 Tour</label>
<label style="display:flex;align-items:center;gap:4px;font-size:9px;padding:2px 0;cursor:pointer"><input type="checkbox" value="TBT Spring 2026 Tour"> TBT Spring 2026 Tour</label>
<label style="display:flex;align-items:center;gap:4px;font-size:9px;padding:2px 0;cursor:pointer"><input type="checkbox" value="HS Fall 2026 Tour"> HS Fall 2026 Tour</label>
<label style="display:flex;align-items:center;gap:4px;font-size:9px;padding:2px 0;cursor:pointer"><input type="checkbox" value="HS Spring 2026 Tour"> HS Spring 2026 Tour</label>
<label style="display:flex;align-items:center;gap:4px;font-size:9px;padding:2px 0;cursor:pointer"><input type="checkbox" value="JSS Fall 2026 Tour"> JSS Fall 2026 Tour</label>
<label style="display:flex;align-items:center;gap:4px;font-size:9px;padding:2px 0;cursor:pointer"><input type="checkbox" value="Festival Outreach 2026"> Festival Outreach 2026</label>
<label style="display:flex;align-items:center;gap:4px;font-size:9px;padding:2px 0;cursor:pointer"><input type="checkbox" value="Series Outreach 2026"> Series Outreach 2026</label>
</div>
<input type="text" id="o-campaign-custom" placeholder="Or type new campaign name..." style="font-size:9px;margin-bottom:6px"/>
<label>Artist</label>
<select id="o-artist" onchange="onOutreachArtistChange()"><option value="">Select artist...</option></select>
<label>Outreach Type</label>
<select id="o-type"><option>Venue Hold</option><option>Festival Pitch</option><option>Series Pitch</option></select>
<label>Priority</label>
<select id="o-priority"><option>High</option><option>Medium</option><option>Low</option></select>
<label>Selected Venues</label>
<div class="op-sel" id="o-list"></div>
<button class="op-save" id="o-save-btn" onclick="saveOutreach()" disabled>Save to Airtable</button>
<div id="o-save-status" style="font-family:'JetBrains Mono',monospace;font-size:9px;margin-top:4px;text-align:center"></div>
</div>

<!-- STATUS OVERLAY PANEL -->
<div id="sp">
<div class="rh"><span>üìä Artist Status Overlay</span></div>
<label>Artist</label>
<select id="s-artist" onchange="loadStatusOverlay()"><option value="">Select artist...</option></select>
<label>Show Statuses</label>
<div class="st-checks">
<label class="st-chk"><input type="checkbox" value="CONFIRMED" onchange="loadStatusOverlay()" checked/><div class="st-dot" style="background:var(--st-conf)"></div>Confirmed</label>
<label class="st-chk"><input type="checkbox" value="Confirmed By Management / Tour Date Cleared" onchange="loadStatusOverlay()"/><div class="st-dot" style="background:var(--st-mgmt)"></div>Mgmt Conf</label>
<label class="st-chk"><input type="checkbox" value="Offer" onchange="loadStatusOverlay()" checked/><div class="st-dot" style="background:var(--st-offer)"></div>Offer</label>
<label class="st-chk"><input type="checkbox" value="At Management" onchange="loadStatusOverlay()"/><div class="st-dot" style="background:var(--st-at)"></div>At Mgmt</label>
</div>
<div id="s-info" style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);margin-top:4px"></div>
</div>

<!-- CAPACITY LEGEND -->
<div class="leg"><div class="leg-t">Venue Capacity</div><div class="leg-i">
<div class="li-i"><div class="li-d" style="background:var(--c1)"></div>0-300</div>
<div class="li-i"><div class="li-d" style="background:var(--c2)"></div>301-500</div>
<div class="li-i"><div class="li-d" style="background:var(--c3)"></div>501-750</div>
<div class="li-i"><div class="li-d" style="background:var(--c4)"></div>751-1500</div>
<div class="li-i"><div class="li-d" style="background:var(--c5)"></div>1500+</div>
</div></div>

<!-- VENUE LIST -->
<div id="vl"></div>
<div class="sb"><span id="s-count">‚Äî</span><span id="m-count">‚Äî</span></div>
</div>

<!-- MAP CONTAINER -->
<div id="mc">
<button class="ts" onclick="document.getElementById('sidebar').classList.toggle('collapsed')">‚ò∞</button>
<div class="rb" id="r-banner">ROUTE MODE ‚Äî Click pins to add stops</div>
<div class="rb" id="o-banner" style="background:var(--outreach);color:#000">OUTREACH MODE ‚Äî Click venues to select for campaign</div>
<div class="cb" id="c-badge">üîÑ Updating...</div>
<div class="agent-badge" id="agent-badge" style="display:none"></div>
<div id="map"></div>
<div class="gp" id="gp"><span id="g-text">Geocoding...</span><div class="gb"><div class="gb-f" id="g-fill"></div></div></div>
</div>
</div>

<!-- VIEW OUTREACH SLIDE PANEL -->
<div id="vop">
<button class="vop-close" onclick="closeVOP()">‚úï</button>
<h3 style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--outreach);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">üì¨ Outreach History</h3>
<div id="vop-content"></div>
</div>
<script>
// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ
const PAT='patPmozIwb4wwsnEc.9da045c85ac9055cf96c86d5deb92799f3d8f6cb561226db7a9ddc956eb4c42e';
const B='appBeWOdb4dIuNKUW',VT='tblFVQsrpgffr7FH4',FT='tblLda0Y2tcYeNDIP',ST='tblP7nDIXRRLUfJV0';
const TEAM_T='tbl6WAEC2bE1RZxgJ',OUTREACH_T='tblJh8lbaHAIAq0kv',OC_T='tblVSk34SJps918oF';
const SH_ID='1Rk-crpUpZGCeisBrpyah5VWUkoCPal4NmNt08JeijpQ';
const H_TABS=['Weakened Friends','The Ballroom Thieves','Highly Suspect','Johnny Stevens Shows','Hannah Mohan','Lyle Brewer','Liv Greene'];
const AK=['WF','TBT'];
const OF={festivals:'fldx9Tb6fF3WoZLhc',series:'fldpOYnA9eW0CSUZa'};
const ST_COLORS={'CONFIRMED':'#00c853','Confirmed By Management / Tour Date Cleared':'#aa00ff','Offer':'#00bcd4','At Management':'#ff9100'};

const V_FIELDS=['Venue Name','Venue City','Venue ST','Region','CAP','Ages','Latitude','Longitude ','Venue Location',
  '[D] Promoter (from Airtable Promoter)','Company Name  (Linked from [D] Promoter (from Airtable Promoter))',
  'Promoter Email (Linked from [D] Promoter (from Airtable Promoter))',
  'Promoter Name (from [D] Promoter (from Airtable Promoter))',
  'Website','LRA V/F Thoughts','Radius (Typical)','Notes on Venue','WF','TBT','Genre','Notable Artists Played Here'];

const F_FIELDS=['Festival','City','ST','Type','Month - AI','Primary Genres - AI',
  '[D] Promoter','Promoter Email (from Promoters Teams)','Promoter Name (from Promoters Teams)',
  'AI - Promoter Email','AI - Promoter Name','[D] Company Name',
  'Website [F] - AI','Outreach Info','Venue Location','Latitude','Longitude','WF',
  '[F] Attendance','Closed','Days of 2026 Festival','2026 Festival Pitched',
  '[F] Typically Starts Booking','LRA V/F Thoughts','[F] Booking Status',
  'Line Up Names - AI - Previous Year'];

const S_FIELDS=['Name','City','ST','Day of Week','Genres','Previous Artists',
  '[D] Promoter','AI Promoter Email','AI Promoter Name','[D] Company Name',
  'Website','Outreach Info','Venue Location','Latitude','Longitude','CAP TOTAL Cap','Closed',
  '[F] [S] Fee Range','Months','Region','[F] Typically Starts Booking',
  'LRA V/F Thoughts','[F] Primary Genres','Expected Day of Week',
  'Expected 2026 Start','Expected 2026 End','Previous Year Day Of Week','Info on Series'];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let map,all=[],filt=[],mkrs={},rLayer=null,rCircle=null;
let rtMode=false,nvMode=false,rdMode=false,hdMode=false,orMode=false,stMode=false;
let rStops=[],rLegs=[];
let pts={venues:true,festivals:true,series:true};
let aArts=new Set();
let hData={};
let agentRec=null,teamRecs=[];
let oSelected=new Set(); // outreach selected item IDs
let outreachCache={}; // artist -> outreach records
let outreachedIds=new Set(); // venue/fest/series IDs already outreached for current outreach artist
let pastPlays={}; // venue/fest/series record ID -> [{artist,date,guarantee,billing,dealTerms,payout,status}]
let statusLayer=null,statusCircles=[]; // status overlay layer
const CACHE_KEY='lra_map_cache_v4',CACHE_TTL=3600000;

function capCol(c){if(!c||c<=300)return'#4ecdc4';if(c<=500)return'#45b7d1';if(c<=750)return'#f7dc6f';if(c<=1500)return'#ff9f43';return'#ff6b6b'}

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
async function initLogin(){
  try{
    const recs=await fetchAll(TEAM_T,['Name','Email','Role','Login Code','MS365 Draft Folder','Active']);
    teamRecs=recs.filter(r=>r.fields.Active);
    const sel=document.getElementById('login-agent');
    teamRecs.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.textContent=r.fields.Name+' ('+r.fields.Role+')';sel.appendChild(o)});
  }catch(e){document.getElementById('login-error').textContent='Failed to load team: '+e.message;document.getElementById('login-error').style.display='block'}
}
function doLogin(){
  const agentId=document.getElementById('login-agent').value;
  const code=document.getElementById('login-code').value.trim();
  const err=document.getElementById('login-error');
  if(!agentId){err.textContent='Select your name';err.style.display='block';return}
  const rec=teamRecs.find(r=>r.id===agentId);
  if(!rec||rec.fields['Login Code']!==code){err.textContent='Invalid code';err.style.display='block';return}
  agentRec=rec;
  document.getElementById('login').classList.add('hid');
  document.getElementById('agent-badge').textContent='üë§ '+rec.fields.Name;
  document.getElementById('agent-badge').style.display='block';
  initApp();
}
window.onload=()=>{initLogin()};

// ‚îÄ‚îÄ APP INIT ‚îÄ‚îÄ
function initApp(){
  const cached=loadCache();
  if(cached){
    all=cached;showApp();
    setTimeout(()=>bgRefresh(),100);
    loadHolds();
  } else {
    document.getElementById('loading').classList.remove('hid');
    loadFresh();
  }
}

function loadCache(){try{const r=localStorage.getItem(CACHE_KEY);if(!r)return null;const c=JSON.parse(r);if(Date.now()-c.ts>CACHE_TTL)return null;return c.data}catch(e){return null}}
function saveCache(data){try{localStorage.setItem(CACHE_KEY,JSON.stringify({ts:Date.now(),data}))}catch(e){}}

async function loadFresh(){
  try{
    setSt('Loading venues + festivals + series...');
    const [venues,festivals,series]=await Promise.all([fetchAll(VT,V_FIELDS),fetchAll(FT,F_FIELDS),fetchAll(ST,S_FIELDS)]);
    setSt(venues.length+'v + '+festivals.length+'f + '+series.length+'s loaded');
    all=[];procVenues(venues);procFests(festivals);procSeries(series);
    saveCache(all);
    await Promise.all([loadHolds(),loadPastPlays()]);
    showApp();
    document.getElementById('loading').classList.add('hid');
    setTimeout(()=>geocodeMissing(),500);
  }catch(e){setSt('Error: '+e.message);console.error(e)}
}

async function bgRefresh(){
  const badge=document.getElementById('c-badge');badge.classList.add('on');
  try{
    const [v,f,s]=await Promise.all([fetchAll(VT,V_FIELDS),fetchAll(FT,F_FIELDS),fetchAll(ST,S_FIELDS)]);
    all=[];procVenues(v);procFests(f);procSeries(s);
    saveCache(all);applyFilters();
    setTimeout(()=>geocodeMissing(),500);
  }catch(e){console.warn('bg refresh fail',e)}
  badge.classList.remove('on');
}

async function forceRefresh(){
  const btn=document.getElementById('refresh-btn');btn.classList.add('refreshing');btn.textContent='‚è≥ Loading...';
  try{
    localStorage.removeItem(CACHE_KEY);
    const [v,f,s]=await Promise.all([fetchAll(VT,V_FIELDS),fetchAll(FT,F_FIELDS),fetchAll(ST,S_FIELDS)]);
    all=[];procVenues(v);procFests(f);procSeries(s);
    saveCache(all);await Promise.all([loadHolds(),loadPastPlays()]);applyFilters();
    setTimeout(()=>geocodeMissing(),500);
  }catch(e){console.error(e)}
  btn.classList.remove('refreshing');btn.textContent='üîÑ Refresh';
}

function showApp(){
  document.getElementById('app').style.display='flex';
  if(!map)buildMap();buildAF();populateArtistDropdowns();applyFilters();
}

function setSt(s){document.getElementById('load-status').textContent=s}

async function fetchAll(tid,fields){
  let all=[],offset=null;
  const fp=fields?fields.map(f=>'fields[]='+encodeURIComponent(f)).join('&'):'';
  do{
    let url='https://api.airtable.com/v0/'+B+'/'+tid+'?pageSize=100'+(fp?'&'+fp:'');
    if(offset)url+='&offset='+offset;
    const r=await fetch(url,{headers:{Authorization:'Bearer '+PAT}});
    if(!r.ok){const txt=await r.text();console.error('AT error',r.status,txt);throw new Error('AT '+r.status+': '+txt.substring(0,200))}
    const d=await r.json();all=all.concat(d.records);offset=d.offset;
  }while(offset);
  return all;
}

async function fetchFiltered(tid,formula,fields){
  let all=[],offset=null;
  const fp=fields?fields.map(f=>'fields[]='+encodeURIComponent(f)).join('&'):'';
  do{
    let url='https://api.airtable.com/v0/'+B+'/'+tid+'?pageSize=100&filterByFormula='+encodeURIComponent(formula)+(fp?'&'+fp:'');
    if(offset)url+='&offset='+offset;
    const r=await fetch(url,{headers:{Authorization:'Bearer '+PAT}});
    if(!r.ok)throw new Error('AT '+r.status);
    const d=await r.json();all=all.concat(d.records);offset=d.offset;
  }while(offset);
  return all;
}

// ‚îÄ‚îÄ PROCESS: VENUES ‚îÄ‚îÄ
function procVenues(recs){
  recs.forEach(r=>{
    const f=r.fields;
    const lat=f['Latitude']!=null?+f['Latitude']:null;
    const lng=f['Longitude ']!=null?+f['Longitude ']:null;
    all.push({
      id:r.id,type:'venue',
      name:f['Venue Name']||'',city:f['Venue City']||'',state:f['Venue ST']||'',region:f['Region']||'',
      cap:parseInt(f['CAP'])||0,ages:f['Ages']||'',lat:lat,lng:lng,
      promoter:arrFirst(f['[D] Promoter (from Airtable Promoter)']),
      company:arrFirst(f['Company Name  (Linked from [D] Promoter (from Airtable Promoter))']),
      pEmail:arrFirst(f['Promoter Email (Linked from [D] Promoter (from Airtable Promoter))']),
      pName:arrFirst(f['Promoter Name (from [D] Promoter (from Airtable Promoter))']),
      website:f['Website']||'',thoughts:f['LRA V/F Thoughts']||'',radius:f['Radius (Typical)']||'',
      notes:f['Notes on Venue']||'',vLoc:f['Venue Location']||'',
      genre:f['Genre']||'',notable:f['Notable Artists Played Here']||'',
      WF:!!f['WF'],TBT:!!f['TBT']
    });
  });
}
function arrFirst(v){if(Array.isArray(v))return v[0]||'';return v||''}

// ‚îÄ‚îÄ PROCESS: FESTIVALS ‚îÄ‚îÄ
function procFests(recs){
  recs.forEach(r=>{
    const f=r.fields;if(f['Closed']==='Closed')return;
    const lat=f['Latitude']!=null?+f['Latitude']:null;
    const lng=f['Longitude']!=null?+f['Longitude']:null;
    all.push({
      id:r.id,type:'festival',
      name:f['Festival']||'',city:f['City']||'',state:f['ST']||'',region:'',
      lat:lat,lng:lng,cap:parseInt(f['[F] Attendance'])||0,
      promoter:f['[D] Promoter']||'',
      pEmail:arrFirst(f['Promoter Email (from Promoters Teams)'])||f['AI - Promoter Email']||'',
      pName:arrFirst(f['Promoter Name (from Promoters Teams)'])||f['AI - Promoter Name']||'',
      company:f['[D] Company Name']||'',website:f['Website [F] - AI']||'',festType:f['Type']||'',
      month:f['Month - AI']||'',genres:f['Primary Genres - AI']||'',
      dates2026:f['Days of 2026 Festival']||'',pitched2026:f['2026 Festival Pitched']||'',
      bookStatus:f['[F] Booking Status']||'',bookStart:f['[F] Typically Starts Booking']||'',
      thoughts:f['LRA V/F Thoughts']||'',outreach:f['Outreach Info']||'',
      vLoc:f['Venue Location']||'',WF:!!f['WF'],lineup:f['Line Up Names - AI - Previous Year']||''
    });
  });
}

// ‚îÄ‚îÄ PROCESS: SERIES ‚îÄ‚îÄ
function procSeries(recs){
  recs.forEach(r=>{
    const f=r.fields;if(f['Closed'])return;
    const lat=f['Latitude']!=null?+f['Latitude']:null;
    const lng=f['Longitude']!=null?+f['Longitude']:null;
    all.push({
      id:r.id,type:'series',
      name:f['Name']||'',city:f['City']||'',state:f['ST']||'',region:f['Region']||'',
      lat:lat,lng:lng,cap:parseInt(f['CAP TOTAL Cap'])||0,
      promoter:f['[D] Promoter']||'',company:f['[D] Company Name']||'',
      pEmail:f['AI Promoter Email']||'',pName:f['AI Promoter Name']||'',
      website:f['Website']||'',genres:f['Genres']||f['[F] Primary Genres']||'',
      prevArtists:f['Previous Artists']||'',
      dayOfWeek:f['Day of Week']||f['Expected Day of Week']||'',
      prevDOW:f['Previous Year Day Of Week']||'',months:f['Months']||'',
      expStart:f['Expected 2026 Start']||'',expEnd:f['Expected 2026 End']||'',
      feeRange:f['[F] [S] Fee Range']||'',bookStart:f['[F] Typically Starts Booking']||'',
      thoughts:f['LRA V/F Thoughts']||'',outreach:f['Outreach Info']||'',
      vLoc:f['Venue Location']||'',seriesInfo:f['Info on Series']||''
    });
  });
}

// ‚îÄ‚îÄ HOLDS ‚îÄ‚îÄ
async function loadHolds(){
  hData={};
  const promises=H_TABS.map(async tab=>{
    try{
      const url='https://docs.google.com/spreadsheets/d/'+SH_ID+'/gviz/tq?tqx=out:csv&sheet='+encodeURIComponent(tab);
      const r=await fetch(url);if(!r.ok)return;
      const rows=parseCSV(await r.text());if(rows.length<9)return;
      const vRow=rows[4]||[];
      for(let c=1;c<vRow.length;c++){
        const vn=(vRow[c]||'').trim();if(!vn)continue;
        const holds=[];
        for(let ri=8;ri<rows.length;ri++){
          const dt=(rows[ri]||[])[0]||'',st=((rows[ri]||[])[c]||'').trim();
          if(dt&&st)holds.push({date:dt,status:st});
        }
        if(holds.length){if(!hData[tab])hData[tab]={};hData[tab][vn.toLowerCase()]={vn,holds,best:calcBest(holds)}}
      }
    }catch(e){console.warn('holds',tab,e)}
  });
  await Promise.all(promises);
}

function calcBest(hs){
  let b='asked',bn=999;
  for(const h of hs){
    const s=h.status.toLowerCase().trim();
    if(s.includes('confirmed')||s==='conf')return{s:'confirmed',n:0};
    const m=s.match(/^(\d+)/);
    if(m){const n=+m[1];if(n<bn){bn=n;b=n<=1?'1h':n<=3?'23h':'4h'}}
    else if(s.includes('na')||s.includes('released')){if(b==='asked')b='na'}
    else if(s.includes('avail')){if(b==='asked')b='avail'}
  }
  return{s:b,n:bn};
}
function hCol(s){return{asked:'#999','1h':'#5cb85c','23h':'#f0c040','4h':'#e08030',confirmed:'#28a745',na:'#d9534f',avail:'#5bc0de'}[s]||'#999'}

// ‚îÄ‚îÄ PAST PLAYS ‚îÄ‚îÄ
async function loadPastPlays(){
  pastPlays={};
  try{
    const PP_FIELDS=['Artist','Date','Status','Guarantee','Total Payout','Billing','Deal Terms',
      'Venues','Festival','Series','Venue City','Venue ST','Promoter','Promoter Email','Promoter Company',
      'Adv Price 1','Scale 1 Cap','Sellable','Tickets Sold','% SOLD','Radius Clause'];
    const recs=await fetchAllView(OC_T,PP_FIELDS,'viw8m9f9USsVzqBtv');
    recs.forEach(r=>{
      const f=r.fields;
      const play={
        artist:f['Artist']||'',
        date:f['Date']||'',
        status:f['Status']||'',
        guarantee:f['Guarantee']||0,
        payout:f['Total Payout']||0,
        billing:f['Billing']||'',
        dealTerms:f['Deal Terms']||'',
        city:f['Venue City']||'',
        state:f['Venue ST']||'',
        promoter:f['Promoter']||'',
        pEmail:f['Promoter Email']||'',
        pCompany:f['Promoter Company']||'',
        advPrice:f['Adv Price 1']||0,
        cap:f['Scale 1 Cap']||0,
        sellable:f['Sellable']||0,
        sold:f['Tickets Sold']||0,
        pctSold:f['% SOLD'],
        radius:f['Radius Clause']||''
      };
      // Map to linked venue/festival/series IDs
      const venueIds=f['Venues']||[];
      const festIds=f['Festival']||[];
      const seriesIds=f['Series']||[];
      [...venueIds,...festIds,...seriesIds].forEach(id=>{
        if(!pastPlays[id])pastPlays[id]=[];
        pastPlays[id].push(play);
      });
    });
    // Sort each venue's plays by date desc
    Object.values(pastPlays).forEach(arr=>arr.sort((a,b)=>(b.date||'').localeCompare(a.date||'')));
    console.log('Past plays loaded:',recs.length,'records across',Object.keys(pastPlays).length,'venues/fests/series');
  }catch(e){console.warn('past plays load fail',e)}
}

// Fetch with view filter
async function fetchAllView(tid,fields,viewId){
  let all=[],offset=null;
  do{
    let url='https://api.airtable.com/v0/'+B+'/'+tid+'?pageSize=100&view='+viewId;
    fields.forEach(f=>url+='&fields[]='+encodeURIComponent(f));
    if(offset)url+='&offset='+offset;
    const r=await fetch(url,{headers:{Authorization:'Bearer '+PAT}});
    if(!r.ok)throw new Error('Airtable '+r.status);
    const d=await r.json();all.push(...(d.records||[]));offset=d.offset;
  }while(offset);
  return all;
}

function parseCSV(t){
  const rows=[];let row=[],cell='',inQ=false;
  for(let i=0;i<t.length;i++){
    const c=t[i],n=t[i+1];
    if(inQ){if(c==='"'&&n==='"'){cell+='"';i++}else if(c==='"')inQ=false;else cell+=c}
    else{if(c==='"')inQ=true;else if(c===','){row.push(cell);cell=''}else if(c==='\n'){row.push(cell);rows.push(row);row=[];cell=''}else if(c!=='\r')cell+=c}
  }
  if(cell||row.length)row.push(cell);if(row.length)rows.push(row);return rows;
}

function parseCoords(s){
  if(!s)return null;
  const m=String(s).match(/([-\d.]+)\s*,\s*([-\d.]+)/);
  if(m){const a=+m[1],b=+m[2];if(a>=-90&&a<=90&&b>=-180&&b<=180)return[a,b]}
  return null;
}

// ‚îÄ‚îÄ MAP ‚îÄ‚îÄ
function buildMap(){
  map=L.map('map',{center:[39.5,-98.35],zoom:4,zoomControl:true,preferCanvas:true});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'¬©CartoDB',maxZoom:19}).addTo(map);
}

function buildAF(){
  const c=document.getElementById('af');c.innerHTML='';
  AK.forEach(k=>{
    const d=document.createElement('div');d.className='chip';d.textContent=k;d.dataset.k=k;
    d.onclick=()=>{
      if(aArts.has(k)){aArts.delete(k);d.classList.remove('on')}else{aArts.add(k);d.classList.add('on')}
      if(hdMode)updHP();applyFilters();
    };
    c.appendChild(d);
  });
}

function populateArtistDropdowns(){
  // Populate outreach + status artist dropdowns from known artist names
  const artists=['Weakened Friends','The Ballroom Thieves','Highly Suspect','Johnny Stevens Shows','Hannah Mohan','Lyle Brewer','Liv Greene','Slothrust'];
  [document.getElementById('o-artist'),document.getElementById('s-artist')].forEach(sel=>{
    artists.forEach(a=>{const o=document.createElement('option');o.value=a;o.textContent=a;sel.appendChild(o)});
  });
}

// ‚îÄ‚îÄ MARKERS ‚îÄ‚îÄ
function mkIcon(item,hc){
  const isR=rStops.includes(item);
  const isO=oSelected.has(item.id);
  const isOR=orMode&&outreachedIds.has(item.id); // already outreached
  const hasPP=pastPlays[item.id]&&pastPlays[item.id].length>0; // has past plays
  let sz=item.type==='venue'?10:12,col=iCol(item);
  if(nvMode&&item.type==='venue'){if(AK.some(k=>item[k])){col='#333';sz=6}else{col='#ff3366';sz=12}}
  let ring='';
  if(isO)ring='<div style="position:absolute;inset:-5px;border-radius:50%;border:3px solid var(--outreach);animation:pulse-outreach 1.5s ease-in-out infinite;pointer-events:none"></div>';
  else if(isOR)ring='<div style="position:absolute;inset:-4px;border-radius:50%;border:2px solid #ff5252;pointer-events:none"></div>';
  else if(hc)ring='<div style="position:absolute;inset:-4px;border-radius:50%;border:3px solid '+hc+';animation:hp 2s ease-in-out infinite;pointer-events:none"></div>';
  // Badge for already-outreached
  let badge='';
  if(isOR)badge='<div style="position:absolute;top:-6px;right:-6px;width:10px;height:10px;border-radius:50%;background:#ff5252;border:1.5px solid var(--bg);font-size:6px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;pointer-events:none">‚úì</div>';
  // Small dot for past plays
  else if(hasPP)badge='<div style="position:absolute;top:-4px;right:-4px;width:7px;height:7px;border-radius:50%;background:var(--accent2);border:1px solid var(--bg);pointer-events:none"></div>';
  let inner;
  if(item.type==='festival')inner='<div style="width:'+sz+'px;height:'+sz+'px;background:'+col+';clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%)"></div>';
  else if(item.type==='series')inner='<div style="width:'+sz+'px;height:'+sz+'px;background:'+col+';clip-path:polygon(50% 0%,100% 50%,50% 100%,0% 50%)"></div>';
  else inner='<div style="width:'+sz+'px;height:'+sz+'px;border-radius:50%;background:'+col+';border:'+(isR?'2px solid var(--accent)':'1.5px solid rgba(0,0,0,.5)')+'"></div>';
  const ts=(isO||isOR||hc)?sz+10:sz;
  return L.divIcon({html:'<div style="position:relative;display:flex;align-items:center;justify-content:center;width:'+ts+'px;height:'+ts+'px">'+ring+inner+badge+'</div>',iconSize:[ts,ts],iconAnchor:[ts/2,ts/2],className:''});
}
function iCol(i){return i.type==='festival'?'#ffd700':i.type==='series'?'#00e5ff':capCol(i.cap)}

function getHC(item){
  const nm=item.name.toLowerCase().trim();let bs=null,bn=999;
  for(const a of aArts){
    const idx=AK.indexOf(a);if(idx===-1)continue;
    const tab=H_TABS[idx];if(!tab||!hData[tab])continue;
    let hd=hData[tab][nm];
    if(!hd){for(const[k,v] of Object.entries(hData[tab])){if(nm.includes(k)||k.includes(nm)){hd=v;break}}}
    if(hd?.best?.n<bn){bn=hd.best.n;bs=hd.best.s}
  }
  return bs?hCol(bs):null;
}

function renderMkrs(){
  Object.values(mkrs).forEach(m=>map.removeLayer(m));mkrs={};
  filt.forEach(item=>{
    if(!item.lat||!item.lng)return;
    if(item.type==='venue'&&!pts.venues)return;
    if(item.type==='festival'&&!pts.festivals)return;
    if(item.type==='series'&&!pts.series)return;
    let hc=null;if(hdMode&&aArts.size>0)hc=getHC(item);
    const icon=mkIcon(item,hc);
    const m=L.marker([item.lat,item.lng],{icon});
    const tc=item.type==='festival'?'vt ft':item.type==='series'?'vt st-t':'vt';
    let tt='<div class="ttn">'+(item.type==='festival'?'‚≠ê ':item.type==='series'?'üí† ':'')+E(item.name)+'</div><div class="ttl">'+E(item.city)+(item.state?', '+E(item.state):'')+'</div>';
    let meta=[];
    if(item.cap)meta.push('Cap:'+item.cap.toLocaleString());
    if(item.type==='festival'&&item.festType)meta.push(item.festType);
    if(item.type==='series'&&item.feeRange)meta.push(item.feeRange);
    if(meta.length)tt+='<div class="ttm">'+meta.join(' ¬∑ ')+'</div>';
    m.bindTooltip(tt,{className:tc,direction:'top',offset:[0,-8],opacity:1});
    m.on('click',()=>{
      if(orMode){toggleOutreachSelect(item);return}
      if(rtMode){addRS(item);return}
      if(rdMode){showRad(item);return}
      m.unbindPopup();m.bindPopup(popHTML(item),{maxWidth:400,maxHeight:480}).openPopup();
    });
    m.addTo(map);mkrs[item.id]=m;
  });
}

// ‚îÄ‚îÄ POPUPS ‚îÄ‚îÄ
function popHTML(i){if(i.type==='venue')return vPop(i);if(i.type==='festival')return fPop(i);return sPop(i)}

function vPop(i){
  let h='<div class="pn">üé§ '+E(i.name)+'</div><div class="pl">'+E(i.city)+(i.state?', '+E(i.state):'')+'</div><div class="pg">';
  if(i.cap)h+=pf('Capacity',i.cap.toLocaleString());
  if(i.ages)h+=pf('Ages',i.ages);
  if(i.radius)h+=pf('Radius',i.radius);
  if(i.genre)h+=pff('Genre',i.genre);
  h+='</div>';
  h+=promoSec(i);
  if(hdMode)h+=holdsSec(i);
  h+=pastPlaysSec(i);
  if(i.notable)h+='<div class="pst">Notable Artists</div><div class="pnotes">'+E(i.notable)+'</div>';
  if(i.thoughts)h+='<div class="pst">LRA Notes</div><div class="pnotes">'+E(i.thoughts)+'</div>';
  if(i.notes)h+='<div class="pst">Venue Notes</div><div class="pnotes">'+E(i.notes)+'</div>';
  h+=links(i,VT);
  if(rtMode)h+='<button class="popup-route-btn" onclick="addRSById(\''+i.id+'\')">+ Add to Route</button>';
  if(orMode)h+='<button class="popup-outreach-btn" onclick="toggleOutreachSelect(all.find(x=>x.id===\''+i.id+'\'))">'+(oSelected.has(i.id)?'‚úì Selected':'+ Select for Outreach')+'</button>';
  return h;
}

function fPop(i){
  let h='<div class="pn" style="color:var(--fest)">‚≠ê '+E(i.name)+'</div><div class="pl">'+E(i.city)+(i.state?', '+E(i.state):'')+'</div><div class="pg">';
  if(i.festType)h+=pf('Type',i.festType);
  if(i.cap)h+=pf('Attendance',i.cap.toLocaleString());
  if(i.month)h+=pf('Month',i.month);
  if(i.genres)h+=pf('Genres',cj(i.genres));
  if(i.dates2026)h+=pff('2026 Dates',i.dates2026);
  if(i.bookStart)h+=pff('Starts Booking',i.bookStart);
  if(i.bookStatus)h+=pf('Status',i.bookStatus);
  if(i.pitched2026)h+=pf('2026 Pitched',i.pitched2026);
  h+='</div>';
  h+=promoSec(i);
  if(i.WF)h+='<div style="margin:4px 0"><span style="background:var(--accent2);color:#000;padding:1px 5px;border-radius:3px;font-size:8px;font-family:\'JetBrains Mono\',monospace;font-weight:600">WF ‚úì</span></div>';
  if(i.lineup)h+='<div class="pst">Previous Lineup</div><div class="pnotes" style="max-height:80px">'+E(i.lineup)+'</div>';
  h+=pastPlaysSec(i);
  h+=outSec(i,'festivals');
  if(i.thoughts)h+='<div class="pst">LRA Notes</div><div class="pnotes">'+E(i.thoughts)+'</div>';
  h+=links(i,FT);
  if(orMode)h+='<button class="popup-outreach-btn" onclick="toggleOutreachSelect(all.find(x=>x.id===\''+i.id+'\'))">'+(oSelected.has(i.id)?'‚úì Selected':'+ Select for Outreach')+'</button>';
  return h;
}

function sPop(i){
  let h='<div class="pn" style="color:var(--ser)">üí† '+E(i.name)+'</div><div class="pl">'+E(i.city)+(i.state?', '+E(i.state):'')+'</div><div class="pg">';
  if(i.cap)h+=pf('Capacity',i.cap.toLocaleString());
  if(i.feeRange)h+=pf('Fee Range',i.feeRange);
  if(i.dayOfWeek)h+=pf('Day',i.dayOfWeek);
  if(i.prevDOW)h+=pf('Prev DOW',i.prevDOW);
  if(i.genres)h+=pf('Genres',i.genres);
  if(i.months)h+=pff('Months',i.months);
  if(i.expStart)h+=pf('2026 Start',fmtD(i.expStart));
  if(i.expEnd)h+=pf('2026 End',fmtD(i.expEnd));
  if(i.bookStart)h+=pff('Starts Booking',i.bookStart);
  h+='</div>';
  h+=promoSec(i);
  if(i.prevArtists)h+='<div class="pst">Previous Artists</div><div class="pnotes" style="max-height:80px">'+E(i.prevArtists)+'</div>';
  h+=pastPlaysSec(i);
  h+=outSec(i,'series');
  if(i.seriesInfo)h+='<div class="pst">Series Info</div><div class="pnotes">'+E(i.seriesInfo)+'</div>';
  if(i.thoughts)h+='<div class="pst">LRA Notes</div><div class="pnotes">'+E(i.thoughts)+'</div>';
  h+=links(i,ST);
  if(orMode)h+='<button class="popup-outreach-btn" onclick="toggleOutreachSelect(all.find(x=>x.id===\''+i.id+'\'))">'+(oSelected.has(i.id)?'‚úì Selected':'+ Select for Outreach')+'</button>';
  return h;
}

function pf(l,v){return'<div class="pf"><div class="lb">'+l+'</div><div class="vl">'+E(v)+'</div></div>'}
function pff(l,v){return'<div class="pf pf-f"><div class="lb">'+l+'</div><div class="vl">'+E(v)+'</div></div>'}

function pastPlaysSec(i){
  // Check for linked venue record (Venues field points to Venues table)
  // i.id is the venues/festival/series record ID ‚Äî pastPlays is keyed by those IDs
  const plays=pastPlays[i.id]||[];
  if(!plays.length)return'';
  // Group by artist
  const byArt={};
  plays.forEach(p=>{if(!byArt[p.artist])byArt[p.artist]=[];byArt[p.artist].push(p)});
  const artNames=Object.keys(byArt).sort();
  let h='<div class="pst">üéµ LRA Past Plays ('+plays.length+')</div>';
  // Artist chips
  h+='<div style="display:flex;gap:3px;flex-wrap:wrap;margin-bottom:6px">';
  artNames.forEach(a=>{h+='<span style="background:var(--accent2);color:#000;padding:1px 6px;border-radius:3px;font-size:8px;font-family:\'JetBrains Mono\',monospace;font-weight:600">'+E(a)+'</span>'});
  h+='</div>';
  // Play details (scrollable)
  h+='<div style="max-height:140px;overflow-y:auto;border:1px solid var(--border);border-radius:4px;padding:4px">';
  plays.forEach(p=>{
    const d=p.date?new Date(p.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'';
    const gt=p.guarantee?'$'+Number(p.guarantee).toLocaleString():'';
    const po=p.payout?'$'+Number(p.payout).toLocaleString():'';
    h+='<div style="padding:3px 0;border-bottom:1px solid var(--border);font-size:9px">';
    h+='<div style="display:flex;justify-content:space-between;align-items:center">';
    h+='<span style="color:var(--accent);font-weight:700">'+E(p.artist)+'</span>';
    if(d)h+='<span style="color:var(--dim)">'+d+'</span>';
    h+='</div>';
    let dets=[];
    if(p.billing)dets.push(p.billing);
    if(gt)dets.push('GT: '+gt);
    if(po&&po!==gt)dets.push('Paid: '+po);
    if(p.advPrice)dets.push('Tix: $'+p.advPrice);
    if(p.sellable)dets.push('Sell: '+p.sellable);
    if(p.sold)dets.push('Sold: '+p.sold);
    if(dets.length)h+='<div style="color:var(--text)">'+dets.join(' ¬∑ ')+'</div>';
    if(p.dealTerms)h+='<div style="color:var(--dim);font-size:8px;margin-top:1px">'+E(p.dealTerms.substring(0,100))+(p.dealTerms.length>100?'...':'')+'</div>';
    if(p.radius)h+='<div style="color:var(--dim);font-size:8px">üì° '+E(p.radius.substring(0,80))+(p.radius.length>80?'...':'')+'</div>';
    h+='</div>';
  });
  h+='</div>';
  return h;
}

function promoSec(i){
  if(!i.promoter&&!i.company&&!i.pEmail&&!i.pName)return'';
  let h='<div class="pst">Promoter</div><div class="pp">';
  if(i.promoter)h+='<div class="ppn">'+E(i.promoter)+'</div>';
  if(i.pName&&i.pName!==i.promoter)h+='<div class="ppn">'+E(i.pName)+'</div>';
  if(i.company)h+='<div class="ppc">'+E(i.company)+'</div>';
  if(i.pEmail)h+='<div class="ppe">'+E(i.pEmail)+'</div>';
  h+='</div>';return h;
}

function holdsSec(i){
  const nm=i.name.toLowerCase().trim();let found=[];
  for(const tab of H_TABS){
    if(!hData[tab])continue;
    let hd=hData[tab][nm];
    if(!hd){for(const[k,v] of Object.entries(hData[tab])){if(nm.includes(k)||k.includes(nm)){hd=v;break}}}
    if(hd)hd.holds.forEach(h=>found.push({a:tab,d:h.date,s:h.status}));
  }
  if(!found.length)return'';
  let h='<div class="pst">Active Holds</div><div style="max-height:80px;overflow-y:auto">';
  found.forEach(f=>{h+='<div class="phr"><span>'+E(f.a)+'</span><span>'+E(f.d)+'</span><span style="color:'+hCellCol(f.s)+';font-weight:600">'+E(f.s)+'</span></div>'});
  return h+'</div>';
}
function hCellCol(s){const l=(s||'').toLowerCase();if(l.includes('conf'))return'#28a745';if(l.match(/^1/))return'#5cb85c';if(l.match(/^[23]/))return'#f0c040';if(l.match(/^[4-9]/)||l.match(/^\d\d/))return'#e08030';if(l.includes('na')||l.includes('released'))return'#d9534f';if(l.includes('avail'))return'#5bc0de';return'#999'}

function outSec(i,tType){
  const val=stripRT(i.outreach||'');
  let h='<div class="pst">Outreach Info <span style="color:var(--accent2);font-size:7px">‚úèÔ∏è EDITABLE</span></div>';
  h+='<textarea class="oa" id="ot-'+i.id+'" placeholder="Log: date, who, re: which artist...">'+E(val)+'</textarea>';
  h+='<div style="display:flex;align-items:center;gap:3px"><button class="os" onclick="saveOut(\''+i.id+'\',\''+tType+'\')">üíæ Save</button><span class="ostat" id="os-'+i.id+'"></span></div>';
  return h;
}
function stripRT(v){return v?String(v).replace(/<[^>]+>/g,'').trim():''}

async function saveOut(rid,tt){
  const el=document.getElementById('ot-'+rid),st=document.getElementById('os-'+rid);if(!el)return;
  const tid=tt==='festivals'?FT:ST,fid=OF[tt];
  st.textContent='Saving...';st.style.color='var(--accent)';
  try{
    const r=await fetch('https://api.airtable.com/v0/'+B+'/'+tid+'/'+rid,{
      method:'PATCH',headers:{Authorization:'Bearer '+PAT,'Content-Type':'application/json'},
      body:JSON.stringify({fields:{[fid]:el.value}})
    });
    if(!r.ok)throw new Error(r.status);
    const item=all.find(x=>x.id===rid);if(item)item.outreach=el.value;
    st.textContent='‚úì Saved!';st.style.color='var(--accent2)';setTimeout(()=>st.textContent='',3000);
  }catch(e){st.textContent='‚úï '+e.message;st.style.color='var(--never)'}
}

function links(i,tid){
  let h='<div class="plinks">';
  if(i.website)h+='<a class="plink" href="'+E(i.website)+'" target="_blank">üåê Website</a>';
  h+='<a class="plink" href="https://airtable.com/'+B+'/'+tid+'/'+i.id+'" target="_blank">üìã Open in Airtable</a>';
  h+='</div>';return h;
}

// ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ
function applyFilters(){
  const q=(document.getElementById('search').value||'').toLowerCase();
  const fm=document.getElementById('f-month').value;
  const sm=document.getElementById('f-smonth').value;
  const cMin=parseInt(document.getElementById('cap-min').value)||0;
  const cMax=parseInt(document.getElementById('cap-max').value)||Infinity;
  filt=all.filter(i=>{
    if(i.type==='venue'&&!pts.venues)return false;
    if(i.type==='festival'&&!pts.festivals)return false;
    if(i.type==='series'&&!pts.series)return false;
    if(q){const hay=[i.name,i.city,i.state,i.promoter||'',i.company||'',i.pEmail||'',i.pName||''].join(' ').toLowerCase();if(!hay.includes(q))return false}
    if(fm&&i.type==='festival'){if(!i.month||!i.month.startsWith(fm.substring(0,2)))return false}
    if(sm&&i.type==='series'){if(!i.months||!i.months.toLowerCase().includes(sm.toLowerCase()))return false}
    if(i.cap&&(i.cap<cMin||i.cap>cMax))return false;
    if(cMin>0&&!i.cap)return false;
    if(aArts.size>0&&i.type==='venue'){
      const match=[...aArts].some(k=>i[k]);
      if(nvMode?match:!match)return false;
    }
    return true;
  });
  renderMkrs();renderVL();updCounts();
}

function renderVL(){
  const list=document.getElementById('vl');list.innerHTML='';
  const sorted=[...filt].filter(i=>i.lat&&i.lng).sort((a,b)=>a.name.localeCompare(b.name));
  sorted.slice(0,300).forEach(i=>{
    const d=document.createElement('div');
    d.className='vi-item'+(rStops.includes(i)?' in-r':'')+(oSelected.has(i.id)?' in-o':'');
    const ic=i.type==='festival'?'‚≠ê ':i.type==='series'?'üí† ':'';
    let bd='';
    if(i.type==='venue'&&i.cap)bd+='<span class="bd" style="background:'+capCol(i.cap)+'22;color:'+capCol(i.cap)+'">'+i.cap.toLocaleString()+'</span>';
    if(i.type==='festival'&&i.festType)bd+='<span class="bd" style="background:rgba(255,215,0,.15);color:var(--fest)">'+i.festType+'</span>';
    if(i.type==='festival'&&i.month)bd+='<span class="bd" style="background:rgba(255,215,0,.08);color:var(--dim)">'+i.month+'</span>';
    if(i.type==='series'&&i.feeRange)bd+='<span class="bd" style="background:rgba(0,229,255,.1);color:var(--ser)">'+i.feeRange+'</span>';
    if(hdMode){const hc=getHC(i);if(hc)bd+='<span class="bd" style="background:'+hc+'22;color:'+hc+'">HOLD</span>'}
    if(oSelected.has(i.id))bd+='<span class="bd" style="background:rgba(0,212,170,.2);color:var(--outreach)">SELECTED</span>';
    if(orMode&&outreachedIds.has(i.id))bd+='<span class="bd" style="background:rgba(255,82,82,.15);color:#ff5252">OUTREACHED</span>';
    if(pastPlays[i.id])bd+='<span class="bd" style="background:rgba(255,215,0,.12);color:var(--accent2)">'+pastPlays[i.id].length+' play'+(pastPlays[i.id].length>1?'s':'')+'</span>';
    d.innerHTML='<div class="nm">'+ic+E(i.name)+'</div><div class="mt"><span>'+E(i.city)+(i.state?', '+E(i.state):'')+'</span>'+(i.cap?'<span>'+i.cap.toLocaleString()+'</span>':'')+bd+'</div>';
    d.onclick=()=>{
      if(orMode){toggleOutreachSelect(i);return}
      if(mkrs[i.id]){map.setView([i.lat,i.lng],13);mkrs[i.id].fire('click')}
    };
    list.appendChild(d);
  });
}

function updCounts(){
  const mp=filt.filter(i=>i.lat&&i.lng).length;
  const vc=filt.filter(i=>i.type==='venue').length,fc=filt.filter(i=>i.type==='festival').length,sc=filt.filter(i=>i.type==='series').length;
  document.getElementById('counts').textContent=all.filter(i=>i.type==='venue').length+'v ¬∑ '+all.filter(i=>i.type==='festival').length+'f ¬∑ '+all.filter(i=>i.type==='series').length+'s';
  document.getElementById('s-count').textContent='Showing: '+filt.length+' ('+vc+'v/'+fc+'f/'+sc+'s)';
  document.getElementById('m-count').textContent='Mapped: '+mp;
}

function togPT(t){
  pts[t]=!pts[t];
  const ids={venues:'pt-v',festivals:'pt-f',series:'pt-s'};
  const cols={venues:['var(--accent)','#fff'],festivals:['var(--fest)','#000'],series:['var(--ser)','#000']};
  const btn=document.getElementById(ids[t]);
  if(pts[t]){btn.classList.add('on');btn.style.background=cols[t][0];btn.style.borderColor=cols[t][0];btn.style.color=cols[t][1]}
  else{btn.classList.remove('on');btn.style.background='var(--surface2)';btn.style.borderColor='var(--border)';btn.style.color='var(--dim)'}
  applyFilters();
}

// ‚îÄ‚îÄ ROUTE ‚îÄ‚îÄ
function togRoute(){
  rtMode=!rtMode;
  document.getElementById('btn-rt').classList.toggle('ar',rtMode);
  document.getElementById('r-banner').classList.toggle('on',rtMode);
  document.getElementById('rp').classList.toggle('vis',rtMode);
  if(rtMode){disableOtherModes('route')}
}
function addRS(i){if(!rStops.includes(i)){rStops.push(i);renderRP();if(rStops.length>1)calcRoute();applyFilters()}}
function addRSById(id){const i=all.find(x=>x.id===id);if(i)addRS(i)}
function remRS(idx){rStops.splice(idx,1);renderRP();if(rStops.length>1)calcRoute();else clearRL();applyFilters()}
function clearRoute(){rStops=[];rLegs=[];clearRL();renderRP();applyFilters()}
function clearRL(){if(rLayer){map.removeLayer(rLayer);rLayer=null}document.getElementById('r-totals').style.display='none'}
function renderRP(){
  const c=document.getElementById('r-stops');c.innerHTML='';
  rStops.forEach((i,idx)=>{
    const leg=rLegs[idx-1],li=leg?(leg.distance/1609.34).toFixed(0)+'mi ¬∑ '+fmtDur(leg.duration):'';
    c.innerHTML+='<div class="rs"><div class="num">'+(idx+1)+'</div><div class="vi"><div class="vn">'+E(i.name)+'</div><div class="vd">'+E(i.city)+(i.state?', '+E(i.state):'')+'</div></div>'+(li?'<div class="li">'+li+'</div>':'')+'<button class="rx" onclick="remRS('+idx+')">‚úï</button></div>';
  });
}
async function calcRoute(){
  if(rStops.length<2)return;
  const coords=rStops.map(s=>s.lng+','+s.lat).join(';');
  try{
    const r=await fetch('https://router.project-osrm.org/route/v1/driving/'+coords+'?overview=full&geometries=geojson&steps=false');
    const d=await r.json();if(d.code!=='Ok')return;
    clearRL();
    rLayer=L.geoJSON(d.routes[0].geometry,{style:{color:'#ff6b35',weight:3,opacity:.8,dashArray:'8,6'}}).addTo(map);
    rLegs=d.routes[0].legs;renderRP();
    const td=rLegs.reduce((s,l)=>s+l.distance,0),tt=rLegs.reduce((s,l)=>s+l.duration,0);
    document.getElementById('r-dist').textContent=(td/1609.34).toFixed(0)+' mi';
    document.getElementById('r-time').textContent=fmtDur(tt);
    document.getElementById('r-totals').style.display='flex';
  }catch(e){console.error(e)}
}

// ‚îÄ‚îÄ NEVER PLAYED ‚îÄ‚îÄ
function togNever(){nvMode=!nvMode;document.getElementById('btn-nv').classList.toggle('an',nvMode);if(nvMode)disableOtherModes('never');applyFilters()}

// ‚îÄ‚îÄ RADIUS ‚îÄ‚îÄ
function togRadius(){rdMode=!rdMode;document.getElementById('btn-rd').classList.toggle('ax',rdMode);document.getElementById('rc').classList.toggle('vis',rdMode);if(rdMode)disableOtherModes('radius');else{if(rCircle){map.removeLayer(rCircle);rCircle=null}}}
function updRL(){document.getElementById('r-val').textContent=document.getElementById('r-slider').value+'mi';if(rCircle)rCircle.setRadius(+document.getElementById('r-slider').value*1609.34)}
function showRad(i){const mi=+document.getElementById('r-slider').value;if(rCircle)map.removeLayer(rCircle);rCircle=L.circle([i.lat,i.lng],{radius:mi*1609.34,color:'#6c5ce7',fillColor:'#6c5ce7',fillOpacity:.08,weight:2,dashArray:'6,4'}).addTo(map);map.fitBounds(rCircle.getBounds())}

// ‚îÄ‚îÄ HOLDS ‚îÄ‚îÄ
function togHolds(){hdMode=!hdMode;document.getElementById('btn-hd').classList.toggle('ah',hdMode);document.getElementById('hp').classList.toggle('vis',hdMode);if(hdMode)updHP();applyFilters()}
function updHP(){
  const s=document.getElementById('h-sum');
  if(!aArts.size){s.innerHTML='Select artist chips to see stats';return}
  let h='';
  for(const a of aArts){
    const idx=AK.indexOf(a);if(idx===-1)continue;
    const tab=H_TABS[idx];if(!tab||!hData[tab])continue;
    const entries=Object.values(hData[tab]);
    let c={asked:0,'1h':0,'23h':0,'4h':0,confirmed:0,na:0,avail:0};
    entries.forEach(e=>{if(e.best)c[e.best.s]=(c[e.best.s]||0)+1});
    h+='<div><strong style="color:var(--accent)">'+tab+'</strong>: <span style="color:#28a745">'+c.confirmed+'conf</span> ¬∑ <span style="color:#5cb85c">'+c['1h']+'√ó1st</span> ¬∑ <span style="color:#f0c040">'+c['23h']+'√ó2-3</span> ¬∑ <span style="color:#e08030">'+c['4h']+'√ó4+</span> ¬∑ <span style="color:#999">'+c.asked+'ask</span> ¬∑ <span style="color:#d9534f">'+c.na+'NA</span></div>';
  }
  s.innerHTML=h||'No holds data';
}

// ‚îÄ‚îÄ MODE SWITCHING ‚îÄ‚îÄ
function disableOtherModes(keep){
  if(keep!=='route'){rtMode=false;document.getElementById('btn-rt').classList.remove('ar');document.getElementById('r-banner').classList.remove('on');document.getElementById('rp').classList.remove('vis')}
  if(keep!=='never'){nvMode=false;document.getElementById('btn-nv').classList.remove('an')}
  if(keep!=='radius'){rdMode=false;document.getElementById('btn-rd').classList.remove('ax');document.getElementById('rc').classList.remove('vis')}
  if(keep!=='outreach'){orMode=false;document.getElementById('btn-or').classList.remove('ao');document.getElementById('o-banner').classList.remove('on');document.getElementById('op').classList.remove('vis')}
}

// ‚îÄ‚îÄ OUTREACH MODE ‚îÄ‚îÄ
function togOutreach(){
  orMode=!orMode;
  document.getElementById('btn-or').classList.toggle('ao',orMode);
  document.getElementById('o-banner').classList.toggle('on',orMode);
  document.getElementById('op').classList.toggle('vis',orMode);
  if(orMode){disableOtherModes('outreach')}
  else{oSelected.clear();outreachedIds.clear();applyFilters()}
}

async function loadCampaignNames(){
  try{
    const recs=await fetchAll(OUTREACH_T,['Campaign Name']);
    const names=new Set();
    recs.forEach(r=>{if(r.fields['Campaign Name'])names.add(r.fields['Campaign Name'])});
    const dl=document.getElementById('campaign-list');dl.innerHTML='';
    [...names].sort().forEach(n=>{const o=document.createElement('option');o.value=n;dl.appendChild(o)});
  }catch(e){console.warn('campaign load',e)}
}

function toggleOutreachSelect(item){
  if(!item)return;
  if(oSelected.has(item.id)){oSelected.delete(item.id)}else{oSelected.add(item.id)}
  renderOutreachList();
  document.getElementById('o-count').textContent=oSelected.size+' selected';
  document.getElementById('o-save-btn').disabled=oSelected.size===0;
  // Update just the marker icon for this item
  if(mkrs[item.id]){
    let hc=null;if(hdMode&&aArts.size>0)hc=getHC(item);
    mkrs[item.id].setIcon(mkIcon(item,hc));
  }
  renderVL();
}

function renderOutreachList(){
  const c=document.getElementById('o-list');c.innerHTML='';
  oSelected.forEach(id=>{
    const item=all.find(x=>x.id===id);if(!item)return;
    c.innerHTML+='<div class="op-item"><span>'+E(item.name)+' <span style="color:var(--dim)">'+E(item.city)+(item.state?', '+E(item.state):'')+(item.cap?' ¬∑ '+item.cap:'')+'</span></span><button class="ox" onclick="toggleOutreachSelect(all.find(x=>x.id===\''+id+'\'))">‚úï</button></div>';
  });
}

function onOutreachArtistChange(){
  const artist=document.getElementById('o-artist').value;
  if(artist)loadOutreachForArtist(artist);
  else{outreachedIds.clear();applyFilters()}
}

async function loadOutreachForArtist(artist){
  if(outreachCache[artist]){buildOutreachedIds(artist);applyFilters();return}
  try{
    const formula='FIND("'+artist.replace(/"/g,'\\"')+'",{Artists (Active)})';
    const recs=await fetchFiltered(OUTREACH_T,formula,['Campaign Name','Artists (Active)','Venue','Festival','Series','Agent','Outreach Type','Priority','Response Status','Date Outreach Sent','Follow Up Date']);
    outreachCache[artist]=recs;
    buildOutreachedIds(artist);
    applyFilters();
  }catch(e){console.warn('outreach load fail',e)}
}

function buildOutreachedIds(artist){
  outreachedIds.clear();
  const recs=outreachCache[artist]||[];
  recs.forEach(r=>{
    const f=r.fields;
    (f['Venue']||[]).forEach(id=>outreachedIds.add(id));
    (f['Festival']||[]).forEach(id=>outreachedIds.add(id));
    (f['Series']||[]).forEach(id=>outreachedIds.add(id));
  });
}

async function saveOutreach(){
  const campaigns=[...document.querySelectorAll('#o-campaigns input:checked')].map(c=>c.value);
  const customCamp=document.getElementById('o-campaign-custom').value.trim();
  if(customCamp)campaigns.push(customCamp);
  const artist=document.getElementById('o-artist').value;
  const otype=document.getElementById('o-type').value;
  const priority=document.getElementById('o-priority').value;
  const statusEl=document.getElementById('o-save-status');
  if(!campaigns.length){statusEl.textContent='Select or type a campaign';statusEl.style.color='var(--never)';return}
  if(!artist){statusEl.textContent='Select an artist';statusEl.style.color='var(--never)';return}
  if(oSelected.size===0)return;

  const btn=document.getElementById('o-save-btn');btn.disabled=true;btn.textContent='Saving...';
  statusEl.textContent='';
  const today=new Date().toISOString().split('T')[0];
  let saved=0,failed=0;

  // Batch save ‚Äî up to 10 at a time via Airtable API
  const items=[...oSelected].map(id=>all.find(x=>x.id===id)).filter(Boolean);
  for(let i=0;i<items.length;i+=10){
    const batch=items.slice(i,i+10);
    const records=batch.map(item=>{
      const fields={
        'Campaigns':campaigns,
        'Artists (Active)':artist,
        'Outreach Type':otype,
        'Priority':priority,
        'Response Status':'No Response',
        'Date Outreach Sent':today
      };
      // Link venue if it's a venue type
      if(item.type==='venue')fields['Venue']=[item.id];
      if(item.type==='festival')fields['Festival']=[item.id];
      if(item.type==='series')fields['Series']=[item.id];
      // Link agent
      if(agentRec)fields['Agent']=[agentRec.id];
      return{fields};
    });
    try{
      const r=await fetch('https://api.airtable.com/v0/'+B+'/'+OUTREACH_T,{
        method:'POST',headers:{Authorization:'Bearer '+PAT,'Content-Type':'application/json'},
        body:JSON.stringify({records})
      });
      if(!r.ok){const t=await r.text();console.error('outreach save error',r.status,t);statusEl.textContent='API: '+t.substring(0,120);statusEl.style.color='var(--never)';failed+=batch.length}
      else saved+=batch.length;
    }catch(e){console.error(e);statusEl.textContent='Network: '+e.message;statusEl.style.color='var(--never)';failed+=batch.length}
  }

  btn.textContent='Save to Airtable';btn.disabled=false;
  if(failed===0){
    statusEl.textContent='‚úì '+saved+' records saved!';statusEl.style.color='var(--outreach)';
    // Clear selections
    oSelected.clear();renderOutreachList();
    document.getElementById('o-count').textContent='0 selected';
    document.getElementById('o-save-btn').disabled=true;
    // Invalidate cache for this artist
    delete outreachCache[artist];
    applyFilters();
  } else {
    statusEl.textContent='‚ö† '+saved+' saved, '+failed+' failed';statusEl.style.color='var(--never)';
  }
  setTimeout(()=>statusEl.textContent='',5000);
}

// ‚îÄ‚îÄ VIEW OUTREACH PANEL ‚îÄ‚îÄ
function openVOP(artist){
  const recs=outreachCache[artist]||[];
  const c=document.getElementById('vop-content');
  if(!recs.length){c.innerHTML='<div style="color:var(--dim);font-size:11px">No outreach records for '+artist+'</div>';document.getElementById('vop').classList.add('vis');return}
  let h='<div style="font-size:10px;color:var(--dim);margin-bottom:8px">'+recs.length+' records for '+artist+'</div>';
  recs.forEach(r=>{
    const f=r.fields;
    const sc=f['Response Status']||'Unknown';
    const scol=sc==='Not Sent'?'var(--dim)':sc==='Sent'?'var(--accent)':sc==='Responded'?'var(--outreach)':sc==='Booked'?'var(--st-conf)':'var(--dim)';
    h+='<div class="vop-row"><div class="vrn">'+(f['Venue']||f['Campaign Name']||'Record')+'</div><div class="vrs" style="background:'+scol+'22;color:'+scol+'">'+sc+'</div><div class="vrm">'+(f['Outreach Type']||'')+' ¬∑ '+(f['Priority']||'')+' ¬∑ '+(f['Date Outreach Sent']||'')+'</div></div>';
  });
  c.innerHTML=h;document.getElementById('vop').classList.add('vis');
}
function closeVOP(){document.getElementById('vop').classList.remove('vis')}

// ‚îÄ‚îÄ STATUS OVERLAY ‚îÄ‚îÄ
function togStatus(){
  stMode=!stMode;
  document.getElementById('btn-st').classList.toggle('as',stMode);
  document.getElementById('sp').classList.toggle('vis',stMode);
  if(!stMode)clearStatusOverlay();
}

async function loadStatusOverlay(){
  if(!stMode)return;
  clearStatusOverlay();
  const artist=document.getElementById('s-artist').value;
  if(!artist){document.getElementById('s-info').textContent='Select an artist';return}

  // Get checked statuses
  const checks=[...document.querySelectorAll('#sp .st-chk input:checked')].map(c=>c.value);
  if(!checks.length){document.getElementById('s-info').textContent='Check at least one status';return}

  document.getElementById('s-info').textContent='Loading...';

  try{
    // Build formula
    const statusParts=checks.map(s=>'Status="'+s+'"').join(',');
    const formula='AND({Artist}="'+artist+'",OR('+statusParts+'),IS_AFTER({Date},TODAY()))';
    const fields=['Status','Artist','Date','Venue Location','Venues','Venue','Venue City','Venue ST','Guarantee','Radius Clause','Billing','Day of Week','Offers to Venues'];
    const recs=await fetchFiltered(OC_T,formula,fields);

    document.getElementById('s-info').textContent=recs.length+' dates found';

    // Create status layer group
    statusLayer=L.layerGroup().addTo(map);

    recs.forEach(r=>{
      const f=r.fields;
      const status=f['Status']||'';
      const col=ST_COLORS[status]||'#888';

      // Try to get coords from Map Field or venue location
      let lat=null,lng=null;
      const vl=f['Venue Location']||'';
      if(vl){
        // Try to parse "Venue Name, Address" style ‚Äî geocode from city/state
        const city=f['Venue City']||'';
        const state=f['Venue ST']||'';
        // Try to find matching venue in our data
        const venName=(f['Offers to Venues']||'').split(' - ')[0].trim();
        const match=all.find(v=>(v.name===venName||(v.city===city&&v.state===state))&&v.lat&&v.lng);
        if(match){lat=match.lat;lng=match.lng}
        else{
          // Try parsing venue location string as coords
          const coords=parseCoords(vl);
          if(coords){lat=coords[0];lng=coords[1]}
        }
      }
      if(!lat){
        // Fallback: match by venue name from offers field
        const venName=(f['Offers to Venues']||'').split(' - ')[0].trim().toLowerCase();
        if(venName){const m=all.find(v=>v.name.toLowerCase()===venName&&v.lat);if(m){lat=m.lat;lng=m.lng}}
      }
      if(!lat||!lng)return;

      // Create diamond/flag marker slightly offset
      const shape=status==='CONFIRMED'?'polygon(50% 0%,100% 50%,50% 100%,0% 50%)':'polygon(50% 0%,85% 25%,85% 75%,50% 100%,15% 75%,15% 25%)';
      const icon=L.divIcon({
        html:'<div style="position:relative"><div style="width:16px;height:16px;background:'+col+';clip-path:'+shape+';border:1px solid rgba(255,255,255,.3);filter:drop-shadow(0 0 4px '+col+'80)"></div></div>',
        iconSize:[16,16],iconAnchor:[8,8],className:''
      });
      const m=L.marker([lat+0.002,lng+0.002],{icon,zIndexOffset:1000});

      // Popup
      const dateStr=f['Date']?new Date(f['Date']).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'}):'';
      let pop='<div style="font-family:\'JetBrains Mono\',monospace;font-size:11px"><div style="color:'+col+';font-weight:700;font-size:13px">'+E(status)+'</div>';
      pop+='<div style="font-weight:700;font-size:12px;margin:3px 0">'+E(f['Artist']||artist)+'</div>';
      pop+='<div style="color:var(--dim);font-size:10px">'+E(f['Offers to Venues']||'')+'</div>';
      pop+='<div style="margin:4px 0;font-size:10px">üìÖ '+dateStr+'</div>';
      if(f['Guarantee'])pop+='<div style="font-size:10px">üí∞ $'+Number(f['Guarantee']).toLocaleString()+'</div>';
      if(f['Billing'])pop+='<div style="font-size:10px">üé§ '+E(f['Billing'])+'</div>';
      if(f['Radius Clause'])pop+='<div style="font-size:9px;color:var(--dim);margin-top:3px">üì° '+E(f['Radius Clause'])+'</div>';
      pop+='</div>';
      m.bindPopup(pop,{maxWidth:350});
      m.addTo(statusLayer);

      // Draw 90-mile radius for CONFIRMED
      if(status==='CONFIRMED'&&checks.includes('CONFIRMED')){
        const circle=L.circle([lat,lng],{radius:90*1609.34,color:col,fillColor:col,fillOpacity:.06,weight:1.5,dashArray:'6,4'});
        circle.addTo(statusLayer);
        statusCircles.push(circle);
      }
    });
  }catch(e){document.getElementById('s-info').textContent='Error: '+e.message;console.error(e)}
}

function clearStatusOverlay(){
  if(statusLayer){map.removeLayer(statusLayer);statusLayer=null}
  statusCircles=[];
}

// ‚îÄ‚îÄ GEOCODE ‚îÄ‚îÄ
async function geocodeMissing(){
  const miss=all.filter(i=>!i.lat&&(i.vLoc||i.city));if(!miss.length)return;
  const gp=document.getElementById('gp'),gt=document.getElementById('g-text'),gf=document.getElementById('g-fill');
  gp.classList.add('on');let done=0;
  for(const i of miss){
    const q=i.vLoc||i.city+', '+i.state;
    try{
      const r=await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(q)+'&limit=1',{headers:{'User-Agent':'LRA-Map/4'}});
      const d=await r.json();
      if(d.length){i.lat=+d[0].lat;i.lng=+d[0].lon;
        const tid=i.type==='venue'?VT:i.type==='festival'?FT:ST;
        const lngField=i.type==='venue'?'Longitude ':'Longitude';
        fetch('https://api.airtable.com/v0/'+B+'/'+tid+'/'+i.id,{method:'PATCH',headers:{Authorization:'Bearer '+PAT,'Content-Type':'application/json'},body:JSON.stringify({fields:{'Latitude':+d[0].lat,[lngField]:+d[0].lon}})}).catch(()=>{});
      }
    }catch(e){}
    done++;gt.textContent='Geocoding '+done+'/'+miss.length;gf.style.width=((done/miss.length)*100)+'%';
    if(done%15===0){applyFilters();saveCache(all)}
    await new Promise(r=>setTimeout(r,1100));
  }
  gp.classList.remove('on');applyFilters();saveCache(all);
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportCSV(){
  const items=filt.filter(i=>i.lat&&i.lng);
  let csv='Type,Name,City,State,Region,Capacity,Lat,Lng,Promoter,Email,Website\n';
  items.forEach(i=>{csv+=[i.type,Q(i.name),Q(i.city),Q(i.state),Q(i.region||''),i.cap||'',i.lat||'',i.lng||'',Q(i.promoter||''),Q(i.pEmail||''),Q(i.website||'')].join(',')+'\n'});
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download='lra-map-export.csv';a.click();
}
function Q(s){return'"'+String(s).replace(/"/g,'""')+'"'}

function E(s){if(!s)return'';const d=document.createElement('div');d.textContent=String(s);return d.innerHTML}
function fmtD(d){if(!d)return'';try{return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}catch(e){return String(d)}}
function fmtDur(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60);return h?h+'h '+m+'m':m+'m'}
function cj(s){if(!s)return'';try{const a=JSON.parse(s);if(Array.isArray(a))return a.join(', ')}catch(e){}return s.replace(/[\[\]\"]/g,'')}
</script>
</body>
</html>
