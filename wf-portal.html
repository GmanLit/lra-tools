<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WF Portal">
<meta name="theme-color" content="#0a0a0f">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a0a0f' width='100' height='100' rx='20'/><text x='50' y='68' text-anchor='middle' font-size='50'>üé∏</text></svg>">
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiV0YgUG9ydGFsIiwic2hvcnRfbmFtZSI6IldGIFBvcnRhbCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMGEwYTBmIiwidGhlbWVfY29sb3IiOiIjMGEwYTBmIn0=">
<title>WF Portal</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0f;--surface:#14141f;--surface2:#1c1c2e;--border:#2a2a3d;--text:#e8e8f0;--dim:#8888a0;--accent:#ff6b35;--accent2:#00d4aa;--danger:#ff3366;--warn:#f0c040;--success:#28a745;--info:#5bc0de}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:env(safe-area-inset-bottom)}
.mono{font-family:'JetBrains Mono',monospace}

/* LOGIN */
#login{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.login-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;max-width:420px;width:100%;text-align:center}
.login-card h1{font-family:'JetBrains Mono',monospace;color:var(--accent);font-size:22px;letter-spacing:3px;text-transform:uppercase;margin-bottom:4px}
.login-card .sub{color:var(--dim);font-size:13px;margin-bottom:24px}
.login-card input,.login-card select{width:100%;padding:12px 16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;margin-bottom:12px;-webkit-appearance:none}
.login-card select option{background:var(--bg)}
.login-card input:focus,.login-card select:focus{border-color:var(--accent)}
.login-card button{width:100%;padding:12px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;cursor:pointer;letter-spacing:1px;text-transform:uppercase;transition:opacity .2s}
.login-card button:hover{opacity:.9}
.login-err{color:var(--danger);font-size:12px;margin-top:8px;display:none}

/* APP SHELL */
#app{display:none;min-height:100vh}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.topbar h1{font-family:'JetBrains Mono',monospace;font-size:15px;color:var(--accent);letter-spacing:2px;text-transform:uppercase}
.topbar .user-info{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--dim)}
.topbar .user-info .name{color:var(--accent2);font-weight:600}
.topbar .logout{background:none;border:1px solid var(--border);color:var(--dim);padding:5px 12px;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer;text-transform:uppercase;letter-spacing:.5px}
.topbar .logout:hover{border-color:var(--danger);color:var(--danger)}

/* TABS */
.tabs{display:flex;gap:2px;padding:0 24px;background:var(--surface);border-bottom:1px solid var(--border);overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:10px 18px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);cursor:pointer;border-bottom:2px solid transparent;text-transform:uppercase;letter-spacing:1px;white-space:nowrap;transition:all .2s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* CONTENT */
.content{padding:20px 24px;max-width:1200px;margin:0 auto}
.section{display:none}.section.active{display:block}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px}
.section-title{font-family:'JetBrains Mono',monospace;font-size:14px;color:var(--text);letter-spacing:1px;text-transform:uppercase}
.section-sub{font-size:11px;color:var(--dim);font-family:'JetBrains Mono',monospace}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:10px;transition:border-color .2s}
.card:hover{border-color:var(--accent)30}
.card-title{font-weight:700;font-size:14px;margin-bottom:6px}
.card-meta{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}

/* BADGES */
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;letter-spacing:.5px;text-transform:uppercase}
.b-todo{background:#88889920;color:var(--dim)}.b-progress{background:#f0c04020;color:var(--warn)}.b-blocked{background:#ff336620;color:var(--danger)}.b-done{background:#28a74520;color:var(--success)}
.b-urgent{background:#ff336620;color:var(--danger)}.b-high{background:#f0c04020;color:var(--warn)}.b-normal{background:#5bc0de20;color:var(--info)}.b-low{background:#88889920;color:var(--dim)}
.b-category{background:var(--accent)15;color:var(--accent)}
.b-pending{background:#f0c04020;color:var(--warn)}.b-approved{background:#28a74520;color:var(--success)}.b-rejected{background:#ff336620;color:var(--danger)}.b-reimbursed{background:#5bc0de20;color:var(--info)}
.b-active{background:#28a74520;color:var(--success)}.b-draft{background:#88889920;color:var(--dim)}.b-closed{background:#ff336620;color:var(--danger)}

/* BUTTONS */
.btn{padding:7px 14px;border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--dim);text-transform:uppercase;letter-spacing:.5px;transition:all .2s}
.btn:hover{border-color:var(--dim)}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}.btn-primary:hover{opacity:.9}
.btn-success{background:var(--accent2);color:#000;border-color:var(--accent2)}
.btn-sm{padding:4px 10px;font-size:9px}

/* STATUS SELECT */
.status-select{padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:10px;outline:none;cursor:pointer}
.status-select:focus{border-color:var(--accent)}
.status-select option{background:var(--bg)}

/* FORMS */
.form-group{margin-bottom:12px}
.form-group label{display:block;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--accent)}
.form-group select option{background:var(--bg)}
.form-group textarea{resize:vertical;min-height:80px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:600px){.form-row{grid-template-columns:1fr}}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto}
.modal-title{font-family:'JetBrains Mono',monospace;font-size:14px;color:var(--accent);margin-bottom:16px;text-transform:uppercase;letter-spacing:1px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}

/* NOTES/COMMENTS */
.comment-box{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px;margin-top:8px}
.comment-box textarea{width:100%;background:transparent;border:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:12px;resize:none;outline:none;min-height:50px}
.comment-box .actions{display:flex;justify-content:flex-end;margin-top:6px}

/* BUDGET PROGRESS */
.budget-bar{background:var(--border);border-radius:4px;height:8px;overflow:hidden;margin-top:6px}
.budget-fill{height:100%;border-radius:4px;transition:width .3s}

/* FILE UPLOAD */
.file-drop{border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:all .2s;color:var(--dim);font-size:12px}
.file-drop:hover,.file-drop.dragover{border-color:var(--accent);color:var(--accent)}
.file-drop input{display:none}
.file-preview{margin-top:8px;display:flex;align-items:center;gap:8px}
.file-preview img{max-height:60px;border-radius:4px}
.file-preview .fn{font-size:11px;color:var(--accent2)}

/* MEETING CARD */
.meeting-expand{max-height:0;overflow:hidden;transition:max-height .3s ease}
.meeting-expand.open{max-height:2000px}

/* LOADING */
.loading{text-align:center;padding:40px;color:var(--dim);font-family:'JetBrains Mono',monospace;font-size:12px}
.spinner{display:inline-block;width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin-bottom:8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* EMPTY STATE */
.empty{text-align:center;padding:40px;color:var(--dim)}
.empty .icon{font-size:36px;margin-bottom:10px}
.empty p{font-size:13px}

/* OWNER PICKER */
.owner-picker{position:relative;display:inline-block}
.owner-btn{padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--accent2);font-family:'JetBrains Mono',monospace;font-size:10px;cursor:pointer;white-space:nowrap;max-width:180px;overflow:hidden;text-overflow:ellipsis}
.owner-btn:hover{border-color:var(--accent)}
.owner-dropdown{position:absolute;top:100%;right:0;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:6px;z-index:50;min-width:160px;display:none;box-shadow:0 4px 12px rgba(0,0,0,.4)}
.owner-dropdown.open{display:block}
.owner-dropdown label{display:flex;align-items:center;gap:6px;padding:4px 6px;border-radius:4px;font-size:11px;color:var(--text);cursor:pointer;white-space:nowrap}
.owner-dropdown label:hover{background:var(--surface2)}
.owner-dropdown input[type=checkbox]{accent-color:var(--accent2)}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--surface);border:1px solid var(--accent2);color:var(--accent2);padding:10px 18px;border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:11px;z-index:300;transform:translateY(100px);opacity:0;transition:all .3s}
.toast.show{transform:translateY(0);opacity:1}
.toast.error{border-color:var(--danger);color:var(--danger)}

/* RESPONSIVE */
@media(max-width:768px){
  .topbar{padding:10px 16px;flex-wrap:wrap;gap:8px}
  .tabs{padding:0 16px}
  .content{padding:16px}
  .tab{padding:8px 12px;font-size:10px}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
<div class="login-card">
  <h1>üé∏ WF Portal</h1>
  <div class="sub">Weakened Friends Team Hub</div>
  <select id="login-name"><option value="">Select your name...</option></select>
  <input type="password" id="login-code" placeholder="Enter your code"/>
  <button onclick="doLogin()">Sign In</button>
  <div class="login-err" id="login-err"></div>
</div>
</div>

<!-- APP -->
<div id="app">
<div class="topbar">
  <h1>üé∏ WF Portal</h1>
  <div class="user-info">
    <span class="name" id="user-name"></span>
    <span id="user-role"></span>
    <button class="logout" onclick="doLogout()">Sign Out</button>
  </div>
</div>
<div class="tabs" id="tabs">
  <div class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</div>
  <div class="tab" onclick="switchTab('schedule')">üìÖ Schedule</div>
  <div class="tab" onclick="switchTab('tasks')">‚úÖ Tasks</div>
  <div class="tab" onclick="switchTab('meetings')">üé• Meetings</div>
  <div class="tab" onclick="switchTab('budgets')">üí∞ Budgets</div>
  <div class="tab" onclick="switchTab('expenses')">üßæ Expenses</div>
  <div class="tab" onclick="switchTab('messages')">üí¨ Messages</div>
  <div class="tab" onclick="switchTab('files')">üìÅ Files</div>
  <div class="tab" onclick="switchTab('commissions')">üí∏ Commissions</div>
  <div class="tab" onclick="switchTab('tour')">üé§ Tour Dates</div>
</div>
<div class="content">

<!-- DASHBOARD -->
<div class="section active" id="sec-dashboard">
  <div class="section-header"><div class="section-title">Dashboard</div></div>
  <div id="dash-stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:20px"></div>
  <div class="section-title" style="margin:16px 0 10px;font-size:12px">Today's Schedule</div>
  <div id="dash-schedule"></div>
  <div class="section-title" style="margin:16px 0 10px;font-size:12px">Your Open Tasks</div>
  <div id="dash-tasks"></div>
  <div class="section-title" style="margin:16px 0 10px;font-size:12px">All Open Tasks</div>
  <div id="dash-all-tasks"></div>
  <div class="section-title" style="margin:16px 0 10px;font-size:12px">Recent Meetings</div>
  <div id="dash-meetings"></div>
  <div class="section-title" style="margin:16px 0 10px;font-size:12px">Next Shows</div>
  <div id="dash-shows"></div>
</div>

<!-- SCHEDULE -->
<div class="section" id="sec-schedule">
  <div class="section-header">
    <div><div class="section-title">Schedule</div><div class="section-sub" id="schedule-range"></div></div>
    <div style="display:flex;gap:6px;align-items:center">
      <button class="btn btn-primary" onclick="openEventModal()">+ New Event</button>
      <button class="btn btn-sm" onclick="shiftWeek(-1)">‚óÄ Prev</button>
      <button class="btn btn-sm" onclick="goToday()">Today</button>
      <button class="btn btn-sm" onclick="shiftWeek(1)">Next ‚ñ∂</button>
      <select class="status-select" id="sched-filter-who" onchange="renderSchedule()">
        <option value="">Everyone</option>
        <option>Full Band</option><option>Sonia</option><option>Cam</option><option>Adam</option><option>G Money</option><option>Team</option>
      </select>
    </div>
  </div>
  <div id="schedule-list"></div>
</div>

<!-- TASKS -->
<div class="section" id="sec-tasks">
  <div class="section-header">
    <div><div class="section-title">Tasks</div><div class="section-sub" id="task-count"></div></div>
    <div style="display:flex;gap:6px;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="openTaskModal()">+ New Task</button>
      <select class="status-select" id="task-filter-status" onchange="renderTasks()">
        <option value="">All Status</option><option>To Do</option><option>In Progress</option><option>Blocked</option><option>Done</option>
      </select>
      <select class="status-select" id="task-filter-owner" onchange="renderTasks()">
        <option value="">All Owners</option>
      </select>
    </div>
  </div>
  <div id="task-list"></div>
</div>

<!-- MEETINGS -->
<div class="section" id="sec-meetings">
  <div class="section-header"><div class="section-title">Zoom Summaries</div></div>
  <div id="meeting-list"></div>
</div>

<!-- BUDGETS -->
<div class="section" id="sec-budgets">
  <div class="section-header"><div class="section-title">Budgets</div></div>
  <div id="budget-list"></div>
</div>

<!-- EXPENSES -->
<div class="section" id="sec-expenses">
  <div class="section-header">
    <div><div class="section-title">Expenses</div><div class="section-sub" id="expense-total"></div></div>
    <button class="btn btn-primary" onclick="openExpenseModal()">+ New Expense</button>
  </div>
  <div id="expense-list"></div>
</div>

<!-- MESSAGES -->
<div class="section" id="sec-messages">
  <div class="section-header">
    <div><div class="section-title">Messages</div><div class="section-sub" id="msg-count"></div></div>
    <button class="btn btn-primary" onclick="openMsgModal()">‚úâÔ∏è New Message</button>
  </div>
  <div id="msg-list"></div>
</div>

<!-- FILES -->
<div class="section" id="sec-files">
  <div class="section-header">
    <div><div class="section-title">Files</div><div class="section-sub" id="file-count"></div></div>
  </div>
  <div id="file-list"></div>
</div>

<!-- COMMISSIONS -->
<div class="section" id="sec-commissions">
  <div class="section-header">
    <div><div class="section-title">Commissions</div><div class="section-sub" id="comm-summary"></div></div>
  </div>
  <div id="comm-list"></div>
</div>

<!-- TOUR DATES -->
<div class="section" id="sec-tour">
  <div class="section-title" style="margin-bottom:4px">üé§ Upcoming Tour Dates</div>
  <div class="section-sub" id="tour-count" style="margin-bottom:12px"></div>
  <div id="upcoming-list"></div>
  <div class="section-title" style="margin:24px 0 4px">üìú Previous Plays</div>
  <div class="section-sub" id="past-count" style="margin-bottom:12px"></div>
  <div id="past-list"></div>
</div>

</div>
</div>

<!-- NEW EXPENSE MODAL -->
<div class="modal-overlay" id="expense-modal">
<div class="modal">
  <div class="modal-title">üßæ Submit Expense</div>
  <div class="form-row">
    <div class="form-group"><label>Description</label><input type="text" id="exp-desc" placeholder="What was it for?"/></div>
    <div class="form-group"><label>Amount ($)</label><input type="number" id="exp-amount" step="0.01" placeholder="0.00"/></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label>Date</label><input type="date" id="exp-date"/></div>
    <div class="form-group"><label>Category</label>
      <select id="exp-cat"><option value="">Select...</option>
        <option>Gas</option><option>Food</option><option>Lodging</option><option>Gear</option>
        <option>Merch Production</option><option>Promotion</option><option>Studio</option><option>Travel</option><option>Other</option>
      </select>
    </div>
  </div>
  <div class="form-group"><label>Budget</label><select id="exp-budget"><option value="">No budget</option></select></div>
  <div class="form-group"><label>Receipt Photo</label>
    <div class="file-drop" id="file-drop" onclick="document.getElementById('receipt-file').click()">
      üì∑ Click or drag receipt image here
      <input type="file" id="receipt-file" accept="image/*" onchange="handleFile(this)"/>
    </div>
    <div class="file-preview" id="file-preview" style="display:none"></div>
  </div>
  <div class="form-group"><label>Notes</label><textarea id="exp-notes" rows="2" placeholder="Optional notes..."></textarea></div>
  <div class="modal-actions">
    <button class="btn" onclick="closeExpenseModal()">Cancel</button>
    <button class="btn btn-primary" id="submit-exp-btn" onclick="submitExpense()">Submit Expense</button>
  </div>
</div>
</div>

<!-- NEW TASK MODAL -->
<div class="modal-overlay" id="task-modal">
<div class="modal">
  <div class="modal-title">‚úÖ New Task</div>
  <div class="form-group"><label>Task</label><input type="text" id="new-task-name" placeholder="What needs to be done?"/></div>
  <div class="form-row">
    <div class="form-group"><label>Priority</label>
      <select id="new-task-pri"><option value="üîµ Normal">üîµ Normal</option><option value="üî¥ Urgent">üî¥ Urgent</option><option value="üü° High">üü° High</option><option value="‚ö™ Low">‚ö™ Low</option></select>
    </div>
    <div class="form-group"><label>Category</label>
      <select id="new-task-cat"><option value="">Select...</option>
        <option>Booking</option><option>Marketing</option><option>Merch</option><option>Recording</option>
        <option>Admin</option><option>Sync/Licensing</option><option>Social Media</option><option>Touring/Logistics</option>
      </select>
    </div>
  </div>
  <div class="form-row">
    <div class="form-group"><label>Due Date</label><input type="date" id="new-task-due"/></div>
    <div class="form-group"><label>Source</label>
      <select id="new-task-source"><option value="Manual">Manual</option><option value="Zoom Call">Zoom Call</option><option value="Slack">Slack</option><option value="Email">Email</option></select>
    </div>
  </div>
  <div class="form-group"><label>Owners</label>
    <div id="new-task-owners" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px"></div>
  </div>
  <div class="form-group"><label>Notes</label><textarea id="new-task-notes" rows="2" placeholder="Additional details..."></textarea></div>
  <div class="modal-actions">
    <button class="btn" onclick="closeTaskModal()">Cancel</button>
    <button class="btn btn-primary" id="submit-task-btn" onclick="submitTask()">Create Task</button>
  </div>
</div>
</div>

<!-- NEW EVENT MODAL -->
<div class="modal-overlay" id="event-modal">
<div class="modal">
  <div class="modal-title">üìÖ New Event</div>
  <div class="form-group"><label>Event</label><input type="text" id="new-event-name" placeholder="What's happening?"/></div>
  <div class="form-row">
    <div class="form-group"><label>Date</label><input type="date" id="new-event-date"/></div>
    <div class="form-group"><label>Time</label><input type="text" id="new-event-time" placeholder="e.g. 2:00 PM"/></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label>Type</label>
      <select id="new-event-type"><option value="">Select...</option>
        <option>üé§ Show</option><option>üéôÔ∏è Interview</option><option>üì∞ Press</option><option>üéß Studio</option>
        <option>üì∏ Photo/Video</option><option>‚úàÔ∏è Travel</option><option>üìã Meeting</option><option>üì± Social Media</option>
        <option>üé∂ Rehearsal</option><option>‚è∞ Deadline</option><option>Other</option>
      </select>
    </div>
    <div class="form-group"><label>Status</label>
      <select id="new-event-status"><option>Confirmed</option><option>Tentative</option></select>
    </div>
  </div>
  <div class="form-group"><label>Location</label><input type="text" id="new-event-location" placeholder="Venue, address, or Zoom link"/></div>
  <div class="form-row">
    <div class="form-group"><label>Contact Name</label><input type="text" id="new-event-contact" placeholder="Who's the point person?"/></div>
    <div class="form-group"><label>Contact Email</label><input type="email" id="new-event-email" placeholder="their@email.com"/></div>
  </div>
  <div class="form-group"><label>Who</label>
    <div id="new-event-who" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px"></div>
  </div>
  <div class="form-group"><label>Details</label><textarea id="new-event-details" rows="2" placeholder="Additional details..."></textarea></div>
  <div class="form-group"><label>Link</label><input type="url" id="new-event-link" placeholder="https://..."/></div>
  <div class="modal-actions">
    <button class="btn" onclick="closeEventModal()">Cancel</button>
    <button class="btn btn-primary" id="submit-event-btn" onclick="submitEvent()">Create Event</button>
  </div>
</div>
</div>

<!-- NEW MESSAGE MODAL -->
<div class="modal-overlay" id="msg-modal">
<div class="modal">
  <div class="modal-title">‚úâÔ∏è Send Message</div>
  <div class="form-group"><label>Subject</label><input type="text" id="new-msg-subject" placeholder="What's this about?"/></div>
  <div class="form-group"><label>Message</label><textarea id="new-msg-body" rows="4" placeholder="Type your question or message..."></textarea></div>
  <div class="modal-actions">
    <button class="btn" onclick="closeMsgModal()">Cancel</button>
    <button class="btn btn-primary" id="submit-msg-btn" onclick="submitMessage()">Send Message</button>
  </div>
</div>
</div>

<!-- REPLY MODAL -->
<div class="modal-overlay" id="reply-modal">
<div class="modal">
  <div class="modal-title">üí¨ Reply</div>
  <div id="reply-original" style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:12px;font-size:13px;color:var(--dim)"></div>
  <div class="form-group"><label>Your Reply</label><textarea id="reply-body" rows="3" placeholder="Type your reply..."></textarea></div>
  <div class="modal-actions">
    <button class="btn" onclick="closeReplyModal()">Cancel</button>
    <button class="btn btn-primary" id="submit-reply-btn" onclick="submitReply()">Send Reply</button>
  </div>
</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
const B='appBeWOdb4dIuNKUW';
const TABLES={
  members:'tblDw4o3tg33nyarr',
  tasks:'tblVK1akI74xHQzy6',
  meetings:'tblzhv44VFpMs0OAE',
  budgets:'tblmxfYZXZm7kkfiB',
  expenses:'tblVIuml3R9vbLEe6',
  schedule:'tblhie72hn8n0rtJa',
  messages:'tblDNlpypycdkfS70',
  files:'tblJi8NGZFLMYeFNX',
  commissions:'tbljsK7LFd3GTZfh2',
  oc:'tblVSk34SJps918oF'
};
const HARDCODED_PAT='patPmozIwb4wwsnEc.9da045c85ac9055cf96c86d5deb92799f3d8f6cb561226db7a9ddc956eb4c42e';
const RECEIPT_FIELD='fldCkIFgaWzNMJulo';

let PAT='',currentUser=null,members=[],tasks=[],meetings=[],budgets=[],expenses=[],schedule=[],messages=[],files=[],commissions=[],upcomingShows=[],pastPlays=[];
let receiptFile=null;

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
async function loadMembers(){
  try{
    const recs=await fetchRecs(TABLES.members,['Name','Role','Login Code','Email','Active']);
    members=recs.filter(r=>r.fields['Active']).map(r=>({id:r.id,...r.fields}));
    const sel=document.getElementById('login-name');
    members.forEach(m=>{const o=document.createElement('option');o.value=m.Name;o.textContent=m.Name;sel.appendChild(o)});
  }catch(e){showLoginErr('Could not load team. Check PAT.')}
}

function doLogin(){
  const name=document.getElementById('login-name').value;
  const code=document.getElementById('login-code').value.trim();
  if(!name||!code){showLoginErr('Select name and enter code');return}
  const m=members.find(x=>x.Name===name&&x['Login Code']===code);
  if(!m){showLoginErr('Invalid code');return}
  currentUser=m;
  localStorage.setItem('wf_user',JSON.stringify({name:m.Name,code:m['Login Code']}));
  showApp();
}

function doLogout(){
  localStorage.removeItem('wf_user');
  currentUser=null;
  document.getElementById('app').style.display='none';
  document.getElementById('login').style.display='flex';
}

function showLoginErr(msg){const e=document.getElementById('login-err');e.textContent=msg;e.style.display='block'}

async function showApp(){
  document.getElementById('login').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('user-name').textContent=currentUser.Name;
  document.getElementById('user-role').textContent=currentUser.Role||'';
  await loadAllData();
  renderDashboard();
}

// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ
async function fetchRecs(tableId,fields,view){
  let all=[],offset=null;
  const fp=fields.map(f=>'fields[]='+encodeURIComponent(f)).join('&');
  do{
    let url=`https://api.airtable.com/v0/${B}/${tableId}?pageSize=100&${fp}`;
    if(view)url+='&view='+encodeURIComponent(view);
    if(offset)url+='&offset='+offset;
    const r=await fetch(url,{headers:{Authorization:'Bearer '+PAT}});
    if(!r.ok)throw new Error('API '+r.status);
    const d=await r.json();all=all.concat(d.records);offset=d.offset;
  }while(offset);
  return all;
}

async function loadAllData(){
  const showFields=['Date','Day of Week','Venue','Venue City','Venue ST','Billing','Artist Support To','Guarantee','Tickets Sold','Sellable','Promoter','Promoter Company','Promoter Email','Advance Contact','Advance Email','Advance Cell Phone','Marketing Contact','Marketing Email','Overage','Total Payout','Merch Sold','Merch PP','Status','Artist','Tix Sold'];
  const [t,m,b,e,s,msg,fl,comm,up,pp]=await Promise.all([
    fetchRecs(TABLES.tasks,['Task','Status','Priority','Owner','Owners','Category','Due Date','Source','Source Date','Notes','GitHub Issue']),
    fetchRecs(TABLES.meetings,['Meeting Title','Date','Attendees','Summary','Key Decisions','Action Items']),
    fetchRecs(TABLES.budgets,['Budget Name','Category','Total Budget','Status','Start Date','End Date','Notes']),
    fetchRecs(TABLES.expenses,['Description','Amount','Date','Paid By','Category','Budget','Receipt','Status','Notes']),
    fetchRecs(TABLES.schedule,['Event','Date','Time','Type','Location','Contact','Contact Email','Who','Details','Link','Status']),
    fetchRecs(TABLES.messages,['Subject','From','Date','Message','Status','Reply','Replied By']),
    fetchRecs(TABLES.files,['Title','Category','File','Uploaded By','Date','Notes','Notify']),
    fetchRecs(TABLES.commissions,['Description','Amount','Owed To','Status','Date Incurred','Date Paid','Payment Method','ACH / Transfer Notes','Supporting Doc','Notes']),
    fetchRecs(TABLES.oc,showFields,'WF - Upcoming Shows'),
    fetchRecs(TABLES.oc,showFields,'WF - Past Plays')
  ]);
  tasks=t.map(r=>({id:r.id,...r.fields}));
  meetings=m.map(r=>({id:r.id,...r.fields}));
  budgets=b.map(r=>({id:r.id,...r.fields}));
  expenses=e.map(r=>({id:r.id,...r.fields}));
  schedule=s.map(r=>({id:r.id,...r.fields}));
  messages=msg.map(r=>({id:r.id,...r.fields}));
  files=fl.map(r=>({id:r.id,...r.fields}));
  commissions=comm.map(r=>({id:r.id,...r.fields}));
  upcomingShows=up.map(r=>({id:r.id,...r.fields}));
  pastPlays=pp.map(r=>({id:r.id,...r.fields}));

  // Populate owner filter
  const owners=[...new Set(tasks.flatMap(t=>t.Owners||[]).filter(Boolean))];
  const sel=document.getElementById('task-filter-owner');
  sel.innerHTML='<option value="">All Owners</option>';
  owners.forEach(o=>{const op=document.createElement('option');op.value=o;op.textContent=o;sel.appendChild(op)});

  // Populate budget select in expense form
  const bsel=document.getElementById('exp-budget');
  bsel.innerHTML='<option value="">No budget</option>';
  budgets.filter(b=>b.Status==='Active').forEach(b=>{
    const op=document.createElement('option');op.value=b.id;op.textContent=b['Budget Name'];bsel.appendChild(op);
  });
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
function renderDashboard(){
  const myTasks=tasks.filter(t=>(t.Owners&&t.Owners.includes(currentUser.Name))||(!t.Owners||!t.Owners.length));
  const open=myTasks.filter(t=>t.Status!=='Done');
  const urgent=myTasks.filter(t=>t.Priority==='üî¥ Urgent'&&t.Status!=='Done');
  const totalExp=expenses.reduce((s,e)=>(s+(e.Amount||0)),0);
  const pendingExp=expenses.filter(e=>e.Status==='Pending').length;
  const isAdmin=currentUser.Role==='Admin'||currentUser.Role==='Management';
  const newMsgs=isAdmin?messages.filter(m=>m.Status==='New').length:messages.filter(m=>m.From===currentUser.Name&&m.Status==='Replied').length;
  const msgLabel=isAdmin?'New Messages':'Replies';

  document.getElementById('dash-stats').innerHTML=`
    <div class="card" style="text-align:center;border-color:var(--accent)30">
      <div style="font-size:28px;font-weight:700;color:var(--accent);font-family:'JetBrains Mono',monospace">${open.length}</div>
      <div style="font-size:11px;color:var(--dim)">Open Tasks</div>
    </div>
    <div class="card" style="text-align:center;border-color:${urgent.length?'var(--danger)30':'var(--border)'}">
      <div style="font-size:28px;font-weight:700;color:var(--danger);font-family:'JetBrains Mono',monospace">${urgent.length}</div>
      <div style="font-size:11px;color:var(--dim)">Urgent</div>
    </div>
    <div class="card" style="text-align:center;border-color:var(--accent2)30">
      <div style="font-size:28px;font-weight:700;color:var(--accent2);font-family:'JetBrains Mono',monospace">$${totalExp.toLocaleString('en-US',{minimumFractionDigits:0})}</div>
      <div style="font-size:11px;color:var(--dim)">Total Expenses</div>
    </div>
    <div class="card" style="text-align:center;border-color:var(--warn)30">
      <div style="font-size:28px;font-weight:700;color:var(--warn);font-family:'JetBrains Mono',monospace">${pendingExp}</div>
      <div style="font-size:11px;color:var(--dim)">Pending Receipts</div>
    </div>
    <div class="card" style="text-align:center;border-color:${newMsgs?'var(--accent)40':'var(--border)'}">
      <div style="font-size:28px;font-weight:700;color:var(--accent);font-family:'JetBrains Mono',monospace">${newMsgs}</div>
      <div style="font-size:11px;color:var(--dim)">${msgLabel}</div>
    </div>`;

  // Today's schedule
  const ds=document.getElementById('dash-schedule');
  const todayStr=new Date().toISOString().split('T')[0];
  const todayEvents=schedule.filter(s=>s.Date===todayStr&&s.Status!=='Cancelled').sort((a,b)=>(a.Time||'').localeCompare(b.Time||''));
  if(!todayEvents.length){ds.innerHTML='<div class="empty" style="padding:16px"><div class="icon">üìÖ</div><p>Nothing on the calendar today</p></div>';
  }else{ds.innerHTML=todayEvents.map(e=>schedCard(e)).join('')}

  // Open tasks (yours)
  const dt=document.getElementById('dash-tasks');
  if(!open.length){dt.innerHTML='<div class="empty" style="padding:16px"><div class="icon">üéâ</div><p>All caught up!</p></div>';
  }else{
    dt.innerHTML=open.sort(priSort).slice(0,5).map(t=>taskCard(t)).join('');
  }

  // All open tasks
  const dat=document.getElementById('dash-all-tasks');
  const allOpen=tasks.filter(t=>t.Status!=='Done').sort(priSort);
  if(!allOpen.length){dat.innerHTML='<div class="empty" style="padding:16px"><div class="icon">üéâ</div><p>All tasks complete!</p></div>';
  }else{
    dat.innerHTML=allOpen.map(t=>taskCard(t)).join('');
  }

  // Recent meetings
  const dm=document.getElementById('dash-meetings');
  const recent=meetings.sort((a,b)=>new Date(b.Date||0)-new Date(a.Date||0)).slice(0,3);
  if(!recent.length){dm.innerHTML='<div class="empty"><div class="icon">üé•</div><p>No meetings yet</p></div>';
  }else{dm.innerHTML=recent.map(m=>meetingCard(m,true)).join('')}

  // Next shows
  const dsh=document.getElementById('dash-shows');
  const nextShows=upcomingShows.filter(s=>s.Artist==='Weakened Friends').sort((a,b)=>new Date(a.Date||0)-new Date(b.Date||0)).slice(0,5);
  if(!nextShows.length){dsh.innerHTML='<div class="empty"><div class="icon">üé§</div><p>No upcoming shows</p></div>';
  }else{dsh.innerHTML=nextShows.map(s=>showCard(s,false)).join('')}
}

// ‚îÄ‚îÄ TASKS ‚îÄ‚îÄ
function renderTasks(){
  const fs=document.getElementById('task-filter-status').value;
  const fo=document.getElementById('task-filter-owner').value;
  let f=tasks;
  if(fs)f=f.filter(t=>t.Status===fs);
  if(fo)f=f.filter(t=>t.Owners&&t.Owners.includes(fo));
  f.sort(priSort);
  document.getElementById('task-count').textContent=f.length+' tasks';
  const list=document.getElementById('task-list');
  if(!f.length){list.innerHTML='<div class="empty"><div class="icon">‚úÖ</div><p>No tasks match filters</p></div>';return}
  list.innerHTML=f.map(t=>taskCard(t)).join('');
}

function taskCard(t){
  const sc=statusClass(t.Status),pc=priClass(t.Priority);
  const due=t['Due Date']?fmtDate(t['Due Date']):'';
  const overdue=t['Due Date']&&t.Status!=='Done'&&new Date(t['Due Date'])<new Date();
  const owners=t.Owners||[];
  const ownerLabel=owners.length?owners.join(', '):'TBD';
  const allChoices=[...members.map(m=>m.Name),'Team','Band','TBD'];
  const checkboxes=allChoices.map(c=>'<label><input type="checkbox" '+(owners.includes(c)?'checked':'')+' onchange="toggleOwner(\''+t.id+'\',\''+esc(c)+'\',this.checked)"/> '+esc(c)+'</label>').join('');
  return`<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;flex-wrap:wrap">
      <div class="card-title" style="flex:1;min-width:200px">${esc(t.Task||'Untitled')}</div>
      <div style="display:flex;gap:4px;flex-wrap:wrap">
        <div class="owner-picker">
          <div class="owner-btn" onclick="this.nextElementSibling.classList.toggle('open')">${esc(ownerLabel)}</div>
          <div class="owner-dropdown">${checkboxes}</div>
        </div>
        <select class="status-select" onchange="updateTaskStatus('${t.id}',this.value)">
          <option ${t.Status==='To Do'?'selected':''}>To Do</option>
          <option ${t.Status==='In Progress'?'selected':''}>In Progress</option>
          <option ${t.Status==='Blocked'?'selected':''}>Blocked</option>
          <option ${t.Status==='Done'?'selected':''}>Done</option>
        </select>
      </div>
    </div>
    <div class="card-meta">
      <span class="badge ${sc}">${t.Status||'To Do'}</span>
      <span class="badge ${pc}">${t.Priority||'Normal'}</span>
      ${t.Category?'<span class="badge b-category">'+esc(t.Category)+'</span>':''}
      ${owners.map(o=>'<span class="badge" style="background:var(--accent2)15;color:var(--accent2)">'+esc(o)+'</span>').join('')}
      ${due?'<span class="badge" style="background:'+(overdue?'var(--danger)20;color:var(--danger)':'var(--border);color:var(--dim)')+'">üìÖ '+due+'</span>':''}
    </div>
    ${t.Notes?'<div style="font-size:12px;color:var(--dim);margin-top:4px;white-space:pre-wrap;max-height:60px;overflow:hidden">'+esc(t.Notes)+'</div>':''}
    <div class="comment-box">
      <textarea placeholder="Add a note..." id="note-${t.id}">${esc(t.Notes||'')}</textarea>
      <div class="actions"><button class="btn btn-sm btn-success" onclick="saveTaskNote('${t.id}')">üíæ Save Note</button></div>
    </div>
  </div>`;
}

async function updateTaskStatus(id,status){
  try{
    await fetch(`https://api.airtable.com/v0/${B}/${TABLES.tasks}/${id}`,{
      method:'PATCH',headers:{Authorization:'Bearer '+PAT,'Content-Type':'application/json'},
      body:JSON.stringify({fields:{Status:status}})
    });
    const t=tasks.find(x=>x.id===id);if(t)t.Status=status;
    toast('Status updated ‚úì');
    renderDashboard();
  }catch(e){toast('Error updating status','error')}
}

async function updateTaskField(id,field,value){
  try{
    await fetch(`https://api.airtable.com/v0/${B}/${TABLES.tasks}/${id}`,{
      method:'PATCH',headers:{Authorization:'Bearer '+PAT,'Content-Type':'application/json'},
      body:JSON.stringify({fields:{[field]:value}})
    });
    const t=tasks.find(x=>x.id===id);if(t)t[field]=value;
    toast(field+' updated ‚úì');
  }catch(e){toast('Error updating '+field,'error')}
}

async function toggleOwner(id,name,checked){
  const t=tasks.find(x=>x.id===id);if(!t)return;
  let owners=t.Owners?[...t.Owners]:[];
  if(checked&&!owners.includes(name))owners.push(name);
  if(!checked)owners=owners.filter(o=>o!==name);
  try{
    await fetch(`https://api.airtable.com/v0/${B}/${TABLES.tasks}/${id}`,{
      method:'PATCH',headers:{Authorization:'Bearer '+PAT,'Content-Type':'application/json'},
      body:JSON.stringify({fields:{Owners:owners}})
    });
    t.Owners=owners;
    // Re-render the owner button label
    const cards=document.querySelectorAll('.owner-btn');
    toast('Owners updated ‚úì');
  }catch(e){toast('Error updating owners','error')}
}

async function saveTaskNote(id){
  const el=document.getElementById('note-'+id);if(!el)return;
  try{
    await fetch(`https://api.airtable.com/v0/${B}/${TABLES.tasks}/${id}`,{
      method:'PATCH',headers:{Authorization:'Bearer '+PAT,'Content-Type':'application/json'},
      body:JSON.stringify({fields:{Notes:el.value}})
    });
    const t=tasks.find(x=>x.id===id);if(t)t.Notes=el.value;
    toast('Note saved ‚úì');
  }catch(e){toast('Error saving note','error')}
}

// ‚îÄ‚îÄ MEETINGS ‚îÄ‚îÄ
function renderMeetings(){
  const sorted=meetings.sort((a,b)=>new Date(b.Date||0)-new Date(a.Date||0));
  const list=document.getElementById('meeting-list');
  if(!sorted.length){list.innerHTML='<div class="empty"><div class="icon">üé•</div><p>No meeting summaries yet</p></div>';return}
  list.innerHTML=sorted.map(m=>meetingCard(m)).join('');
}

function meetingCard(m,compact){
  const id='mtg-'+m.id;
  return`<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="document.getElementById('${id}').classList.toggle('open')">
      <div>
        <div class="card-title">${esc(m['Meeting Title']||'Meeting')}</div>
        <div class="card-meta">
          ${m.Date?'<span class="badge" style="background:var(--border);color:var(--dim)">'+fmtDate(m.Date)+'</span>':''}
          ${m.Attendees?'<span style="font-size:11px;color:var(--dim)">'+esc(m.Attendees)+'</span>':''}
        </div>
      </div>
      <span style="color:var(--dim);font-size:18px">‚ñæ</span>
    </div>
    <div class="meeting-expand" id="${id}">
      ${m.Summary?'<div style="margin-top:12px"><div style="font-family:\'JetBrains Mono\',monospace;font-size:9px;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Summary</div><div style="font-size:13px;color:var(--text);line-height:1.6;white-space:pre-wrap">'+esc(m.Summary)+'</div></div>':''}
      ${m['Key Decisions']?'<div style="margin-top:12px"><div style="font-family:\'JetBrains Mono\',monospace;font-size:9px;color:var(--accent2);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Key Decisions</div><div style="font-size:13px;line-height:1.6;white-space:pre-wrap">'+esc(m['Key Decisions'])+'</div></div>':''}
      ${m['Action Items']?'<div style="margin-top:12px"><div style="font-family:\'JetBrains Mono\',monospace;font-size:9px;color:var(--warn);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Action Items</div><div style="font-size:13px;line-height:1.6;white-space:pre-wrap">'+esc(m['Action Items'])+'</div></div>':''}
    </div>
  </div>`;
}

// ‚îÄ‚îÄ BUDGETS ‚îÄ‚îÄ
function renderBudgets(){
  const list=document.getElementById('budget-list');
  const sorted=budgets.sort((a,b)=>(a.Status==='Active'?0:1)-(b.Status==='Active'?0:1));
  if(!sorted.length){list.innerHTML='<div class="empty"><div class="icon">üí∞</div><p>No budgets yet</p></div>';return}
  list.innerHTML=sorted.map(b=>{
    const total=b['Total Budget']||0;
    const spent=expenses.filter(e=>e.Budget&&e.Budget.includes(b.id)).reduce((s,e)=>s+(e.Amount||0),0);
    const pct=total?Math.min((spent/total)*100,100):0;
    const color=pct>90?'var(--danger)':pct>70?'var(--warn)':'var(--accent2)';
    const sc=b.Status==='Active'?'b-active':b.Status==='Draft'?'b-draft':'b-closed';
    return`<div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div class="card-title">${esc(b['Budget Name']||'Budget')}</div>
        <span class="badge ${sc}">${b.Status||'Draft'}</span>
      </div>
      <div class="card-meta">
        ${b.Category?'<span class="badge b-category">'+esc(b.Category)+'</span>':''}
        ${b['Start Date']?'<span style="font-size:11px;color:var(--dim)">'+fmtDate(b['Start Date'])+' ‚Üí '+(b['End Date']?fmtDate(b['End Date']):'TBD')+'</span>':''}
      </div>
      <div style="display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:12px;margin-top:8px">
        <span style="color:var(--dim)">Spent: <span style="color:${color};font-weight:700">$${spent.toLocaleString('en-US',{minimumFractionDigits:2})}</span></span>
        <span style="color:var(--dim)">Budget: <span style="color:var(--text);font-weight:700">$${total.toLocaleString('en-US',{minimumFractionDigits:2})}</span></span>
      </div>
      <div class="budget-bar"><div class="budget-fill" style="width:${pct}%;background:${color}"></div></div>
      ${b.Notes?'<div style="font-size:11px;color:var(--dim);margin-top:6px">'+esc(b.Notes)+'</div>':''}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ EXPENSES ‚îÄ‚îÄ
function renderExpenses(){
  const sorted=expenses.sort((a,b)=>new Date(b.Date||0)-new Date(a.Date||0));
  const total=sorted.reduce((s,e)=>s+(e.Amount||0),0);
  document.getElementById('expense-total').textContent='Total: $'+total.toLocaleString('en-US',{minimumFractionDigits:2});
  const list=document.getElementById('expense-list');
  if(!sorted.length){list.innerHTML='<div class="empty"><div class="icon">üßæ</div><p>No expenses yet. Submit one!</p></div>';return}
  list.innerHTML=sorted.map(e=>{
    const sc=e.Status==='Pending'?'b-pending':e.Status==='Approved'?'b-approved':e.Status==='Rejected'?'b-rejected':'b-reimbursed';
    const receipt=e.Receipt&&e.Receipt.length?e.Receipt[0]:null;
    return`<div class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="card-title">${esc(e.Description||'Expense')}</div>
          <div class="card-meta">
            <span class="badge ${sc}">${e.Status||'Pending'}</span>
            ${e.Category?'<span class="badge b-category">'+esc(e.Category)+'</span>':''}
            ${e['Paid By']?'<span style="font-size:11px;color:var(--dim)">Paid by '+esc(e['Paid By'])+'</span>':''}
            ${e.Date?'<span style="font-size:11px;color:var(--dim)">'+fmtDate(e.Date)+'</span>':''}
          </div>
        </div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:700;color:var(--accent)">$${(e.Amount||0).toFixed(2)}</div>
      </div>
      ${receipt?'<div style="margin-top:8px"><a href="'+esc(receipt.url)+'" target="_blank" style="color:var(--accent2);font-size:11px;font-family:\'JetBrains Mono\',monospace">üì∑ View Receipt</a></div>':''}
      ${e.Notes?'<div style="font-size:12px;color:var(--dim);margin-top:4px">'+esc(e.Notes)+'</div>':''}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ EXPENSE FORM ‚îÄ‚îÄ
function openExpenseModal(){
  document.getElementById('expense-modal').classList.add('open');
  document.getElementById('exp-date').value=new Date().toISOString().split('T')[0];
  receiptFile=null;
  document.getElementById('file-preview').style.display='none';
}
function closeExpenseModal(){
  document.getElementById('expense-modal').classList.remove('open');
  document.getElementById('exp-desc').value='';
  document.getElementById('exp-amount').value='';
  document.getElementById('exp-cat').value='';
  document.getElementById('exp-budget').value='';
  document.getElementById('exp-notes').value='';
  document.getElementById('receipt-file').value='';
  receiptFile=null;
}

function handleFile(input){
  const file=input.files[0];if(!file)return;
  receiptFile=file;
  const prev=document.getElementById('file-preview');
  prev.style.display='flex';
  if(file.type.startsWith('image/')){
    const url=URL.createObjectURL(file);
    prev.innerHTML='<img src="'+url+'"/><div class="fn">'+esc(file.name)+' ('+Math.round(file.size/1024)+'KB)</div>';
  }else{
    prev.innerHTML='<div class="fn">üìé '+esc(file.name)+' ('+Math.round(file.size/1024)+'KB)</div>';
  }
}

// Drag and drop
const fd=document.getElementById('file-drop');
fd.addEventListener('dragover',e=>{e.preventDefault();fd.classList.add('dragover')});
fd.addEventListener('dragleave',()=>fd.classList.remove('dragover'));
fd.addEventListener('drop',e=>{e.preventDefault();fd.classList.remove('dragover');
  if(e.dataTransfer.files.length){document.getElementById('receipt-file').files=e.dataTransfer.files;handleFile(document.getElementById('receipt-file'))}
});

async function submitExpense(){
  const desc=document.getElementById('exp-desc').value.trim();
  const amount=parseFloat(document.getElementById('exp-amount').value);
  if(!desc||!amount){toast('Need description and amount','error');return}

  const btn=document.getElementById('submit-exp-btn');
  btn.textContent='Submitting...';btn.disabled=true;

  const fields={
    Description:desc,
    Amount:amount,
    Date:document.getElementById('exp-date').value||undefined,
    'Paid By':currentUser.Name,
    Category:document.getElementById('exp-cat').value||undefined,
    Notes:document.getElementById('exp-notes').value||undefined,
    Status:'Pending'
  };
  const budgetId=document.getElementById('exp-budget').value;
  if(budgetId)fields.Budget=[budgetId];

  try{
    // Create the expense record
    const r=await fetch(`https://api.airtable.com/v0/${B}/${TABLES.expenses}`,{
      method:'POST',headers:{Authorization:'Bearer '+PAT,'Content-Type':'application/json'},
      body:JSON.stringify({fields})
    });
    if(!r.ok)throw new Error('Failed to create expense');
    const rec=await r.json();

    // Upload receipt if present
    if(receiptFile){
      try{
        const formData=new FormData();
        formData.append('file',receiptFile);
        const uploadR=await fetch(`https://content.airtable.com/v0/${B}/${TABLES.expenses}/${rec.id}/${RECEIPT_FIELD}/uploadAttachment`,{
          method:'POST',headers:{Authorization:'Bearer '+PAT},body:formData
        });
        if(!uploadR.ok)toast('Expense saved but receipt upload failed ‚Äî add receipt in Airtable','error');
      }catch(e){toast('Expense saved but receipt upload failed ‚Äî add receipt in Airtable','error')}
    }

    expenses.push({id:rec.id,...fields});
    closeExpenseModal();renderExpenses();renderDashboard();
    toast('Expense submitted ‚úì');
  }catch(e){toast('Error: '+e.message,'error')}
  btn.textContent='Submit Expense';btn.disabled=false;
}

// ‚îÄ‚îÄ TOUR DATES ‚îÄ‚îÄ
function renderTour(){
  // Upcoming
  const upcoming=upcomingShows.filter(s=>s.Artist==='Weakened Friends').sort((a,b)=>new Date(a.Date||0)-new Date(b.Date||0));
  document.getElementById('tour-count').textContent=upcoming.length+' upcoming shows';
  const ul=document.getElementById('upcoming-list');
  if(!upcoming.length){ul.innerHTML='<div class="empty"><div class="icon">üé§</div><p>No upcoming shows</p></div>';}
  else{ul.innerHTML=upcoming.map(s=>showCard(s,false)).join('')}

  // Past
  const past=pastPlays.filter(s=>s.Artist==='Weakened Friends'&&s.Date).sort((a,b)=>new Date(b.Date||0)-new Date(a.Date||0));
  document.getElementById('past-count').textContent=past.length+' past shows';
  const pl=document.getElementById('past-list');
  if(!past.length){pl.innerHTML='<div class="empty"><div class="icon">üìú</div><p>No past plays found</p></div>';}
  else{pl.innerHTML=past.map(s=>showCard(s,true)).join('')}
}

function showCard(s,isPast){
  const d=s.Date?new Date(s.Date+'T12:00:00'):null;
  const dateStr=d?d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'}):'TBD';
  const billing=s.Billing||'';
  const isSupport=billing.toLowerCase().includes('support')||billing.includes('1st of')||billing.includes('2nd of')||billing.includes('3rd of');
  const billingColor=billing==='Headline'?'var(--accent)':isSupport?'var(--accent2)':'var(--warn)';
  const tixSold=s['Tix Sold']||s['Tickets Sold']||0;
  const sellable=s.Sellable||0;
  const pctSold=sellable>0?Math.round((tixSold/sellable)*100):0;
  const pctColor=pctSold>=80?'var(--accent2)':pctSold>=50?'var(--warn)':'var(--dim)';

  let details=`<div class="show-details" style="display:none;margin-top:10px;padding:10px;background:var(--bg);border-radius:6px">`;
  // Contacts
  details+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">`;
  if(s.Promoter)details+=`<div><span style="color:var(--dim)">Promoter:</span> ${esc(s.Promoter)}</div>`;
  if(s['Promoter Company'])details+=`<div><span style="color:var(--dim)">Company:</span> ${esc(s['Promoter Company'])}</div>`;
  if(s['Promoter Email'])details+=`<div><span style="color:var(--dim)">Promoter Email:</span> <a href="mailto:${esc(s['Promoter Email'])}" style="color:var(--accent2)">${esc(s['Promoter Email'])}</a></div>`;
  if(s['Advance Contact'])details+=`<div><span style="color:var(--dim)">Advance:</span> ${esc(s['Advance Contact'])}</div>`;
  if(s['Advance Email'])details+=`<div><span style="color:var(--dim)">Advance Email:</span> <a href="mailto:${esc(s['Advance Email'])}" style="color:var(--accent2)">${esc(s['Advance Email'])}</a></div>`;
  if(s['Advance Cell Phone'])details+=`<div><span style="color:var(--dim)">Advance Cell:</span> <a href="tel:${esc(s['Advance Cell Phone'])}" style="color:var(--accent2)">${esc(s['Advance Cell Phone'])}</a></div>`;
  if(s['Marketing Contact'])details+=`<div><span style="color:var(--dim)">Marketing:</span> ${esc(s['Marketing Contact'])}</div>`;
  if(s['Marketing Email'])details+=`<div><span style="color:var(--dim)">Marketing Email:</span> <a href="mailto:${esc(s['Marketing Email'])}" style="color:var(--accent2)">${esc(s['Marketing Email'])}</a></div>`;
  details+=`</div></div>`;

  return`<div class="card" style="border-left:3px solid ${billingColor};cursor:pointer" onclick="this.querySelector('.show-details').style.display=this.querySelector('.show-details').style.display==='none'?'block':'none'">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px">
      <div style="flex:1;min-width:200px">
        <div style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--accent);font-weight:600">${dateStr}</div>
        <div class="card-title" style="margin:2px 0">${esc(s.Venue||'TBD')}</div>
        <div style="font-size:12px;color:var(--dim)">${esc(s['Venue City']||'')}${s['Venue ST']?', '+esc(s['Venue ST']):''}</div>
      </div>
      <div style="text-align:right">
        <div><span class="badge" style="background:${billingColor}20;color:${billingColor}">${esc(billing)}</span></div>
        ${isSupport&&s['Artist Support To']?'<div style="font-size:11px;color:var(--dim);margin-top:2px">w/ '+esc(s['Artist Support To'])+'</div>':''}
      </div>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:12px;margin-top:8px;font-family:'JetBrains Mono',monospace;font-size:12px">
      <div><span style="color:var(--dim)">Guarantee:</span> <span style="color:var(--accent2);font-weight:600">$${(s.Guarantee||0).toLocaleString()}</span></div>
      ${isPast&&s.Overage?'<div><span style="color:var(--dim)">Overage:</span> <span style="color:var(--accent2)">$'+(s.Overage||0).toLocaleString()+'</span></div>':''}
      ${isPast&&s['Total Payout']?'<div><span style="color:var(--dim)">Total Paid:</span> <span style="color:var(--accent);font-weight:700">$'+(s['Total Payout']||0).toLocaleString()+'</span></div>':''}
      <div><span style="color:var(--dim)">Tix Sold:</span> <span style="color:${pctColor};font-weight:600">${tixSold}</span><span style="color:var(--border)"> / ${sellable}</span></div>
      ${!isPast&&sellable>0?'<div style="background:var(--surface2);padding:1px 6px;border-radius:3px"><span style="color:'+pctColor+'">'+pctSold+'% sold</span></div>':''}
      ${isPast&&s['Merch Sold']?'<div><span style="color:var(--dim)">Merch:</span> <span style="color:var(--warn)">$'+(s['Merch Sold']||0).toLocaleString()+'</span></div>':''}
      ${isPast&&s['Merch PP']&&typeof s['Merch PP']==='number'&&isFinite(s['Merch PP'])?'<div><span style="color:var(--dim)">Merch PP:</span> $'+s['Merch PP'].toFixed(2)+'</div>':''}
    </div>
    ${details}
    <div style="text-align:center;margin-top:6px;font-size:10px;color:var(--border);font-family:'JetBrains Mono',monospace">TAP FOR CONTACTS ‚ñæ</div>
  </div>`;
}

// ‚îÄ‚îÄ FILES ‚îÄ‚îÄ
function renderFiles(){
  const sorted=files.sort((a,b)=>new Date(b.Date||0)-new Date(a.Date||0));
  document.getElementById('file-count').textContent=sorted.length+' files';
  const list=document.getElementById('file-list');
  if(!sorted.length){list.innerHTML='<div class="empty"><div class="icon">üìÅ</div><p>No files shared yet</p></div>';return}
  list.innerHTML=sorted.map(f=>{
    const catColors={'Commission':'var(--accent2)','Contract':'var(--info)','Tax/Financial':'var(--warn)','Tour Info':'var(--accent)','Merch':'#ec4899','General':'var(--dim)'};
    const color=catColors[f.Category]||'var(--dim)';
    const fileList=f.File&&f.File.length?f.File:[];
    return`<div class="card" style="border-left:3px solid ${color}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="card-title">${esc(f.Title||'Untitled')}</div>
          <div class="card-meta">
            ${f.Category?'<span class="badge" style="background:'+color+'20;color:'+color+'">'+esc(f.Category)+'</span>':''}
            ${f['Uploaded By']?'<span style="font-size:11px;color:var(--dim)">from '+esc(f['Uploaded By'])+'</span>':''}
            ${f.Date?'<span style="font-size:11px;color:var(--dim)">'+fmtDate(f.Date)+'</span>':''}
            ${f.Notify?'<span class="badge b-urgent">NEW</span>':''}
          </div>
        </div>
      </div>
      ${f.Notes?'<div style="font-size:12px;color:var(--dim);margin-top:6px;white-space:pre-wrap">'+esc(f.Notes)+'</div>':''}
      ${fileList.length?'<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px">'+fileList.map(a=>'<a href="'+esc(a.url)+'" target="_blank" class="btn btn-sm" style="border-color:'+color+';color:'+color+'">üì• '+esc(a.filename||'Download')+'</a>').join('')+'</div>':''}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ COMMISSIONS ‚îÄ‚îÄ
function renderCommissions(){
  const sorted=commissions.sort((a,b)=>{const so={'Owed':0,'Processing':1,'Paid':2};return(so[a.Status]||0)-(so[b.Status]||0)});
  const owed=commissions.filter(c=>c.Status==='Owed').reduce((s,c)=>s+(c.Amount||0),0);
  const paid=commissions.filter(c=>c.Status==='Paid').reduce((s,c)=>s+(c.Amount||0),0);
  document.getElementById('comm-summary').textContent='Owed: $'+owed.toLocaleString('en-US',{minimumFractionDigits:2})+' ¬∑ Paid: $'+paid.toLocaleString('en-US',{minimumFractionDigits:2});
  const list=document.getElementById('comm-list');
  if(!sorted.length){list.innerHTML='<div class="empty"><div class="icon">üí∏</div><p>No commissions tracked yet</p></div>';return}
  list.innerHTML=sorted.map(c=>{
    const sc=c.Status==='Owed'?'b-urgent':c.Status==='Processing'?'b-pending':'b-done';
    const color=c.Status==='Owed'?'var(--danger)':c.Status==='Processing'?'var(--warn)':'var(--accent2)';
    const docs=c['Supporting Doc']&&c['Supporting Doc'].length?c['Supporting Doc']:[];
    return`<div class="card" style="border-left:3px solid ${color}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="card-title">${esc(c.Description||'Commission')}</div>
          <div class="card-meta">
            <span class="badge ${sc}">${c.Status||'Owed'}</span>
            ${c['Payment Method']?'<span class="badge" style="background:var(--info)20;color:var(--info)">'+esc(c['Payment Method'])+'</span>':''}
            ${c['Owed To']?'<span style="font-size:11px;color:var(--dim)">‚Üí '+esc(c['Owed To'])+'</span>':''}
            ${c['Date Incurred']?'<span style="font-size:11px;color:var(--dim)">Incurred: '+fmtDate(c['Date Incurred'])+'</span>':''}
            ${c['Date Paid']?'<span style="font-size:11px;color:var(--accent2)">Paid: '+fmtDate(c['Date Paid'])+'</span>':''}
          </div>
        </div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:700;color:${color}">$${(c.Amount||0).toFixed(2)}</div>
      </div>
      ${c['ACH / Transfer Notes']?'<div style="margin-top:8px;padding:8px;background:var(--bg);border-radius:6px;border-left:3px solid var(--info)"><div style="font-family:\'JetBrains Mono\',monospace;font-size:9px;color:var(--info);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">ACH / Transfer Info</div><div style="font-size:12px;color:var(--text);white-space:pre-wrap;font-family:\'JetBrains Mono\',monospace">'+esc(c['ACH / Transfer Notes'])+'</div></div>':''}
      ${c.Notes?'<div style="font-size:12px;color:var(--dim);margin-top:6px;white-space:pre-wrap">'+esc(c.Notes)+'</div>':''}
      ${docs.length?'<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px">'+docs.map(a=>'<a href="'+esc(a.url)+'" target="_blank" class="btn btn-sm" style="border-color:var(--accent2);color:var(--accent2)">üì• '+esc(a.filename||'Document')+'</a>').join('')+'</div>':''}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ
let replyingTo=null;
function renderMessages(){
  const isAdmin=currentUser.Role==='Admin'||currentUser.Role==='Management';
  const sorted=messages.sort((a,b)=>new Date(b.Date||0)-new Date(a.Date||0));
  const filtered=isAdmin?sorted:sorted.filter(m=>m.From===currentUser.Name);
  const newCount=filtered.filter(m=>m.Status==='New').length;
  document.getElementById('msg-count').textContent=filtered.length+' messages'+(newCount?' ¬∑ '+newCount+' new':'');
  const list=document.getElementById('msg-list');
  if(!filtered.length){list.innerHTML='<div class="empty"><div class="icon">üí¨</div><p>No messages yet</p></div>';return}
  list.innerHTML=filtered.map(m=>{
    const isNew=m.Status==='New';
    const sc=m.Status==='New'?'b-urgent':m.Status==='Read'?'b-pending':m.Status==='Replied'?'b-done':'b-low';
    return`<div class="card" style="${isNew?'border-color:var(--accent)40':''}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="card-title">${esc(m.Subject||'No subject')}</div>
          <div class="card-meta">
            <span class="badge" style="background:var(--accent2)15;color:var(--accent2)">${esc(m.From)}</span>
            <span class="badge ${sc}">${m.Status||'New'}</span>
            ${m.Date?'<span style="font-size:11px;color:var(--dim)">'+new Date(m.Date).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'})+'</span>':''}
          </div>
        </div>
        ${isAdmin&&m.Status!=='Replied'?'<button class="btn btn-sm btn-success" onclick="openReplyModal(\''+m.id+'\')">Reply</button>':''}
      </div>
      <div style="font-size:13px;color:var(--text);margin-top:8px;white-space:pre-wrap;line-height:1.5">${esc(m.Message)}</div>
      ${m.Reply?'<div style="margin-top:10px;padding:10px;background:var(--bg);border-radius:6px;border-left:3px solid var(--accent2)"><div style="font-family:\'JetBrains Mono\',monospace;font-size:9px;color:var(--accent2);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Reply from '+esc(m['Replied By']||'Management')+'</div><div style="font-size:13px;color:var(--text);white-space:pre-wrap;line-height:1.5">'+esc(m.Reply)+'</div></div>':''}
    </div>`;
  }).join('');
}

function openMsgModal(){document.getElementById('msg-modal').classList.add('open')}
function closeMsgModal(){
  document.getElementById('msg-modal').classList.remove('open');
  document.getElementById('new-msg-subject').value='';
  document.getElementById('new-msg-body').value='';
}

async function submitMessage(){
  const subject=document.getElementById('new-msg-subject').value.trim();
  const body=document.getElementById('new-msg-body').value.trim();
  if(!subject||!body){toast('Need subject and message','error');return}
  const btn=document.getElementById('submit-msg-btn');btn.textContent='Sending...';btn.disabled=true;
  const fields={
    Subject:subject,
    From:currentUser.Name,
    Date:new Date().toISOString(),
    Message:body,
    Status:'New'
  };
  try{
    const r=await fetch(`https://api.airtable.com/v0/${B}/${TABLES.messages}`,{
      method:'POST',headers:{Authorization:'Bearer '+PAT,'Content-Type':'application/json'},
      body:JSON.stringify({fields})
    });
    if(!r.ok)throw new Error('Failed');
    const rec=await r.json();
    messages.push({id:rec.id,...fields});
    closeMsgModal();renderMessages();
    toast('Message sent ‚úì');
  }catch(e){toast('Error: '+e.message,'error')}
  btn.textContent='Send Message';btn.disabled=false;
}

function openReplyModal(id){
  const m=messages.find(x=>x.id===id);if(!m)return;
  replyingTo=id;
  document.getElementById('reply-original').innerHTML='<strong>'+esc(m.Subject)+'</strong> from '+esc(m.From)+'<br><br>'+esc(m.Message);
  document.getElementById('reply-modal').classList.add('open');
}
function closeReplyModal(){document.getElementById('reply-modal').classList.remove('open');document.getElementById('reply-body').value='';replyingTo=null}

async function submitReply(){
  if(!replyingTo)return;
  const body=document.getElementById('reply-body').value.trim();
  if(!body){toast('Need a reply','error');return}
  const btn=document.getElementById('submit-reply-btn');btn.textContent='Sending...';btn.disabled=true;
  try{
    await fetch(`https://api.airtable.com/v0/${B}/${TABLES.messages}/${replyingTo}`,{
      method:'PATCH',headers:{Authorization:'Bearer '+PAT,'Content-Type':'application/json'},
      body:JSON.stringify({fields:{Reply:body,'Replied By':currentUser.Name,Status:'Replied'}})
    });
    const m=messages.find(x=>x.id===replyingTo);
    if(m){m.Reply=body;m['Replied By']=currentUser.Name;m.Status='Replied'}
    closeReplyModal();renderMessages();
    toast('Reply sent ‚úì');
  }catch(e){toast('Error: '+e.message,'error')}
  btn.textContent='Send Reply';btn.disabled=false;
}

// ‚îÄ‚îÄ NEW TASK MODAL ‚îÄ‚îÄ
function openTaskModal(){
  document.getElementById('task-modal').classList.add('open');
  const cont=document.getElementById('new-task-owners');
  const allChoices=[...members.map(m=>m.Name),'Team','Band'];
  cont.innerHTML=allChoices.map(c=>'<label style="display:flex;align-items:center;gap:4px;background:var(--bg);padding:3px 8px;border-radius:4px;font-size:11px;cursor:pointer"><input type="checkbox" class="new-task-owner-cb" value="'+esc(c)+'"/> '+esc(c)+'</label>').join('');
}
function closeTaskModal(){
  document.getElementById('task-modal').classList.remove('open');
  document.getElementById('new-task-name').value='';
  document.getElementById('new-task-pri').value='üîµ Normal';
  document.getElementById('new-task-cat').value='';
  document.getElementById('new-task-due').value='';
  document.getElementById('new-task-notes').value='';
}
async function submitTask(){
  const name=document.getElementById('new-task-name').value.trim();
  if(!name){toast('Need a task name','error');return}
  const btn=document.getElementById('submit-task-btn');btn.textContent='Creating...';btn.disabled=true;
  const owners=[...document.querySelectorAll('.new-task-owner-cb:checked')].map(cb=>cb.value);
  const fields={
    Task:name,
    Status:'To Do',
    Priority:document.getElementById('new-task-pri').value,
    Owners:owners.length?owners:['TBD'],
    Source:document.getElementById('new-task-source').value||'Manual',
    'Source Date':new Date().toISOString().split('T')[0]
  };
  const cat=document.getElementById('new-task-cat').value;if(cat)fields.Category=cat;
  const due=document.getElementById('new-task-due').value;if(due)fields['Due Date']=due;
  const notes=document.getElementById('new-task-notes').value;if(notes)fields.Notes=notes;
  try{
    const r=await fetch(`https://api.airtable.com/v0/${B}/${TABLES.tasks}`,{
      method:'POST',headers:{Authorization:'Bearer '+PAT,'Content-Type':'application/json'},
      body:JSON.stringify({fields})
    });
    if(!r.ok)throw new Error('Failed');
    const rec=await r.json();
    tasks.push({id:rec.id,...fields});
    closeTaskModal();renderTasks();renderDashboard();
    toast('Task created ‚úì');
  }catch(e){toast('Error: '+e.message,'error')}
  btn.textContent='Create Task';btn.disabled=false;
}

// ‚îÄ‚îÄ NEW EVENT MODAL ‚îÄ‚îÄ
function openEventModal(){
  document.getElementById('event-modal').classList.add('open');
  document.getElementById('new-event-date').value=new Date().toISOString().split('T')[0];
  const cont=document.getElementById('new-event-who');
  const whoChoices=['Full Band',...members.map(m=>m.Name),'Team'];
  cont.innerHTML=whoChoices.map(c=>'<label style="display:flex;align-items:center;gap:4px;background:var(--bg);padding:3px 8px;border-radius:4px;font-size:11px;cursor:pointer"><input type="checkbox" class="new-event-who-cb" value="'+esc(c)+'"/> '+esc(c)+'</label>').join('');
}
function closeEventModal(){
  document.getElementById('event-modal').classList.remove('open');
  document.getElementById('new-event-name').value='';
  document.getElementById('new-event-time').value='';
  document.getElementById('new-event-type').value='';
  document.getElementById('new-event-location').value='';
  document.getElementById('new-event-contact').value='';
  document.getElementById('new-event-email').value='';
  document.getElementById('new-event-details').value='';
  document.getElementById('new-event-link').value='';
}
async function submitEvent(){
  const name=document.getElementById('new-event-name').value.trim();
  const date=document.getElementById('new-event-date').value;
  if(!name||!date){toast('Need event name and date','error');return}
  const btn=document.getElementById('submit-event-btn');btn.textContent='Creating...';btn.disabled=true;
  const who=[...document.querySelectorAll('.new-event-who-cb:checked')].map(cb=>cb.value);
  const fields={Event:name,Date:date,Status:document.getElementById('new-event-status').value||'Confirmed'};
  const time=document.getElementById('new-event-time').value;if(time)fields.Time=time;
  const type=document.getElementById('new-event-type').value;if(type)fields.Type=type;
  const loc=document.getElementById('new-event-location').value;if(loc)fields.Location=loc;
  const contact=document.getElementById('new-event-contact').value;if(contact)fields.Contact=contact;
  const email=document.getElementById('new-event-email').value;if(email)fields['Contact Email']=email;
  if(who.length)fields.Who=who;
  const details=document.getElementById('new-event-details').value;if(details)fields.Details=details;
  const link=document.getElementById('new-event-link').value;if(link)fields.Link=link;
  try{
    const r=await fetch(`https://api.airtable.com/v0/${B}/${TABLES.schedule}`,{
      method:'POST',headers:{Authorization:'Bearer '+PAT,'Content-Type':'application/json'},
      body:JSON.stringify({fields})
    });
    if(!r.ok)throw new Error('Failed');
    const rec=await r.json();
    schedule.push({id:rec.id,...fields});
    closeEventModal();renderSchedule();renderDashboard();
    toast('Event created ‚úì');
  }catch(e){toast('Error: '+e.message,'error')}
  btn.textContent='Create Event';btn.disabled=false;
}

// ‚îÄ‚îÄ SCHEDULE ‚îÄ‚îÄ
let schedWeekStart=getMonday(new Date());
function getMonday(d){const dt=new Date(d);const day=dt.getDay();const diff=dt.getDate()-day+(day===0?-6:1);dt.setDate(diff);dt.setHours(0,0,0,0);return dt}
function shiftWeek(dir){schedWeekStart=new Date(schedWeekStart.getTime()+dir*7*86400000);renderSchedule()}
function goToday(){schedWeekStart=getMonday(new Date());renderSchedule()}

function renderSchedule(){
  const who=document.getElementById('sched-filter-who').value;
  const weekEnd=new Date(schedWeekStart.getTime()+7*86400000);
  document.getElementById('schedule-range').textContent=fmtDateFull(schedWeekStart)+' ‚Äî '+fmtDateFull(new Date(weekEnd.getTime()-86400000));

  let filtered=schedule.filter(s=>s.Status!=='Cancelled');
  if(who)filtered=filtered.filter(s=>s.Who&&s.Who.includes(who));

  const list=document.getElementById('schedule-list');
  const days=[];
  for(let i=0;i<7;i++){
    const d=new Date(schedWeekStart.getTime()+i*86400000);
    const ds=d.toISOString().split('T')[0];
    const dayEvents=filtered.filter(s=>s.Date===ds).sort((a,b)=>(a.Time||'').localeCompare(b.Time||''));
    days.push({date:d,dateStr:ds,events:dayEvents});
  }

  const today=new Date().toISOString().split('T')[0];
  list.innerHTML=days.map(day=>{
    const isToday=day.dateStr===today;
    const dayName=day.date.toLocaleDateString('en-US',{weekday:'short'});
    const dateLabel=day.date.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    return`<div style="margin-bottom:12px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
        <div style="font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;color:${isToday?'var(--accent)':'var(--dim)'};text-transform:uppercase;letter-spacing:1px">${dayName} ${dateLabel}</div>
        ${isToday?'<span class="badge" style="background:var(--accent)20;color:var(--accent)">TODAY</span>':''}
        <div style="flex:1;height:1px;background:var(--border)"></div>
      </div>
      ${day.events.length?day.events.map(e=>schedCard(e)).join(''):'<div style="padding:6px 16px;font-size:11px;color:var(--border);font-style:italic">Nothing scheduled</div>'}
    </div>`;
  }).join('');
}

function schedCard(e){
  const typeColors={'üé§ Show':'#ff6b35','üéôÔ∏è Interview':'#a855f7','üì∞ Press':'#22d3ee','üéß Studio':'#14b8a6','üì∏ Photo/Video':'#ec4899','‚úàÔ∏è Travel':'#3b82f6','üìã Meeting':'#eab308','üì± Social Media':'#ef4444','üé∂ Rehearsal':'#22c55e','‚è∞ Deadline':'#6b7280'};
  const color=typeColors[e.Type]||'var(--dim)';
  const conf=e.Status==='Tentative';
  return`<div class="card" style="border-left:3px solid ${color};${conf?'opacity:.7;border-style:dashed':''}">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div class="card-title">${esc(e.Event)}</div>
        <div class="card-meta">
          ${e.Type?'<span class="badge" style="background:'+color+'20;color:'+color+'">'+esc(e.Type)+'</span>':''}
          ${e.Time?'<span style="font-family:\'JetBrains Mono\',monospace;font-size:11px;color:var(--text)">üïê '+esc(e.Time)+'</span>':''}
          ${e.Location?'<span style="font-size:11px;color:var(--dim)">üìç '+esc(e.Location)+'</span>':''}
          ${conf?'<span class="badge b-pending">TENTATIVE</span>':''}
        </div>
      </div>
    </div>
    ${e.Who&&e.Who.length?'<div style="margin-top:4px;display:flex;gap:3px;flex-wrap:wrap">'+e.Who.map(w=>'<span style="background:var(--surface2);padding:1px 6px;border-radius:3px;font-size:9px;font-family:\'JetBrains Mono\',monospace;color:var(--dim)">'+esc(w)+'</span>').join('')+'</div>':''}
    ${e.Details?'<div style="font-size:12px;color:var(--dim);margin-top:6px;white-space:pre-wrap">'+esc(e.Details)+'</div>':''}
    ${e.Contact?'<div style="font-size:11px;color:var(--dim);margin-top:4px">üë§ '+esc(e.Contact)+(e['Contact Email']?' ¬∑ <a href="mailto:'+esc(e['Contact Email'])+'" style="color:var(--accent2)">'+esc(e['Contact Email'])+'</a>':'')+'</div>':''}
    ${e.Link?'<div style="margin-top:4px"><a href="'+esc(e.Link)+'" target="_blank" style="color:var(--accent);font-size:11px;font-family:\'JetBrains Mono\',monospace">üîó Link</a></div>':''}
  </div>`;
}

function fmtDateFull(d){return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}

// ‚îÄ‚îÄ TAB SWITCHING ‚îÄ‚îÄ
function switchTab(name){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('sec-'+name).classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>{if(t.textContent.toLowerCase().includes(name.substring(0,4)))t.classList.add('active')});
  if(name==='messages')renderMessages();
  if(name==='files')renderFiles();
  if(name==='commissions')renderCommissions();
  if(name==='tour')renderTour();
  if(name==='schedule')renderSchedule();
  if(name==='tasks')renderTasks();
  if(name==='meetings')renderMeetings();
  if(name==='budgets')renderBudgets();
  if(name==='expenses')renderExpenses();
  if(name==='dashboard')renderDashboard();
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function statusClass(s){return{'To Do':'b-todo','In Progress':'b-progress','Blocked':'b-blocked','Done':'b-done'}[s]||'b-todo'}
function priClass(p){if(!p)return'b-normal';if(p.includes('Urgent'))return'b-urgent';if(p.includes('High'))return'b-high';if(p.includes('Normal'))return'b-normal';return'b-low'}
function priSort(a,b){const o={'üî¥ Urgent':0,'üü° High':1,'üîµ Normal':2,'‚ö™ Low':3};return(o[a.Priority]??2)-(o[b.Priority]??2)}
function fmtDate(d){if(!d)return'';try{return new Date(d+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})}catch(e){return d}}
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=String(s);return d.innerHTML}
function toast(msg,type){const t=document.getElementById('toast');t.textContent=msg;t.className='toast'+(type==='error'?' error':'')+' show';setTimeout(()=>t.classList.remove('show'),3000)}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
document.addEventListener('click',e=>{if(!e.target.closest('.owner-picker'))document.querySelectorAll('.owner-dropdown.open').forEach(d=>d.classList.remove('open'))});
window.onload=async()=>{
  PAT=HARDCODED_PAT;
  await loadMembers();
  // Auto-login from saved session
  const saved=localStorage.getItem('wf_user');
  if(saved){
    try{
      const s=JSON.parse(saved);
      const m=members.find(x=>x.Name===s.name&&x['Login Code']===s.code);
      if(m){currentUser=m;showApp();return}
    }catch(e){}
  }
};

</script>
</body>
</html>
