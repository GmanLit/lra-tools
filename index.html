<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LRA Venue Map v4</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0f;--surface:#14141f;--surface2:#1c1c2e;--border:#2a2a3d;--text:#e8e8f0;--dim:#8888a0;--accent:#ff6b35;--accent2:#00d4aa;--c1:#4ecdc4;--c2:#45b7d1;--c3:#f7dc6f;--c4:#ff9f43;--c5:#ff6b6b;--never:#ff3366;--ha:#999;--h1:#5cb85c;--h23:#f0c040;--h4:#e08030;--hc:#28a745;--hna:#d9534f;--hav:#5bc0de;--fest:#ffd700;--ser:#00e5ff}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
#app{display:flex;height:100vh}
#sidebar{width:370px;min-width:370px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:1000;transition:transform .3s,min-width .3s,width .3s}
#sidebar.collapsed{transform:translateX(-370px);min-width:0;width:0;overflow:hidden}
.sh{padding:12px 16px;border-bottom:1px solid var(--border);background:linear-gradient(135deg,var(--surface),var(--surface2));display:flex;justify-content:space-between;align-items:center}
.sh h1{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--accent);letter-spacing:2px;text-transform:uppercase}
.sh .sub{font-size:9px;color:var(--dim);margin-top:2px;font-family:'JetBrains Mono',monospace}
.sh-btns{display:flex;gap:4px}
.hbtn{background:var(--surface2);border:1px solid var(--border);color:var(--dim);padding:5px 8px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:9px;cursor:pointer;transition:all .2s;text-transform:uppercase;letter-spacing:.5px}
.hbtn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.hbtn.refreshing{background:var(--accent2);color:#000;border-color:var(--accent2);pointer-events:none}
.fs{padding:6px 16px;border-bottom:1px solid var(--border)}
.fs label{font-family:'JetBrains Mono',monospace;font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--dim);display:block;margin-bottom:2px}
.fs input,.fs select{width:100%;padding:5px 9px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:12px;outline:none}
.fs input:focus,.fs select:focus{border-color:var(--accent)}.fs select option{background:var(--bg)}
.fr{display:flex;gap:5px}.fr>div{flex:1}
.cr{display:flex;align-items:center;gap:5px}.cr input{width:70px;text-align:center}.cr span{color:var(--dim);font-size:11px}
.chip{font-size:9px;padding:2px 6px;border-radius:4px;background:var(--surface2);border:1px solid var(--border);cursor:pointer;transition:all .15s;font-family:'JetBrains Mono',monospace;color:var(--dim);user-select:none;display:inline-block}
.chip.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.pt{font-size:9px;padding:4px 9px;border-radius:5px;background:var(--surface2);border:1px solid var(--border);cursor:pointer;transition:all .15s;font-family:'JetBrains Mono',monospace;color:var(--dim);user-select:none;text-transform:uppercase;letter-spacing:.5px}
.pt:hover{border-color:var(--dim)}
.mb{font-size:9px;padding:4px 9px;border-radius:5px;background:var(--surface2);border:1px solid var(--border);cursor:pointer;transition:all .15s;font-family:'JetBrains Mono',monospace;color:var(--dim);user-select:none;text-transform:uppercase;letter-spacing:.5px}
.mb:hover{border-color:var(--dim)}
.mb.ar{background:var(--accent);color:#fff;border-color:var(--accent)}
.mb.an{background:var(--never);color:#fff;border-color:var(--never)}
.mb.ax{background:#6c5ce7;color:#fff;border-color:#6c5ce7}
.mb.ah{background:var(--hc);color:#fff;border-color:var(--hc)}
#rp{display:none;padding:6px 16px;border-bottom:1px solid var(--border);max-height:180px;overflow-y:auto}
#rp.vis{display:block}
.rh{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.rh span{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:1px}
.rh button{font-size:9px;color:var(--never);cursor:pointer;font-family:'JetBrains Mono',monospace;background:none;border:none}
.rs{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:11px;border-bottom:1px solid var(--border)}
.rs .num{width:18px;height:18px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;flex-shrink:0}
.rs .vi{flex:1;min-width:0}.rs .vn{font-weight:600;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.rs .vd{font-size:9px;color:var(--dim)}
.rs .li{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent);text-align:right;flex-shrink:0}
.rs .rx{color:var(--dim);cursor:pointer;font-size:13px;flex-shrink:0;background:none;border:none;padding:1px}
.rs .rx:hover{color:var(--never)}
.rt{margin-top:4px;padding:5px 7px;background:var(--bg);border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:10px;display:flex;justify-content:space-between}
.rt .tl{color:var(--dim)}.rt .tv{color:var(--accent);font-weight:700}
#hp{display:none;padding:6px 16px;border-bottom:1px solid var(--border);max-height:150px;overflow-y:auto}
#hp.vis{display:block}
.hl{display:flex;flex-wrap:wrap;gap:3px;margin-top:4px;padding:4px 6px;background:var(--bg);border-radius:5px}
.hl span{display:flex;align-items:center;gap:2px;font-size:8px;color:var(--dim);font-family:'JetBrains Mono',monospace}
.hl .hd{width:7px;height:7px;border-radius:50%;flex-shrink:0}
#rc{display:none;padding:5px 16px;border-bottom:1px solid var(--border)}
#rc.vis{display:flex;align-items:center;gap:6px}
#rc label{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);white-space:nowrap}
#rc input[type=range]{flex:1;accent-color:#6c5ce7}
#rc .rv{font-family:'JetBrains Mono',monospace;font-size:10px;color:#6c5ce7;min-width:45px}
.leg{padding:5px 16px;border-bottom:1px solid var(--border)}
.leg-t{font-family:'JetBrains Mono',monospace;font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--dim);margin-bottom:3px}
.leg-i{display:flex;flex-wrap:wrap;gap:2px}
.li-i{display:flex;align-items:center;gap:2px;font-size:9px;color:var(--dim);cursor:pointer;padding:1px 4px;border-radius:3px;transition:background .2s;user-select:none}
.li-i:hover{background:var(--surface2)}.li-i.off{opacity:.2}
.li-d{width:7px;height:7px;border-radius:50%}
#vl{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.vi-item{padding:6px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.vi-item:hover{background:var(--surface2)}.vi-item.in-r{background:rgba(255,107,53,.08);border-left:3px solid var(--accent)}
.vi-item .nm{font-weight:600;font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.vi-item .mt{font-size:9px;color:var(--dim);margin-top:1px;display:flex;gap:5px;flex-wrap:wrap}
.vi-item .bd{padding:1px 5px;border-radius:3px;font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:600}
.sb{padding:5px 16px;border-top:1px solid var(--border);font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);background:var(--surface);display:flex;justify-content:space-between;flex-shrink:0}
#mc{flex:1;position:relative}#map{width:100%;height:100%;background:var(--bg)}
.ts{position:absolute;top:10px;left:10px;z-index:1001;background:var(--surface);border:1px solid var(--border);color:var(--text);width:32px;height:32px;border-radius:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .2s}
.ts:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
.gp{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);z-index:1001;background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:6px 14px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);display:none;align-items:center;gap:6px;box-shadow:0 4px 16px rgba(0,0,0,.5)}
.gp.on{display:flex}
.gb{width:100px;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.gb-f{height:100%;background:var(--accent);border-radius:2px;transition:width .3s;width:0%}
.rb{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:1001;background:var(--accent);color:#fff;padding:5px 14px;border-radius:7px;font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:1px;display:none;box-shadow:0 4px 16px rgba(255,107,53,.3)}
.rb.on{display:block}
.cb{position:absolute;top:10px;right:10px;z-index:1001;background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:4px 10px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent2);display:none;box-shadow:0 2px 8px rgba(0,0,0,.3)}
.cb.on{display:block}
#loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
#loading.hid{display:none}
.loader{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loading .st{margin-top:14px;font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--dim);text-align:center}
#setup{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999}
#setup.hid{display:none}
.sc{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:36px;max-width:480px;width:90%}
.sc h2{font-family:'JetBrains Mono',monospace;color:var(--accent);font-size:17px;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px}
.sc p{color:var(--dim);font-size:12px;margin-bottom:10px;line-height:1.5}
.sc input[type=password]{width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:12px;outline:none;margin-bottom:10px}
.sc input[type=password]:focus{border-color:var(--accent)}
.sc button{width:100%;padding:10px;background:var(--accent);border:none;border-radius:7px;color:#fff;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;cursor:pointer;letter-spacing:1px;text-transform:uppercase}
.sc .err{color:#ff4444;font-size:11px;margin-top:6px;display:none}
.sc code{background:var(--bg);padding:2px 5px;border-radius:3px;font-size:10px;color:var(--accent2)}
.sc .wb{margin-top:8px;display:flex;align-items:center;gap:6px;font-size:11px;color:var(--dim)}
.sc .wb input{accent-color:var(--accent)}
.leaflet-popup-content-wrapper{background:var(--surface)!important;border:1px solid var(--border)!important;border-radius:9px!important;color:var(--text)!important;box-shadow:0 8px 32px rgba(0,0,0,.5)!important}
.leaflet-popup-tip{background:var(--surface)!important}
.leaflet-popup-close-button{color:var(--dim)!important;font-size:18px!important}
.leaflet-popup-content{margin:10px!important;min-width:260px;max-width:400px}
.pn{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:var(--accent);margin-bottom:2px}
.pl{font-size:10px;color:var(--dim);margin-bottom:6px}
.pg{display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-bottom:6px}
.pf{background:var(--bg);padding:4px 6px;border-radius:4px}
.pf .lb{font-family:'JetBrains Mono',monospace;font-size:7px;text-transform:uppercase;letter-spacing:1px;color:var(--dim)}
.pf .vl{font-size:11px;font-weight:600;margin-top:1px}
.pf-f{grid-column:1/-1}
.pst{font-family:'JetBrains Mono',monospace;font-size:8px;text-transform:uppercase;letter-spacing:1px;color:var(--dim);margin:6px 0 3px;border-top:1px solid var(--border);padding-top:5px}
.pp{background:var(--bg);padding:3px 6px;border-radius:4px;margin-bottom:2px}
.pp .ppn{font-weight:600;font-size:11px}.pp .ppc{font-size:9px;color:var(--dim)}.pp .ppe{font-size:9px;color:var(--accent2)}
.pnotes{background:var(--bg);padding:4px 6px;border-radius:4px;font-size:9px;color:var(--dim);max-height:50px;overflow-y:auto;line-height:1.4;white-space:pre-wrap}
.plinks{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap}
.plink{color:var(--accent);font-size:9px;font-family:'JetBrains Mono',monospace;text-decoration:none}
.plink:hover{text-decoration:underline}
.popup-route-btn{background:var(--accent);color:#fff;border:none;padding:3px 9px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:9px;cursor:pointer;margin-top:5px}
.oa{width:100%;min-height:50px;max-height:100px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:10px;padding:5px 7px;resize:vertical;outline:none;margin-top:3px}
.oa:focus{border-color:var(--accent)}
.os{background:var(--accent2);color:#000;border:none;padding:3px 10px;border-radius:4px;font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:600;cursor:pointer;margin-top:3px}
.os:hover{opacity:.85}
.ostat{font-size:9px;margin-left:6px;font-family:'JetBrains Mono',monospace}
.vt{background:var(--surface)!important;border:1px solid var(--border)!important;color:var(--text)!important;border-radius:5px!important;padding:5px 8px!important;font-family:'DM Sans',sans-serif!important;font-size:10px!important;box-shadow:0 4px 12px rgba(0,0,0,.5)!important;white-space:nowrap}
.vt .ttn{font-weight:700;font-size:11px;color:var(--accent)}.vt .ttl{color:var(--dim);font-size:9px}
.vt .ttm{display:flex;gap:6px;margin-top:1px;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--dim)}
.ft .ttn{color:var(--fest)!important}.st-t .ttn{color:var(--ser)!important}
.leaflet-control-zoom a{background:var(--surface)!important;color:var(--text)!important;border-color:var(--border)!important}
.leaflet-control-zoom a:hover{background:var(--surface2)!important}
.phr{display:flex;justify-content:space-between;align-items:center;padding:2px 6px;background:var(--bg);border-radius:3px;margin-bottom:2px;font-size:9px}
@keyframes hp{0%,100%{opacity:.6;transform:scale(1)}50%{opacity:1;transform:scale(1.1)}}
</style>
</head>
<body>
<div id="setup"><div class="sc">
<h2>üó∫Ô∏è LRA Map v4</h2>
<p>Loads <strong>Venues + Festivals + Series</strong> from Airtable and <strong>Holds</strong> from the shared Google Sheet. Cached for 1hr, background refresh.</p>
<p style="font-size:10px">Token: <code>airtable.com/create/tokens</code> ‚Äî scopes: <code>data.records:read</code> + <code>data.records:write</code></p>
<input type="password" id="api-token" placeholder="pat_xxxxxxxxxxxx..."/>
<div class="wb"><input type="checkbox" id="wb-check" checked/><label for="wb-check">Enable write (outreach notes, coord writeback)</label></div>
<button onclick="initApp()">Load Everything</button>
<div class="err" id="setup-error"></div>
</div></div>
<div id="loading" class="hid"><div class="loader"></div><div class="st" id="load-status">Loading...</div></div>
<div id="app" style="display:none">
<div id="sidebar">
<div class="sh"><div><h1>LRA Map</h1><div class="sub" id="counts">‚Äî</div></div><div class="sh-btns"><button class="hbtn" id="refresh-btn" onclick="forceRefresh()">üîÑ Refresh</button><button class="hbtn" onclick="exportCSV()">‚¨á CSV</button></div></div>
<div class="fs"><label>Search</label><input type="text" id="search" placeholder="Name, city, promoter..." oninput="applyFilters()"/></div>
<div class="fs"><div class="fr"><div><label>Fest Month</label><select id="f-month" onchange="applyFilters()"><option value="">All</option><option>01 January</option><option>02 February</option><option>03 March</option><option>04 April</option><option>05 May</option><option>06 June</option><option>07 July</option><option>08 August</option><option>09 September</option><option>10 October</option><option>11 November</option><option>12 December</option></select></div><div><label>Series Mo</label><select id="f-smonth" onchange="applyFilters()"><option value="">All</option><option>January</option><option>February</option><option>March</option><option>April</option><option>May</option><option>June</option><option>July</option><option>August</option><option>September</option><option>October</option><option>November</option><option>December</option></select></div></div></div>
<div class="fs"><label>Capacity</label><div class="cr"><input type="number" id="cap-min" placeholder="0" oninput="applyFilters()"/><span>to</span><input type="number" id="cap-max" placeholder="Any" oninput="applyFilters()"/></div></div>
<div class="fs"><label>Pin Types</label><div style="display:flex;gap:3px;flex-wrap:wrap;margin-top:2px">
<div class="pt on" id="pt-v" onclick="togPT('venues')" style="border-color:var(--accent);background:var(--accent);color:#fff">üé§ Venues</div>
<div class="pt on" id="pt-f" onclick="togPT('festivals')" style="border-color:var(--fest);background:var(--fest);color:#000">‚≠ê Festivals</div>
<div class="pt on" id="pt-s" onclick="togPT('series')" style="border-color:var(--ser);background:var(--ser);color:#000">üí† Series</div>
</div></div>
<div class="fs"><label>Artist History</label><div id="af" style="display:flex;flex-wrap:wrap;gap:2px;margin-top:2px"></div></div>
<div class="fs"><label>Tools</label><div style="display:flex;gap:3px;flex-wrap:wrap">
<div class="mb" id="btn-rt" onclick="togRoute()">üõ£Ô∏è Route</div>
<div class="mb" id="btn-nv" onclick="togNever()">üÜï Never</div>
<div class="mb" id="btn-rd" onclick="togRadius()">üì° Radius</div>
<div class="mb" id="btn-hd" onclick="togHolds()">üìã Holds</div>
</div></div>
<div id="rc"><label>Radius:</label><input type="range" id="r-slider" min="10" max="200" value="90" oninput="updRL()"/><div class="rv" id="r-val">90mi</div></div>
<div id="rp"><div class="rh"><span>Route Stops</span><button onclick="clearRoute()">‚úï Clear</button></div><div id="r-stops"></div><div class="rt" id="r-totals" style="display:none"><div><span class="tl">Total: </span><span class="tv" id="r-dist">‚Äî</span></div><div><span class="tl">Drive: </span><span class="tv" id="r-time">‚Äî</span></div></div></div>
<div id="hp"><div class="rh"><span>Hold Status</span></div><div id="h-sum" style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--dim);line-height:1.7">Select artist chips to see stats</div>
<div class="hl"><span><div class="hd" style="background:var(--ha)"></div>Asked</span><span><div class="hd" style="background:var(--h1)"></div>1st</span><span><div class="hd" style="background:var(--h23)"></div>2-3</span><span><div class="hd" style="background:var(--h4)"></div>4+</span><span><div class="hd" style="background:var(--hc)"></div>Conf</span><span><div class="hd" style="background:var(--hna)"></div>NA</span></div></div>
<div class="leg"><div class="leg-t">Venue Capacity</div><div class="leg-i">
<div class="li-i"><div class="li-d" style="background:var(--c1)"></div>0-300</div>
<div class="li-i"><div class="li-d" style="background:var(--c2)"></div>301-500</div>
<div class="li-i"><div class="li-d" style="background:var(--c3)"></div>501-750</div>
<div class="li-i"><div class="li-d" style="background:var(--c4)"></div>751-1500</div>
<div class="li-i"><div class="li-d" style="background:var(--c5)"></div>1500+</div>
</div></div>
<div id="vl"></div>
<div class="sb"><span id="s-count">‚Äî</span><span id="m-count">‚Äî</span></div>
</div>
<div id="mc">
<button class="ts" onclick="document.getElementById('sidebar').classList.toggle('collapsed')">‚ò∞</button>
<div class="rb" id="r-banner">ROUTE MODE ‚Äî Click pins to add stops</div>
<div class="cb" id="c-badge">üîÑ Updating...</div>
<div id="map"></div>
<div class="gp" id="gp"><span id="g-text">Geocoding...</span><div class="gb"><div class="gb-f" id="g-fill"></div></div></div>
</div>
</div>
<script>
const B='appBeWOdb4dIuNKUW',VT='tblFVQsrpgffr7FH4',FT='tblLda0Y2tcYeNDIP',ST='tblP7nDIXRRLUfJV0';
const SH_ID='1Rk-crpUpZGCeisBrpyah5VWUkoCPal4NmNt08JeijpQ';
const H_TABS=['Weakened Friends','The Ballroom Thieves','Highly Suspect','Johnny Stevens Shows','Hannah Mohan','Lyle Brewer','Liv Greene'];
const AK=['WF','TBT'];
const CC={300:'#4ecdc4',500:'#45b7d1',750:'#f7dc6f',1500:'#ff9f43',9999:'#ff6b6b'};
function capCol(c){if(!c||c<=300)return'#4ecdc4';if(c<=500)return'#45b7d1';if(c<=750)return'#f7dc6f';if(c<=1500)return'#ff9f43';return'#ff6b6b'}
const OF={festivals:'fldx9Tb6fF3WoZLhc',series:'fldpOYnA9eW0CSUZa'};

// ‚îÄ‚îÄ EXACT FIELD NAMES FROM AIRTABLE SCHEMA ‚îÄ‚îÄ
const V_FIELDS=['Venue Name','Venue City','Venue ST','Region','CAP','Ages','Latitude','Longitude ','Venue Location',
  '[D] Promoter (from Airtable Promoter)','Company Name  (Linked from [D] Promoter (from Airtable Promoter))',
  'Promoter Email (Linked from [D] Promoter (from Airtable Promoter))',
  'Promoter Name (from [D] Promoter (from Airtable Promoter))',
  'Website','LRA V/F Thoughts','Radius (Typical)','Notes on Venue','WF','TBT','Genre','Notable Artists Played Here'];

const F_FIELDS=['Festival','City','ST','Type','Month - AI','Primary Genres - AI',
  '[D] Promoter','Promoter Email (from Promoters Teams)','Promoter Name (from Promoters Teams)',
  'AI - Promoter Email','AI - Promoter Name','[D] Company Name',
  'Website [F] - AI','Outreach Info','Venue Location','Latitude','Longitude','WF',
  '[F] Attendance','Closed','Days of 2026 Festival','2026 Festival Pitched',
  '[F] Typically Starts Booking','LRA V/F Thoughts','[F] Booking Status',
  'Line Up Names - AI - Previous Year'];

const S_FIELDS=['Name','City','ST','Day of Week','Genres','Previous Artists',
  '[D] Promoter','AI Promoter Email','AI Promoter Name','[D] Company Name',
  'Website','Outreach Info','Venue Location','Latitude','Longitude','CAP TOTAL Cap','Closed',
  '[F] [S] Fee Range','Months','Region','[F] Typically Starts Booking',
  'LRA V/F Thoughts','[F] Primary Genres','Expected Day of Week',
  'Expected 2026 Start','Expected 2026 End','Previous Year Day Of Week','Info on Series'];

let TK='',WE=true,map,all=[],filt=[],mkrs={},rLayer=null,rCircle=null;
let rtMode=false,nvMode=false,rdMode=false,hdMode=false;
let rStops=[],rLegs=[];
let pts={venues:true,festivals:true,series:true};
let aArts=new Set();
let hData={};
const CACHE_KEY='lra_map_cache_v4',CACHE_TTL=3600000;

function initApp(){
  TK=document.getElementById('api-token').value.trim();
  WE=document.getElementById('wb-check').checked;
  if(!TK||!TK.startsWith('pat')){const e=document.getElementById('setup-error');e.textContent='Need valid PAT starting with pat_';e.style.display='block';return}
  localStorage.setItem('lra_pat',TK);localStorage.setItem('lra_write',WE);
  document.getElementById('setup').classList.add('hid');
  const cached=loadCache();
  if(cached){
    all=cached;showApp();
    setTimeout(()=>bgRefresh(),100);
    loadHolds();
  } else {
    document.getElementById('loading').classList.remove('hid');
    loadFresh();
  }
}

window.onload=()=>{
  const t=localStorage.getItem('lra_pat');
  if(t){document.getElementById('api-token').value=t;
    const w=localStorage.getItem('lra_write');if(w!==null)document.getElementById('wb-check').checked=w==='true';
  }
};

function loadCache(){try{const r=localStorage.getItem(CACHE_KEY);if(!r)return null;const c=JSON.parse(r);if(Date.now()-c.ts>CACHE_TTL)return null;return c.data}catch(e){return null}}
function saveCache(data){try{localStorage.setItem(CACHE_KEY,JSON.stringify({ts:Date.now(),data}))}catch(e){}}

async function loadFresh(){
  try{
    setSt('Loading venues + festivals + series...');
    const [venues,festivals,series]=await Promise.all([fetchAll(VT,V_FIELDS),fetchAll(FT,F_FIELDS),fetchAll(ST,S_FIELDS)]);
    setSt(`${venues.length}v + ${festivals.length}f + ${series.length}s loaded`);
    all=[];procVenues(venues);procFests(festivals);procSeries(series);
    saveCache(all);
    await loadHolds();
    showApp();
    document.getElementById('loading').classList.add('hid');
    setTimeout(()=>geocodeMissing(),500);
  }catch(e){setSt('Error: '+e.message);console.error(e)}
}

async function bgRefresh(){
  const badge=document.getElementById('c-badge');badge.classList.add('on');
  try{
    const [v,f,s]=await Promise.all([fetchAll(VT,V_FIELDS),fetchAll(FT,F_FIELDS),fetchAll(ST,S_FIELDS)]);
    all=[];procVenues(v);procFests(f);procSeries(s);
    saveCache(all);applyFilters();
    setTimeout(()=>geocodeMissing(),500);
  }catch(e){console.warn('bg refresh fail',e)}
  badge.classList.remove('on');
}

async function forceRefresh(){
  const btn=document.getElementById('refresh-btn');btn.classList.add('refreshing');btn.textContent='‚è≥ Loading...';
  try{
    localStorage.removeItem(CACHE_KEY);
    const [v,f,s]=await Promise.all([fetchAll(VT,V_FIELDS),fetchAll(FT,F_FIELDS),fetchAll(ST,S_FIELDS)]);
    all=[];procVenues(v);procFests(f);procSeries(s);
    saveCache(all);await loadHolds();applyFilters();
    setTimeout(()=>geocodeMissing(),500);
  }catch(e){console.error(e)}
  btn.classList.remove('refreshing');btn.textContent='üîÑ Refresh';
}

function showApp(){
  document.getElementById('app').style.display='flex';
  if(!map)buildMap();buildAF();applyFilters();
}

function setSt(s){document.getElementById('load-status').textContent=s}

async function fetchAll(tid,fields){
  let all=[],offset=null;
  const fp=fields.map(f=>'fields[]='+encodeURIComponent(f)).join('&');
  do{
    let url='https://api.airtable.com/v0/'+B+'/'+tid+'?pageSize=100&'+fp;
    if(offset)url+='&offset='+offset;
    const r=await fetch(url,{headers:{Authorization:'Bearer '+TK}});
    if(!r.ok){const txt=await r.text();console.error('AT error',r.status,txt);throw new Error('AT '+r.status+': '+txt.substring(0,200))}
    const d=await r.json();all=all.concat(d.records);offset=d.offset;
  }while(offset);
  return all;
}

// ‚îÄ‚îÄ PROCESS: VENUES ‚îÄ‚îÄ
function procVenues(recs){
  recs.forEach(r=>{
    const f=r.fields;
    const lat=f['Latitude']!=null?+f['Latitude']:null;
    const lng=f['Longitude ']!=null?+f['Longitude ']:null;
    all.push({
      id:r.id,type:'venue',
      name:f['Venue Name']||'',
      city:f['Venue City']||'',
      state:f['Venue ST']||'',
      region:f['Region']||'',
      cap:parseInt(f['CAP'])||0,
      ages:f['Ages']||'',
      lat:lat,lng:lng,
      promoter:arrFirst(f['[D] Promoter (from Airtable Promoter)']),
      company:arrFirst(f['Company Name  (Linked from [D] Promoter (from Airtable Promoter))']),
      pEmail:arrFirst(f['Promoter Email (Linked from [D] Promoter (from Airtable Promoter))']),
      pName:arrFirst(f['Promoter Name (from [D] Promoter (from Airtable Promoter))']),
      website:f['Website']||'',
      thoughts:f['LRA V/F Thoughts']||'',radius:f['Radius (Typical)']||'',
      notes:f['Notes on Venue']||'',vLoc:f['Venue Location']||'',
      genre:f['Genre']||'',notable:f['Notable Artists Played Here']||'',
      WF:!!f['WF'],TBT:!!f['TBT']
    });
  });
}
function arrFirst(v){if(Array.isArray(v))return v[0]||'';return v||''}

// ‚îÄ‚îÄ PROCESS: FESTIVALS ‚îÄ‚îÄ
function procFests(recs){
  recs.forEach(r=>{
    const f=r.fields;
    if(f['Closed']==='Closed')return;
    const lat=f['Latitude']!=null?+f['Latitude']:null;
    const lng=f['Longitude']!=null?+f['Longitude']:null;
    all.push({
      id:r.id,type:'festival',
      name:f['Festival']||'',city:f['City']||'',state:f['ST']||'',region:'',
      lat:lat,lng:lng,
      cap:parseInt(f['[F] Attendance'])||0,
      promoter:f['[D] Promoter']||'',
      pEmail:arrFirst(f['Promoter Email (from Promoters Teams)'])||f['AI - Promoter Email']||'',
      pName:arrFirst(f['Promoter Name (from Promoters Teams)'])||f['AI - Promoter Name']||'',
      company:f['[D] Company Name']||'',
      website:f['Website [F] - AI']||'',festType:f['Type']||'',
      month:f['Month - AI']||'',genres:f['Primary Genres - AI']||'',
      dates2026:f['Days of 2026 Festival']||'',pitched2026:f['2026 Festival Pitched']||'',
      bookStatus:f['[F] Booking Status']||'',bookStart:f['[F] Typically Starts Booking']||'',
      thoughts:f['LRA V/F Thoughts']||'',outreach:f['Outreach Info']||'',
      vLoc:f['Venue Location']||'',WF:!!f['WF'],
      lineup:f['Line Up Names - AI - Previous Year']||''
    });
  });
}

// ‚îÄ‚îÄ PROCESS: SERIES ‚îÄ‚îÄ
function procSeries(recs){
  recs.forEach(r=>{
    const f=r.fields;if(f['Closed'])return;
    const lat=f['Latitude']!=null?+f['Latitude']:null;
    const lng=f['Longitude']!=null?+f['Longitude']:null;
    all.push({
      id:r.id,type:'series',
      name:f['Name']||'',city:f['City']||'',state:f['ST']||'',
      region:f['Region']||'',lat:lat,lng:lng,
      cap:parseInt(f['CAP TOTAL Cap'])||0,
      promoter:f['[D] Promoter']||'',company:f['[D] Company Name']||'',
      pEmail:f['AI Promoter Email']||'',pName:f['AI Promoter Name']||'',
      website:f['Website']||'',
      genres:f['Genres']||f['[F] Primary Genres']||'',
      prevArtists:f['Previous Artists']||'',
      dayOfWeek:f['Day of Week']||f['Expected Day of Week']||'',
      prevDOW:f['Previous Year Day Of Week']||'',
      months:f['Months']||'',
      expStart:f['Expected 2026 Start']||'',expEnd:f['Expected 2026 End']||'',
      feeRange:f['[F] [S] Fee Range']||'',
      bookStart:f['[F] Typically Starts Booking']||'',
      thoughts:f['LRA V/F Thoughts']||'',outreach:f['Outreach Info']||'',
      vLoc:f['Venue Location']||'',seriesInfo:f['Info on Series']||''
    });
  });
}

// ‚îÄ‚îÄ HOLDS ‚îÄ‚îÄ
async function loadHolds(){
  hData={};
  const promises=H_TABS.map(async tab=>{
    try{
      const url='https://docs.google.com/spreadsheets/d/'+SH_ID+'/gviz/tq?tqx=out:csv&sheet='+encodeURIComponent(tab);
      const r=await fetch(url);if(!r.ok)return;
      const rows=parseCSV(await r.text());if(rows.length<9)return;
      const vRow=rows[4]||[];
      for(let c=1;c<vRow.length;c++){
        const vn=(vRow[c]||'').trim();if(!vn)continue;
        const holds=[];
        for(let ri=8;ri<rows.length;ri++){
          const dt=(rows[ri]||[])[0]||'',st=((rows[ri]||[])[c]||'').trim();
          if(dt&&st)holds.push({date:dt,status:st});
        }
        if(holds.length){if(!hData[tab])hData[tab]={};hData[tab][vn.toLowerCase()]={vn,holds,best:calcBest(holds)}}
      }
    }catch(e){console.warn('holds',tab,e)}
  });
  await Promise.all(promises);
}

function calcBest(hs){
  let b='asked',bn=999;
  for(const h of hs){
    const s=h.status.toLowerCase().trim();
    if(s.includes('confirmed')||s==='conf')return{s:'confirmed',n:0};
    const m=s.match(/^(\d+)/);
    if(m){const n=+m[1];if(n<bn){bn=n;b=n<=1?'1h':n<=3?'23h':'4h'}}
    else if(s.includes('na')||s.includes('released')){if(b==='asked')b='na'}
    else if(s.includes('avail')){if(b==='asked')b='avail'}
  }
  return{s:b,n:bn};
}
function hCol(s){return{asked:'#999','1h':'#5cb85c','23h':'#f0c040','4h':'#e08030',confirmed:'#28a745',na:'#d9534f',avail:'#5bc0de'}[s]||'#999'}

function parseCSV(t){
  const rows=[];let row=[],cell='',inQ=false;
  for(let i=0;i<t.length;i++){
    const c=t[i],n=t[i+1];
    if(inQ){if(c==='"'&&n==='"'){cell+='"';i++}else if(c==='"')inQ=false;else cell+=c}
    else{if(c==='"')inQ=true;else if(c===','){row.push(cell);cell=''}else if(c==='\n'){row.push(cell);rows.push(row);row=[];cell=''}else if(c!=='\r')cell+=c}
  }
  if(cell||row.length)row.push(cell);if(row.length)rows.push(row);return rows;
}

function parseCoords(s){
  if(!s)return null;
  const m=String(s).match(/([-\d.]+)\s*,\s*([-\d.]+)/);
  if(m){const a=+m[1],b=+m[2];if(a>=-90&&a<=90&&b>=-180&&b<=180)return[a,b]}
  return null;
}

// ‚îÄ‚îÄ MAP ‚îÄ‚îÄ
function buildMap(){
  map=L.map('map',{center:[39.5,-98.35],zoom:4,zoomControl:true,preferCanvas:true});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'¬©CartoDB',maxZoom:19}).addTo(map);
}

function buildAF(){
  const c=document.getElementById('af');c.innerHTML='';
  AK.forEach(k=>{
    const d=document.createElement('div');d.className='chip';d.textContent=k;d.dataset.k=k;
    d.onclick=()=>{
      if(aArts.has(k)){aArts.delete(k);d.classList.remove('on')}else{aArts.add(k);d.classList.add('on')}
      if(hdMode)updHP();applyFilters();
    };
    c.appendChild(d);
  });
}

function mkIcon(item,hc){
  const isR=rStops.includes(item);
  let sz=item.type==='venue'?10:12,col=iCol(item);
  if(nvMode&&item.type==='venue'){if(AK.some(k=>item[k])){col='#333';sz=6}else{col='#ff3366';sz=12}}
  let ring='';
  if(hc)ring='<div style="position:absolute;inset:-4px;border-radius:50%;border:3px solid '+hc+';animation:hp 2s ease-in-out infinite;pointer-events:none"></div>';
  let inner;
  if(item.type==='festival')inner='<div style="width:'+sz+'px;height:'+sz+'px;background:'+col+';clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%)"></div>';
  else if(item.type==='series')inner='<div style="width:'+sz+'px;height:'+sz+'px;background:'+col+';clip-path:polygon(50% 0%,100% 50%,50% 100%,0% 50%)"></div>';
  else inner='<div style="width:'+sz+'px;height:'+sz+'px;border-radius:50%;background:'+col+';border:'+(isR?'2px solid var(--accent)':'1.5px solid rgba(0,0,0,.5)')+'"></div>';
  const ts=hc?sz+8:sz;
  return L.divIcon({html:'<div style="position:relative;display:flex;align-items:center;justify-content:center;width:'+ts+'px;height:'+ts+'px">'+ring+inner+'</div>',iconSize:[ts,ts],iconAnchor:[ts/2,ts/2],className:''});
}
function iCol(i){return i.type==='festival'?'#ffd700':i.type==='series'?'#00e5ff':capCol(i.cap)}

function getHC(item){
  const nm=item.name.toLowerCase().trim();let bs=null,bn=999;
  for(const a of aArts){
    const idx=AK.indexOf(a);if(idx===-1)continue;
    const tab=H_TABS[idx];if(!tab||!hData[tab])continue;
    let hd=hData[tab][nm];
    if(!hd){for(const[k,v] of Object.entries(hData[tab])){if(nm.includes(k)||k.includes(nm)){hd=v;break}}}
    if(hd?.best?.n<bn){bn=hd.best.n;bs=hd.best.s}
  }
  return bs?hCol(bs):null;
}

function renderMkrs(){
  Object.values(mkrs).forEach(m=>map.removeLayer(m));mkrs={};
  filt.forEach(item=>{
    if(!item.lat||!item.lng)return;
    if(item.type==='venue'&&!pts.venues)return;
    if(item.type==='festival'&&!pts.festivals)return;
    if(item.type==='series'&&!pts.series)return;
    let hc=null;if(hdMode&&aArts.size>0)hc=getHC(item);
    const icon=mkIcon(item,hc);
    const m=L.marker([item.lat,item.lng],{icon});
    const tc=item.type==='festival'?'vt ft':item.type==='series'?'vt st-t':'vt';
    let tt='<div class="ttn">'+(item.type==='festival'?'‚≠ê ':item.type==='series'?'üí† ':'')+E(item.name)+'</div><div class="ttl">'+E(item.city)+(item.state?', '+E(item.state):'')+'</div>';
    let meta=[];
    if(item.cap)meta.push('Cap:'+item.cap.toLocaleString());
    if(item.type==='festival'&&item.festType)meta.push(item.festType);
    if(item.type==='series'&&item.feeRange)meta.push(item.feeRange);
    if(meta.length)tt+='<div class="ttm">'+meta.join(' ¬∑ ')+'</div>';
    m.bindTooltip(tt,{className:tc,direction:'top',offset:[0,-8],opacity:1});
    m.on('click',()=>{
      if(rtMode){addRS(item);return}
      if(rdMode){showRad(item);return}
      m.unbindPopup();m.bindPopup(popHTML(item),{maxWidth:400,maxHeight:480}).openPopup();
    });
    m.addTo(map);mkrs[item.id]=m;
  });
}

function popHTML(i){if(i.type==='venue')return vPop(i);if(i.type==='festival')return fPop(i);return sPop(i)}

function vPop(i){
  let h='<div class="pn">üé§ '+E(i.name)+'</div><div class="pl">'+E(i.city)+(i.state?', '+E(i.state):'')+'</div><div class="pg">';
  if(i.cap)h+=pf('Capacity',i.cap.toLocaleString());
  if(i.ages)h+=pf('Ages',i.ages);
  if(i.radius)h+=pf('Radius',i.radius);
  if(i.genre)h+=pff('Genre',i.genre);
  h+='</div>';
  h+=promoSec(i);
  if(hdMode)h+=holdsSec(i);
  const played=AK.filter(k=>i[k]);
  if(played.length)h+='<div class="pst">Artists Played</div><div style="display:flex;gap:3px;flex-wrap:wrap">'+played.map(k=>'<span style="background:var(--accent2);color:#000;padding:1px 5px;border-radius:3px;font-size:8px;font-family:\'JetBrains Mono\',monospace;font-weight:600">'+k+'</span>').join('')+'</div>';
  if(i.notable)h+='<div class="pst">Notable Artists</div><div class="pnotes">'+E(i.notable)+'</div>';
  if(i.thoughts)h+='<div class="pst">LRA Notes</div><div class="pnotes">'+E(i.thoughts)+'</div>';
  if(i.notes)h+='<div class="pst">Venue Notes</div><div class="pnotes">'+E(i.notes)+'</div>';
  h+=links(i,VT);
  if(rtMode)h+='<button class="popup-route-btn" onclick="addRSById(\''+i.id+'\')">+ Add to Route</button>';
  return h;
}

function fPop(i){
  let h='<div class="pn" style="color:var(--fest)">‚≠ê '+E(i.name)+'</div><div class="pl">'+E(i.city)+(i.state?', '+E(i.state):'')+'</div><div class="pg">';
  if(i.festType)h+=pf('Type',i.festType);
  if(i.cap)h+=pf('Attendance',i.cap.toLocaleString());
  if(i.month)h+=pf('Month',i.month);
  if(i.genres)h+=pf('Genres',cj(i.genres));
  if(i.dates2026)h+=pff('2026 Dates',i.dates2026);
  if(i.bookStart)h+=pff('Starts Booking',i.bookStart);
  if(i.bookStatus)h+=pf('Status',i.bookStatus);
  if(i.pitched2026)h+=pf('2026 Pitched',i.pitched2026);
  h+='</div>';
  h+=promoSec(i);
  if(i.WF)h+='<div style="margin:4px 0"><span style="background:var(--accent2);color:#000;padding:1px 5px;border-radius:3px;font-size:8px;font-family:\'JetBrains Mono\',monospace;font-weight:600">WF ‚úì</span></div>';
  if(i.lineup)h+='<div class="pst">Previous Lineup</div><div class="pnotes" style="max-height:80px">'+E(i.lineup)+'</div>';
  h+=outSec(i,'festivals');
  if(i.thoughts)h+='<div class="pst">LRA Notes</div><div class="pnotes">'+E(i.thoughts)+'</div>';
  h+=links(i,FT);
  return h;
}

function sPop(i){
  let h='<div class="pn" style="color:var(--ser)">üí† '+E(i.name)+'</div><div class="pl">'+E(i.city)+(i.state?', '+E(i.state):'')+'</div><div class="pg">';
  if(i.cap)h+=pf('Capacity',i.cap.toLocaleString());
  if(i.feeRange)h+=pf('Fee Range',i.feeRange);
  if(i.dayOfWeek)h+=pf('Day',i.dayOfWeek);
  if(i.prevDOW)h+=pf('Prev DOW',i.prevDOW);
  if(i.genres)h+=pf('Genres',i.genres);
  if(i.months)h+=pff('Months',i.months);
  if(i.expStart)h+=pf('2026 Start',fmtD(i.expStart));
  if(i.expEnd)h+=pf('2026 End',fmtD(i.expEnd));
  if(i.bookStart)h+=pff('Starts Booking',i.bookStart);
  h+='</div>';
  h+=promoSec(i);
  if(i.prevArtists)h+='<div class="pst">Previous Artists</div><div class="pnotes" style="max-height:80px">'+E(i.prevArtists)+'</div>';
  h+=outSec(i,'series');
  if(i.seriesInfo)h+='<div class="pst">Series Info</div><div class="pnotes">'+E(i.seriesInfo)+'</div>';
  if(i.thoughts)h+='<div class="pst">LRA Notes</div><div class="pnotes">'+E(i.thoughts)+'</div>';
  h+=links(i,ST);
  return h;
}

function pf(l,v){return'<div class="pf"><div class="lb">'+l+'</div><div class="vl">'+E(v)+'</div></div>'}
function pff(l,v){return'<div class="pf pf-f"><div class="lb">'+l+'</div><div class="vl">'+E(v)+'</div></div>'}

function promoSec(i){
  if(!i.promoter&&!i.company&&!i.pEmail&&!i.pName)return'';
  let h='<div class="pst">Promoter</div><div class="pp">';
  if(i.promoter)h+='<div class="ppn">'+E(i.promoter)+'</div>';
  if(i.pName&&i.pName!==i.promoter)h+='<div class="ppn">'+E(i.pName)+'</div>';
  if(i.company)h+='<div class="ppc">'+E(i.company)+'</div>';
  if(i.pEmail)h+='<div class="ppe">'+E(i.pEmail)+'</div>';
  h+='</div>';return h;
}

function holdsSec(i){
  const nm=i.name.toLowerCase().trim();let found=[];
  for(const tab of H_TABS){
    if(!hData[tab])continue;
    let hd=hData[tab][nm];
    if(!hd){for(const[k,v] of Object.entries(hData[tab])){if(nm.includes(k)||k.includes(nm)){hd=v;break}}}
    if(hd)hd.holds.forEach(h=>found.push({a:tab,d:h.date,s:h.status}));
  }
  if(!found.length)return'';
  let h='<div class="pst">Active Holds</div><div style="max-height:80px;overflow-y:auto">';
  found.forEach(f=>{h+='<div class="phr"><span>'+E(f.a)+'</span><span>'+E(f.d)+'</span><span style="color:'+hCellCol(f.s)+';font-weight:600">'+E(f.s)+'</span></div>'});
  return h+'</div>';
}
function hCellCol(s){const l=(s||'').toLowerCase();if(l.includes('conf'))return'#28a745';if(l.match(/^1/))return'#5cb85c';if(l.match(/^[23]/))return'#f0c040';if(l.match(/^[4-9]/)||l.match(/^\d\d/))return'#e08030';if(l.includes('na')||l.includes('released'))return'#d9534f';if(l.includes('avail'))return'#5bc0de';return'#999'}

function outSec(i,tType){
  const val=stripRT(i.outreach||'');
  let h='<div class="pst">Outreach Info '+(WE?'<span style="color:var(--accent2);font-size:7px">‚úèÔ∏è EDITABLE</span>':'')+'</div>';
  if(WE){
    h+='<textarea class="oa" id="o-'+i.id+'" placeholder="Log: date, who, re: which artist...">'+E(val)+'</textarea>';
    h+='<div style="display:flex;align-items:center;gap:3px"><button class="os" onclick="saveOut(\''+i.id+'\',\''+tType+'\')">üíæ Save</button><span class="ostat" id="os-'+i.id+'"></span></div>';
  } else {
    h+='<div class="pnotes">'+(val?E(val):'<em style="color:var(--dim)">None yet</em>')+'</div>';
  }
  return h;
}
function stripRT(v){return v?String(v).replace(/<[^>]+>/g,'').trim():''}

async function saveOut(rid,tt){
  const el=document.getElementById('o-'+rid),st=document.getElementById('os-'+rid);if(!el)return;
  const tid=tt==='festivals'?FT:ST,fid=OF[tt];
  st.textContent='Saving...';st.style.color='var(--accent)';
  try{
    const r=await fetch('https://api.airtable.com/v0/'+B+'/'+tid+'/'+rid,{
      method:'PATCH',headers:{Authorization:'Bearer '+TK,'Content-Type':'application/json'},
      body:JSON.stringify({fields:{[fid]:el.value}})
    });
    if(!r.ok)throw new Error(r.status);
    const item=all.find(x=>x.id===rid);if(item)item.outreach=el.value;
    st.textContent='‚úì Saved!';st.style.color='var(--accent2)';setTimeout(()=>st.textContent='',3000);
  }catch(e){st.textContent='‚úï '+e.message;st.style.color='var(--never)'}
}

function links(i,tid){
  let h='<div class="plinks">';
  if(i.website)h+='<a class="plink" href="'+E(i.website)+'" target="_blank">üåê Website</a>';
  h+='<a class="plink" href="https://airtable.com/'+B+'/'+tid+'/'+i.id+'" target="_blank">üìã Open in Airtable</a>';
  h+='</div>';return h;
}

// ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ
function applyFilters(){
  const q=(document.getElementById('search').value||'').toLowerCase();
  const fm=document.getElementById('f-month').value;
  const sm=document.getElementById('f-smonth').value;
  const cMin=parseInt(document.getElementById('cap-min').value)||0;
  const cMax=parseInt(document.getElementById('cap-max').value)||Infinity;
  filt=all.filter(i=>{
    if(i.type==='venue'&&!pts.venues)return false;
    if(i.type==='festival'&&!pts.festivals)return false;
    if(i.type==='series'&&!pts.series)return false;
    if(q){const hay=[i.name,i.city,i.state,i.promoter||'',i.company||'',i.pEmail||'',i.pName||''].join(' ').toLowerCase();if(!hay.includes(q))return false}
    if(fm&&i.type==='festival'){if(!i.month||!i.month.startsWith(fm.substring(0,2)))return false}
    if(sm&&i.type==='series'){if(!i.months||!i.months.toLowerCase().includes(sm.toLowerCase()))return false}
    if(i.cap&&(i.cap<cMin||i.cap>cMax))return false;
    if(cMin>0&&!i.cap)return false;
    if(aArts.size>0&&i.type==='venue'){
      const match=[...aArts].some(k=>i[k]);
      if(nvMode?match:!match)return false;
    }
    return true;
  });
  renderMkrs();renderVL();updCounts();
}

function renderVL(){
  const list=document.getElementById('vl');list.innerHTML='';
  const sorted=[...filt].filter(i=>i.lat&&i.lng).sort((a,b)=>a.name.localeCompare(b.name));
  sorted.slice(0,300).forEach(i=>{
    const d=document.createElement('div');
    d.className='vi-item'+(rStops.includes(i)?' in-r':'');
    const ic=i.type==='festival'?'‚≠ê ':i.type==='series'?'üí† ':'';
    let bd='';
    if(i.type==='venue'&&i.cap)bd+='<span class="bd" style="background:'+capCol(i.cap)+'22;color:'+capCol(i.cap)+'">'+i.cap.toLocaleString()+'</span>';
    if(i.type==='festival'&&i.festType)bd+='<span class="bd" style="background:rgba(255,215,0,.15);color:var(--fest)">'+i.festType+'</span>';
    if(i.type==='festival'&&i.month)bd+='<span class="bd" style="background:rgba(255,215,0,.08);color:var(--dim)">'+i.month+'</span>';
    if(i.type==='series'&&i.feeRange)bd+='<span class="bd" style="background:rgba(0,229,255,.1);color:var(--ser)">'+i.feeRange+'</span>';
    if(hdMode){const hc=getHC(i);if(hc)bd+='<span class="bd" style="background:'+hc+'22;color:'+hc+'">HOLD</span>'}
    d.innerHTML='<div class="nm">'+ic+E(i.name)+'</div><div class="mt"><span>'+E(i.city)+(i.state?', '+E(i.state):'')+'</span>'+(i.cap?'<span>'+i.cap.toLocaleString()+'</span>':'')+bd+'</div>';
    d.onclick=()=>{if(mkrs[i.id]){map.setView([i.lat,i.lng],13);mkrs[i.id].fire('click')}};
    list.appendChild(d);
  });
}

function updCounts(){
  const mp=filt.filter(i=>i.lat&&i.lng).length;
  const vc=filt.filter(i=>i.type==='venue').length,fc=filt.filter(i=>i.type==='festival').length,sc=filt.filter(i=>i.type==='series').length;
  document.getElementById('counts').textContent=all.filter(i=>i.type==='venue').length+'v ¬∑ '+all.filter(i=>i.type==='festival').length+'f ¬∑ '+all.filter(i=>i.type==='series').length+'s';
  document.getElementById('s-count').textContent='Showing: '+filt.length+' ('+vc+'v/'+fc+'f/'+sc+'s)';
  document.getElementById('m-count').textContent='Mapped: '+mp;
}

function togPT(t){
  pts[t]=!pts[t];
  const ids={venues:'pt-v',festivals:'pt-f',series:'pt-s'};
  const cols={venues:['var(--accent)','#fff'],festivals:['var(--fest)','#000'],series:['var(--ser)','#000']};
  const btn=document.getElementById(ids[t]);
  if(pts[t]){btn.classList.add('on');btn.style.background=cols[t][0];btn.style.borderColor=cols[t][0];btn.style.color=cols[t][1]}
  else{btn.classList.remove('on');btn.style.background='var(--surface2)';btn.style.borderColor='var(--border)';btn.style.color='var(--dim)'}
  applyFilters();
}

// ‚îÄ‚îÄ ROUTE ‚îÄ‚îÄ
function togRoute(){
  rtMode=!rtMode;
  document.getElementById('btn-rt').classList.toggle('ar',rtMode);
  document.getElementById('r-banner').classList.toggle('on',rtMode);
  document.getElementById('rp').classList.toggle('vis',rtMode);
  if(rtMode){nvMode=false;rdMode=false;document.getElementById('btn-nv').classList.remove('an');document.getElementById('btn-rd').classList.remove('ax');document.getElementById('rc').classList.remove('vis')}
}
function addRS(i){if(!rStops.includes(i)){rStops.push(i);renderRP();if(rStops.length>1)calcRoute();applyFilters()}}
function addRSById(id){const i=all.find(x=>x.id===id);if(i)addRS(i)}
function remRS(idx){rStops.splice(idx,1);renderRP();if(rStops.length>1)calcRoute();else clearRL();applyFilters()}
function clearRoute(){rStops=[];rLegs=[];clearRL();renderRP();applyFilters()}
function clearRL(){if(rLayer){map.removeLayer(rLayer);rLayer=null}document.getElementById('r-totals').style.display='none'}
function renderRP(){
  const c=document.getElementById('r-stops');c.innerHTML='';
  rStops.forEach((i,idx)=>{
    const leg=rLegs[idx-1],li=leg?(leg.distance/1609.34).toFixed(0)+'mi ¬∑ '+fmtDur(leg.duration):'';
    c.innerHTML+='<div class="rs"><div class="num">'+(idx+1)+'</div><div class="vi"><div class="vn">'+E(i.name)+'</div><div class="vd">'+E(i.city)+(i.state?', '+E(i.state):'')+'</div></div>'+(li?'<div class="li">'+li+'</div>':'')+'<button class="rx" onclick="remRS('+idx+')">‚úï</button></div>';
  });
}
async function calcRoute(){
  if(rStops.length<2)return;
  const coords=rStops.map(s=>s.lng+','+s.lat).join(';');
  try{
    const r=await fetch('https://router.project-osrm.org/route/v1/driving/'+coords+'?overview=full&geometries=geojson&steps=false');
    const d=await r.json();if(d.code!=='Ok')return;
    clearRL();
    rLayer=L.geoJSON(d.routes[0].geometry,{style:{color:'#ff6b35',weight:3,opacity:.8,dashArray:'8,6'}}).addTo(map);
    rLegs=d.routes[0].legs;renderRP();
    const td=rLegs.reduce((s,l)=>s+l.distance,0),tt=rLegs.reduce((s,l)=>s+l.duration,0);
    document.getElementById('r-dist').textContent=(td/1609.34).toFixed(0)+' mi';
    document.getElementById('r-time').textContent=fmtDur(tt);
    document.getElementById('r-totals').style.display='flex';
  }catch(e){console.error(e)}
}

function togNever(){nvMode=!nvMode;document.getElementById('btn-nv').classList.toggle('an',nvMode);if(nvMode){rtMode=false;document.getElementById('btn-rt').classList.remove('ar');document.getElementById('r-banner').classList.remove('on');document.getElementById('rp').classList.remove('vis')}applyFilters()}
function togRadius(){rdMode=!rdMode;document.getElementById('btn-rd').classList.toggle('ax',rdMode);document.getElementById('rc').classList.toggle('vis',rdMode);if(rdMode){rtMode=false;document.getElementById('btn-rt').classList.remove('ar');document.getElementById('r-banner').classList.remove('on');document.getElementById('rp').classList.remove('vis')}else{if(rCircle){map.removeLayer(rCircle);rCircle=null}}}
function updRL(){document.getElementById('r-val').textContent=document.getElementById('r-slider').value+'mi';if(rCircle)rCircle.setRadius(+document.getElementById('r-slider').value*1609.34)}
function showRad(i){const mi=+document.getElementById('r-slider').value;if(rCircle)map.removeLayer(rCircle);rCircle=L.circle([i.lat,i.lng],{radius:mi*1609.34,color:'#6c5ce7',fillColor:'#6c5ce7',fillOpacity:.08,weight:2,dashArray:'6,4'}).addTo(map);map.fitBounds(rCircle.getBounds())}
function togHolds(){hdMode=!hdMode;document.getElementById('btn-hd').classList.toggle('ah',hdMode);document.getElementById('hp').classList.toggle('vis',hdMode);if(hdMode)updHP();applyFilters()}
function updHP(){
  const s=document.getElementById('h-sum');
  if(!aArts.size){s.innerHTML='Select artist chips to see stats';return}
  let h='';
  for(const a of aArts){
    const idx=AK.indexOf(a);if(idx===-1)continue;
    const tab=H_TABS[idx];if(!tab||!hData[tab])continue;
    const entries=Object.values(hData[tab]);
    let c={asked:0,'1h':0,'23h':0,'4h':0,confirmed:0,na:0,avail:0};
    entries.forEach(e=>{if(e.best)c[e.best.s]=(c[e.best.s]||0)+1});
    h+='<div><strong style="color:var(--accent)">'+tab+'</strong>: <span style="color:#28a745">'+c.confirmed+'conf</span> ¬∑ <span style="color:#5cb85c">'+c['1h']+'√ó1st</span> ¬∑ <span style="color:#f0c040">'+c['23h']+'√ó2-3</span> ¬∑ <span style="color:#e08030">'+c['4h']+'√ó4+</span> ¬∑ <span style="color:#999">'+c.asked+'ask</span> ¬∑ <span style="color:#d9534f">'+c.na+'NA</span></div>';
  }
  s.innerHTML=h||'No holds data';
}

// ‚îÄ‚îÄ GEOCODE ‚îÄ‚îÄ
async function geocodeMissing(){
  const miss=all.filter(i=>!i.lat&&(i.vLoc||i.city));if(!miss.length)return;
  const gp=document.getElementById('gp'),gt=document.getElementById('g-text'),gf=document.getElementById('g-fill');
  gp.classList.add('on');let done=0;
  for(const i of miss){
    const q=i.vLoc||i.city+', '+i.state;
    try{
      const r=await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(q)+'&limit=1',{headers:{'User-Agent':'LRA-Map/4'}});
      const d=await r.json();
      if(d.length){i.lat=+d[0].lat;i.lng=+d[0].lon;
        if(WE){
          const tid=i.type==='venue'?VT:i.type==='festival'?FT:ST;
          const lngField=i.type==='venue'?'Longitude ':'Longitude';
          fetch('https://api.airtable.com/v0/'+B+'/'+tid+'/'+i.id,{method:'PATCH',headers:{Authorization:'Bearer '+TK,'Content-Type':'application/json'},body:JSON.stringify({fields:{'Latitude':+d[0].lat,[lngField]:+d[0].lon}})}).catch(()=>{});
        }
      }
    }catch(e){}
    done++;gt.textContent='Geocoding '+done+'/'+miss.length;gf.style.width=((done/miss.length)*100)+'%';
    if(done%15===0){applyFilters();saveCache(all)}
    await new Promise(r=>setTimeout(r,1100));
  }
  gp.classList.remove('on');applyFilters();saveCache(all);
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportCSV(){
  const items=filt.filter(i=>i.lat&&i.lng);
  let csv='Type,Name,City,State,Region,Capacity,Lat,Lng,Promoter,Email,Website\n';
  items.forEach(i=>{csv+=[i.type,Q(i.name),Q(i.city),Q(i.state),Q(i.region||''),i.cap||'',i.lat||'',i.lng||'',Q(i.promoter||''),Q(i.pEmail||''),Q(i.website||'')].join(',')+'\n'});
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download='lra-map-export.csv';a.click();
}
function Q(s){return'"'+String(s).replace(/"/g,'""')+'"'}

function E(s){if(!s)return'';const d=document.createElement('div');d.textContent=String(s);return d.innerHTML}
function fmtD(d){if(!d)return'';try{return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}catch(e){return String(d)}}
function fmtDur(s){const h=Math.floor(s/3600),m=Math.floor((s%3600)/60);return h?h+'h '+m+'m':m+'m'}
function cj(s){if(!s)return'';try{const a=JSON.parse(s);if(Array.isArray(a))return a.join(', ')}catch(e){}return s.replace(/[\[\]"]/g,'')}
</script>
</body>
</html>
